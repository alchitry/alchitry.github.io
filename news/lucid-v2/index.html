<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Lucid V2</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;news&#x2F;lucid-v2&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
</script>
<script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
</script>

<link rel="stylesheet" href="https://alchitry.com/styles.css">
<link rel="stylesheet" href="https://alchitry.com/override.css">

<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;news&#x2F;">News</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;news&#x2F;lucid-v2&#x2F;">Lucid V2</a>
            </div>
            
        </div>
        <h1 class="post-title">Lucid V2</h1>
        
        
        <div class="post-meta">
            
















<span>2023-05-18</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/news&#x2F;lucid-v2.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#breaking-changes" aria-label="Breaking Changes">Breaking Changes</a>
                    
                </li>
                
                <li>
                    <a href="#new-additions" aria-label="New Additions">New Additions</a>
                    
                </li>
                
                <li>
                    <a href="#simulation" aria-label="Simulation">Simulation</a>
                    
                </li>
                
                <li>
                    <a href="#source-and-discussion" aria-label="Source and Discussion">Source and Discussion</a>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p>A full rewrite of the Lucid parser in Alchitry Labs has been a long time coming.</p>
<span id="continue-reading"></span>
<p>The current parser has had feature after feature crudely bolted on to a shaky foundation. It was originally only written
to convert Lucid into Verilog. Later, error checking for signal widths was added. Then full parsing on constant values
was added. Then parsing of non-constant values was kind of added. Then... then... then...</p>
<p>A lot of the code is confusing and many sections are redundant. On top of that, null checks weren't my specialty and
I often forgot to check when something could've been null resulting in a crash when bad syntax was entered.</p>
<p>The new parser is fixing all this while adding many more features. It is written in Kotlin which largely fixes null 
checks by having null safe types built into the language.</p>
<h2 id="breaking-changes">Breaking Changes<a class="anchor" aria-hidden="true" href="#breaking-changes" hidden="">#</a>
</h2>
<p>I'm also taking this opportunity to re-imagine some aspects of Lucid. Because of this, Lucid 2 will break compatibility
with the original Lucid.</p>
<p>For example, currently you can use the <code class ="language-lucid" data-lang="lucid"><span>.</span><span style="color:#d45ada;">WIDTH</span></code> property of signals in Lucid to access their dimensions (number of bits).
In Lucid 2, this is getting replaced by the <code class ="language-lucid" data-lang="lucid"><span style="color:#1bddaf;">$widthOf</span><span style="color:#ed4343;">()</span></code> function. This will allow you to not only get the widths of 
signals but also expressions. It also helps clean up the internal code when resolving signals.</p>
<p>The <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">fsm</span></code> type is being removed and being replaced with <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">enum</span></code>. The <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">fsm</span></code> type was kind of a strange type in that it 
really was just a <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span></code> with an associated set of constants. The new method is to use <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">enum</span></code> to declare a set of 
constants and use a <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span></code> to hold them. Here's an example.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">enum</span><span> myFSM </span><span style="color:#ed4343;">{ </span><span style="color:#d45ada;">INIT</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">START</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">RUN</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">STOP </span><span style="color:#ed4343;">}
</span><span style="color:#0a8dbf;">dff</span><span> myDff</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$widthOf</span><span style="color:#ed4343;">(</span><span>myFSM</span><span style="color:#ed4343;">)]
</span><span>
</span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>    myDff.d </span><span style="color:#ed4343;">=</span><span> myFSM.</span><span style="color:#d45ada;">START
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>This simplifies things by making <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span></code> the only sequential type.</p>
<p>The eagle eyed among you may have noticed that there aren't any semicolons in the above code snippet. Semicolons are
optional in Lucid 2. </p>
<p>The <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">var</span></code> type is also being removed. The only real use for the <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">var</span></code> type was in <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">for</span></code> loops which you could still use
a <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">sig</span></code> type for. It wasn't particularly intuitive as it had the size of a computer <code class ="language-lucid" data-lang="lucid"><span style="color:#da5a8c;">Int</span></code> when everything else a single
bit.</p>
<p>Speaking of <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">for</span></code> loops, these are replaced with <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">repeat</span></code> blocks. These have the syntax <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>count</span><span style="color:#ed4343;">, </span><span style="color:#0a8dbf;">var</span><span style="color:#ed4343;">) {</span><span> ... </span><span style="color:#ed4343;">}</span></code> 
where <code class ="language-lucid" data-lang="lucid"><span>count</span></code> is the number of times to repeat the block and <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">var</span></code> is the name to use for the current iteration index.
This signal is automatically generated for you and you don't need to declare it somewhere else. It is only visible 
inside the repeat block.</p>
<p>There are a handful of other minor changes. When declaring a <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span></code> or <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">sig</span></code>, you can now only declare one per line.
Declaring multiple off the same keyword was rarely used and often made the code harder to read. Removing this also
made the backend code cleaner.</p>
<p>The struct portion of a declaration was moved after the array indices. An old <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span></code> declaration with that
used a struct used to look like this <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span><span style="color:#ed4343;">&lt;</span><span>myStruct</span><span style="color:#ed4343;">&gt;</span><span> myDff</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">] (</span><span>.clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">));</span></code>. It now looks like this 
<code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span><span> myDff</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]&lt;</span><span>myStruct</span><span style="color:#ed4343;">&gt; (</span><span>.clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">))</span></code>. The original style was based on generics in languages like Java, but the new style
fits better with how you actually index the values. It makes it much clearer that <code class ="language-lucid" data-lang="lucid"><span>myDff</span></code> is an array of structs.</p>
<h2 id="new-additions">New Additions<a class="anchor" aria-hidden="true" href="#new-additions" hidden="">#</a>
</h2>
<p>There will be some new functions to help when working with fixed point numbers. I haven't nailed all these down yet but
something along the lines of <code class ="language-lucid" data-lang="lucid"><span style="color:#1bddaf;">$fixedPoint</span><span style="color:#ed4343;">(</span><span style="color:#b262cb;">3.14159</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">)</span></code> will generate an 8-bit wide number with 4 bits used for the
decimal (aka <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">8b00110010</span></code>) that is the closest approximation to the 3.14159. There will also be ceiling and floor 
versions that generate the closet value above or below the given value respectively.</p>
<p>I'm also planning to implement interfaces. These will basically be like <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">struct</span></code> but each member will have a direction
associated with it. I found myself often creating two <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">struct</span></code> where one would be for inputs and one would be for 
outputs. For example, the <code class ="language-lucid" data-lang="lucid"><span>memory.in</span></code> and <code class ="language-lucid" data-lang="lucid"><span>memory.out</span></code> structs used by the 
<a href="https://alchitry.com/tutorials/archive/lucid_v1/ddr3-memory/">DDR interface</a>.</p>
<p>Interfaces will allow combining these into a single port. There will be &quot;a&quot; and &quot;b&quot; versions of each interface where
the &quot;b&quot; version is a mirrored copy of &quot;a&quot; (inputs are outputs, outputs are inputs). That way a module with an &quot;a&quot; port 
can directly connect to a module with a &quot;b&quot; port.</p>
<h2 id="simulation">Simulation<a class="anchor" aria-hidden="true" href="#simulation" hidden="">#</a>
</h2>
<p>A big motivator for the rewrite was the potential to do full Lucid simulations. The old code would parse constant 
expressions, but it only hinted at the possibility to do a full simulation by iterating the parsing.</p>
<p>The new code builds a full model of your project complete with signal connections, models for always blocks, and other
dynamic expressions. This not only helps with more robust error checking (it's hard to miss something when you're 
required to actually model it all) but will allow for quick simple simulations to check if your logic is working how
you expect.</p>
<p>Much of this is already working. The details are more than the scope of this post, but check out the link to the source
below for details on how it works.</p>
<p>As part of doing simulations, a new <code class ="language-lucid" data-lang="lucid"><span>testBench</span></code> will be created. I haven't nailed down the specifics for this either
just quiet yet but the current idea is for a <code class ="language-lucid" data-lang="lucid"><span>testBench</span></code> to look similar to a <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span></code>. Inside the <code class ="language-lucid" data-lang="lucid"><span>testBench</span></code>, you
will be able to instantiate your module to test. You can then test it via <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">test</span></code> and <code class ="language-lucid" data-lang="lucid"><span>function</span></code> blocks.</p>
<p>The <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">test</span></code> blocks will work similar to an <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">always</span></code> block in that the contents will run sequentially.</p>
<p>The <code class ="language-lucid" data-lang="lucid"><span>function</span></code> blocks will be the same except they won't run on their own and can instead be called by <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">test</span></code> blocks.
I'm imagining these being used for common tasks like cycling a clock. For example, something like 
<code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">100</span><span style="color:#ed4343;">) {</span><span> cycleClock</span><span style="color:#ed4343;">() }</span></code>. The syntax for this is very much still up in the air.</p>
<h2 id="source-and-discussion">Source and Discussion<a class="anchor" aria-hidden="true" href="#source-and-discussion" hidden="">#</a>
</h2>
<p>Head over to our <a href="https://github.com/alchitry/LucidParserV2">GitHub</a> page to check out the current state of things.</p>
<p>There is also a <a href="https://github.com/alchitry/LucidParserV2/discussions">discussion page</a> setup as part of the repo
where you can let me know your thoughts.</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        
        <a class="next" href="https:&#x2F;&#x2F;alchitry.com&#x2F;news&#x2F;lucid-v2-update-1&#x2F;">
            <span class="title">Next »</span>
            <br>
            <span>Lucid V2 - Update 1</span>
        </a>
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2026 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"><path d="M440-320h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168Zm40 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            let codeText = '';

            // 1. Check if the codeblock contains a table (Line Numbers present)
            const tableRows = codeblock.querySelectorAll('table tr');

            if (tableRows.length > 0) {
                const lines = [];
                tableRows.forEach(row => {
                    // The actual code is in the last TD
                    const codeCell = row.lastElementChild;
                    if (codeCell) {
                        let cellText = codeCell.textContent;

                        if (cellText.endsWith('\n')) {
                            cellText = cellText.slice(0, -1);
                        }

                        lines.push(cellText);
                    }
                });
                codeText = lines.join('\n');
            } else {
                // 2. No table, use standard text extraction
                codeText = codeblock.textContent;
            }

            // 3. Copy the cleaned text to clipboard
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeText);
                copyingDone();
                return;
            }

            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
                console.error('Copy failed', e);
            }
            document.body.removeChild(textArea);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
<script type="module" src="https://alchitry.com/table-toggles.js"></script>
    
</body>
</html>
