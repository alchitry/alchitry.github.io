<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Register Interface</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;intermediate&#x2F;register-interface&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
</script>
<script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
</script>

<link rel="stylesheet" href="https://alchitry.com/styles.css">
<link rel="stylesheet" href="https://alchitry.com/override.css">

<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;">Tutorials</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;intermediate&#x2F;">Intermediate Tutorials</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;intermediate&#x2F;register-interface&#x2F;">Register Interface</a>
            </div>
            
        </div>
        <h1 class="post-title">Register Interface</h1>
        
        
        <div class="post-meta">
            
















<span>2025-04-28</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/tutorials&#x2F;intermediate&#x2F;register-interface.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a>
                    
                </li>
                
                <li>
                    <a href="#the-register-interface-component" aria-label="The Register Interface Component">The Register Interface Component</a>
                    
                </li>
                
                <li>
                    <a href="#controlling-the-leds" aria-label="Controlling the LEDs">Controlling the LEDs</a>
                    
                </li>
                
                <li>
                    <a href="#the-api" aria-label="The API">The API</a>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p>This tutorial will introduce you to the <em>Register Interface</em> component and how you can use it to easily implement
complex interfaces in your designs.</p>
<span id="continue-reading"></span><h1 id="introduction">Introduction</h1>
<p>Sometimes dealing with an interface, like the <a href="https://alchitry.com/tutorials/starter/serial-interface/">serial interface</a>, directly can become
quite complicated depending on what you are trying to implement.
The <em>Register Interface</em> component provides an abstraction on top of a basic interface (usually the USB&lt;-&gt;Serial port,
but it doesn't have to be).</p>
<p>The abstraction it provides is a <em>register</em> based one.
The FPGA acts as a peripheral and responds to read and write requests targeted at specific addresses.</p>
<p>You've likely seen a register interface many times if you've worked with anything over I2C or SPI.
Datasheets will list the registers you can read and write and what the bits in each one does.</p>
<p>In the most basic case, the thing you are reading and writing is actually a register.
However, it doesn't <em>have</em> to be.
Instead, you can respond to the reads/writes however you see fit.</p>
<p>For example, you might choose to respond to a read at address 8 with data from a FIFO.
Each time address 8 is read, you remove a value from the FIFO and return it.
This is a common case when you are implementing something that collects data and needs to stream it out to the host.</p>
<p>Enough theoretical, let's jump into the actual interface.</p>
<h1 id="the-register-interface-component">The Register Interface Component</h1>
<p>In Alchitry Labs, open a New Project using the base template and name it whatever you want.
I'm calling mine <em>Register Interface Demo</em>. 
Now, open the <em>Component Library</em> and add the <em>Register Interface</em> (under <em>Interfaces</em>) to your project.
You will also likely want to add the <em>UART Rx</em> and <em>UART Tx</em> components if you plan to use the interface with the 
built-in USB port.</p>
<p>Here's the full module.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><table><tbody><tr><td>34</td><td><span style="font-weight:bold;color:#faac1f;">global </span><span style="color:#da5a8c;">Register </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>35</td><td><span>    </span><span style="color:#0a8dbf;">struct</span><span> request </span><span style="color:#ed4343;">{                                </span><span style="color:#969696;">// request device outputs
</span></td></tr><tr><td>36</td><td><span>        new_cmd</span><span style="color:#ed4343;">,                                    </span><span style="color:#969696;">// 1 = new command
</span></td></tr><tr><td>37</td><td><span>        write</span><span style="color:#ed4343;">,                                      </span><span style="color:#969696;">// 1 = write, 0 = read
</span></td></tr><tr><td>38</td><td><span>        address</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],                                </span><span style="color:#969696;">// address to read/write
</span></td></tr><tr><td>39</td><td><span>        data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]                                    </span><span style="color:#969696;">// data to write (ignore on reads)
</span></td></tr><tr><td>40</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>41</td><td><span>    </span><span style="color:#0a8dbf;">struct</span><span> response </span><span style="color:#ed4343;">{                               </span><span style="color:#969696;">// response inputs
</span></td></tr><tr><td>42</td><td><span>        data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],                                   </span><span style="color:#969696;">// data read from requested address
</span></td></tr><tr><td>43</td><td><span>        drdy                                        </span><span style="color:#969696;">// read data valid (1 = valid)
</span></td></tr><tr><td>44</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>45</td><td><span style="color:#ed4343;">}
</span></td></tr><tr><td>46</td><td><span>
</span></td></tr><tr><td>47</td><td><span style="font-weight:bold;color:#faac1f;">module</span><span> register_interface </span><span style="color:#ed4343;">#(
</span></td></tr><tr><td>48</td><td><span>    </span><span style="color:#d45ada;">CLK_FREQ </span><span style="color:#ed4343;">~ </span><span style="color:#a269dc;">100000000 </span><span style="color:#ed4343;">: </span><span style="color:#d45ada;">CLK_FREQ </span><span style="color:#ed4343;">&gt; </span><span style="color:#a269dc;">0
</span></td></tr><tr><td>49</td><td><span style="color:#ed4343;">)(
</span></td></tr><tr><td>50</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,                                     </span><span style="color:#969696;">// clock
</span></td></tr><tr><td>51</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,                                     </span><span style="color:#969696;">// reset
</span></td></tr><tr><td>52</td><td><span>
</span></td></tr><tr><td>53</td><td><span>    </span><span style="color:#969696;">// Serial RX Interface
</span></td></tr><tr><td>54</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> rx_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">],                              </span><span style="color:#969696;">// data received
</span></td></tr><tr><td>55</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> new_rx_data</span><span style="color:#ed4343;">,                             </span><span style="color:#969696;">// new data flag (1 = new data)
</span></td></tr><tr><td>56</td><td><span>
</span></td></tr><tr><td>57</td><td><span>    </span><span style="color:#969696;">// Serial Tx Interface
</span></td></tr><tr><td>58</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> tx_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">],                             </span><span style="color:#969696;">// data to send
</span></td></tr><tr><td>59</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> new_tx_data</span><span style="color:#ed4343;">,                            </span><span style="color:#969696;">// new data flag (1 = new data)
</span></td></tr><tr><td>60</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> tx_busy</span><span style="color:#ed4343;">,                                 </span><span style="color:#969696;">// transmitter is busy flag (1 = busy)
</span></td></tr><tr><td>61</td><td><span>
</span></td></tr><tr><td>62</td><td><span>    </span><span style="color:#969696;">// Register Interface
</span></td></tr><tr><td>63</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> reg_out</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Register</span><span>.request</span><span style="color:#ed4343;">&gt;,              </span><span style="color:#969696;">// register outputs
</span></td></tr><tr><td>64</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> reg_in</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Register</span><span>.response</span><span style="color:#ed4343;">&gt;                </span><span style="color:#969696;">// register inputs
</span></td></tr><tr><td>65</td><td><span style="color:#ed4343;">) {
</span></td></tr><tr><td>66</td><td><span>
</span></td></tr><tr><td>67</td><td><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">States </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">GET_ADDR</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WRITE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">REQUEST_WRITE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">REQUEST_READ</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WAIT_READ</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">READ_RESULT</span><span style="color:#ed4343;">}
</span></td></tr><tr><td>68</td><td><span>
</span></td></tr><tr><td>69</td><td><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>70</td><td><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>71</td><td><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">States</span><span style="color:#ed4343;">)](#</span><span style="color:#d45ada;">INIT</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">))
</span></td></tr><tr><td>72</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>73</td><td><span>
</span></td></tr><tr><td>74</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> addr_ct </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]                              </span><span style="color:#969696;">// address counter
</span></td></tr><tr><td>75</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> byte_ct </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]                              </span><span style="color:#969696;">// byte counter
</span></td></tr><tr><td>76</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> inc                                      </span><span style="color:#969696;">// increment flag
</span></td></tr><tr><td>77</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> wr                                       </span><span style="color:#969696;">// write flag
</span></td></tr><tr><td>78</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> timeout</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$clog2</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">CLK_FREQ </span><span style="color:#ed4343;">/ </span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">)]            </span><span style="color:#969696;">// timeout counter
</span></td></tr><tr><td>79</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> addr </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]                                </span><span style="color:#969696;">// saved address
</span></td></tr><tr><td>80</td><td><span>        </span><span style="color:#0a8dbf;">dff</span><span> data </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]                                </span><span style="color:#969696;">// saved data
</span></td></tr><tr><td>81</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>82</td><td><span>
</span></td></tr><tr><td>83</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>84</td><td><span>        </span><span style="color:#969696;">// defaults
</span></td></tr><tr><td>85</td><td><span>        reg_out.new_cmd </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                          </span><span style="color:#969696;">// no new command
</span></td></tr><tr><td>86</td><td><span>        reg_out.write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx                           </span><span style="color:#969696;">// don&#39;t care
</span></td></tr><tr><td>87</td><td><span>        reg_out.address </span><span style="color:#ed4343;">=</span><span> addr.q                     </span><span style="color:#969696;">// output addr
</span></td></tr><tr><td>88</td><td><span>        reg_out.data </span><span style="color:#ed4343;">=</span><span> data.q                        </span><span style="color:#969696;">// output data
</span></td></tr><tr><td>89</td><td><span>        tx_data </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx                                 </span><span style="color:#969696;">// don&#39;t care
</span></td></tr><tr><td>90</td><td><span>        new_tx_data </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                              </span><span style="color:#969696;">// no new data
</span></td></tr><tr><td>91</td><td><span>
</span></td></tr><tr><td>92</td><td><span>        timeout.d </span><span style="color:#ed4343;">=</span><span> timeout.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1                    </span><span style="color:#969696;">// increment timeout counter
</span></td></tr><tr><td>93</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>new_rx_data</span><span style="color:#ed4343;">)                             </span><span style="color:#969696;">// if new serial data
</span></td></tr><tr><td>94</td><td><span>            timeout.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                            </span><span style="color:#969696;">// reset counter
</span></td></tr><tr><td>95</td><td><span>
</span></td></tr><tr><td>96</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>97</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>98</td><td><span>                timeout.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                        </span><span style="color:#969696;">// reset timeout
</span></td></tr><tr><td>99</td><td><span>                byte_ct.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                        </span><span style="color:#969696;">// reset byte count
</span></td></tr><tr><td>100</td><td><span>
</span></td></tr><tr><td>101</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>new_rx_data</span><span style="color:#ed4343;">) {                   </span><span style="color:#969696;">// if new data
</span></td></tr><tr><td>102</td><td><span>                    wr.d </span><span style="color:#ed4343;">=</span><span> rx_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">]                </span><span style="color:#969696;">// bit 7 is write flag
</span></td></tr><tr><td>103</td><td><span>                    inc.d </span><span style="color:#ed4343;">=</span><span> rx_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]               </span><span style="color:#969696;">// bit 6 is auto increment flag
</span></td></tr><tr><td>104</td><td><span>                    addr_ct.d </span><span style="color:#ed4343;">=</span><span> rx_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]         </span><span style="color:#969696;">// 7 LSBs are number of addresses to read/write (+1)
</span></td></tr><tr><td>105</td><td><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">GET_ADDR        </span><span style="color:#969696;">// read in address bytes
</span></td></tr><tr><td>106</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>107</td><td><span>
</span></td></tr><tr><td>108</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">GET_ADDR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>109</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>new_rx_data</span><span style="color:#ed4343;">) {                        </span><span style="color:#969696;">// if new data
</span></td></tr><tr><td>110</td><td><span>                    addr.d </span><span style="color:#ed4343;">= c{</span><span>rx_data</span><span style="color:#ed4343;">,</span><span> addr.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">-:</span><span style="color:#a269dc;">24</span><span style="color:#ed4343;">]}   </span><span style="color:#969696;">// shift in byte
</span></td></tr><tr><td>111</td><td><span>                    byte_ct.d </span><span style="color:#ed4343;">=</span><span> byte_ct.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1             </span><span style="color:#969696;">// increment byte count
</span></td></tr><tr><td>112</td><td><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>byte_ct.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {                 </span><span style="color:#969696;">// if received all 4 bytes
</span></td></tr><tr><td>113</td><td><span>                        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>wr.q</span><span style="color:#ed4343;">)                         </span><span style="color:#969696;">// if write
</span></td></tr><tr><td>114</td><td><span>                            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">WRITE        </span><span style="color:#969696;">// switch to WRITE
</span></td></tr><tr><td>115</td><td><span>                        </span><span style="font-weight:bold;color:#0abfbf;">else                              </span><span style="color:#969696;">// else
</span></td></tr><tr><td>116</td><td><span>                            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">REQUEST_READ </span><span style="color:#969696;">// switch to REQUEST_READ
</span></td></tr><tr><td>117</td><td><span>                    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>118</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>119</td><td><span>
</span></td></tr><tr><td>120</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">WRITE</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>121</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>new_rx_data</span><span style="color:#ed4343;">) {                        </span><span style="color:#969696;">// if new data
</span></td></tr><tr><td>122</td><td><span>                    data.d </span><span style="color:#ed4343;">= c{</span><span>rx_data</span><span style="color:#ed4343;">,</span><span> data.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">-:</span><span style="color:#a269dc;">24</span><span style="color:#ed4343;">]}   </span><span style="color:#969696;">// shift in data
</span></td></tr><tr><td>123</td><td><span>                    byte_ct.d </span><span style="color:#ed4343;">=</span><span> byte_ct.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1             </span><span style="color:#969696;">// increment byte count
</span></td></tr><tr><td>124</td><td><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>byte_ct.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">)                   </span><span style="color:#969696;">// if received all 4 bytes
</span></td></tr><tr><td>125</td><td><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">REQUEST_WRITE    </span><span style="color:#969696;">// request the write
</span></td></tr><tr><td>126</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>127</td><td><span>
</span></td></tr><tr><td>128</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">REQUEST_WRITE</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>129</td><td><span>                reg_out.new_cmd </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1                       </span><span style="color:#969696;">// new command!
</span></td></tr><tr><td>130</td><td><span>                reg_out.write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1                         </span><span style="color:#969696;">// it&#39;s a write
</span></td></tr><tr><td>131</td><td><span>                addr_ct.d </span><span style="color:#ed4343;">=</span><span> addr_ct.q </span><span style="color:#ed4343;">- </span><span style="color:#a269dc;">1                 </span><span style="color:#969696;">// decrement address count
</span></td></tr><tr><td>132</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>addr_ct.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">) {                     </span><span style="color:#969696;">// if no more commands to issue
</span></td></tr><tr><td>133</td><td><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">IDLE                 </span><span style="color:#969696;">// return to idle
</span></td></tr><tr><td>134</td><td><span>                </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{                                  </span><span style="color:#969696;">// else
</span></td></tr><tr><td>135</td><td><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">WRITE                </span><span style="color:#969696;">// read in other data to write
</span></td></tr><tr><td>136</td><td><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>inc.q</span><span style="color:#ed4343;">)                            </span><span style="color:#969696;">// if auto-increment
</span></td></tr><tr><td>137</td><td><span>                        addr.d </span><span style="color:#ed4343;">=</span><span> addr.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1               </span><span style="color:#969696;">// increment the address
</span></td></tr><tr><td>138</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>139</td><td><span>
</span></td></tr><tr><td>140</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">REQUEST_READ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>141</td><td><span>                reg_out.new_cmd </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1                       </span><span style="color:#969696;">// new command!
</span></td></tr><tr><td>142</td><td><span>                reg_out.write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                         </span><span style="color:#969696;">// it&#39;s a read
</span></td></tr><tr><td>143</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg_in.drdy</span><span style="color:#ed4343;">) {                        </span><span style="color:#969696;">// if result valid
</span></td></tr><tr><td>144</td><td><span>                    data.d </span><span style="color:#ed4343;">=</span><span> reg_in.data                  </span><span style="color:#969696;">// save the value
</span></td></tr><tr><td>145</td><td><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">READ_RESULT          </span><span style="color:#969696;">// send it out
</span></td></tr><tr><td>146</td><td><span>                </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>147</td><td><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">WAIT_READ            </span><span style="color:#969696;">// wait for the result
</span></td></tr><tr><td>148</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>149</td><td><span>
</span></td></tr><tr><td>150</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">WAIT_READ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>151</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg_in.drdy</span><span style="color:#ed4343;">) {                        </span><span style="color:#969696;">// if result valid
</span></td></tr><tr><td>152</td><td><span>                    data.d </span><span style="color:#ed4343;">=</span><span> reg_in.data                  </span><span style="color:#969696;">// save the value
</span></td></tr><tr><td>153</td><td><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">READ_RESULT          </span><span style="color:#969696;">// send it out
</span></td></tr><tr><td>154</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>155</td><td><span>
</span></td></tr><tr><td>156</td><td><span>            </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">READ_RESULT</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>157</td><td><span>                timeout.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0                             </span><span style="color:#969696;">// reset the timeout
</span></td></tr><tr><td>158</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>tx_busy</span><span style="color:#ed4343;">) {                           </span><span style="color:#969696;">// if serial not busy
</span></td></tr><tr><td>159</td><td><span>                    tx_data </span><span style="color:#ed4343;">=</span><span> data.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]                 </span><span style="color:#969696;">// write byte of data
</span></td></tr><tr><td>160</td><td><span>                    data.d </span><span style="color:#ed4343;">=</span><span> data.q </span><span style="color:#ed4343;">&gt;&gt; </span><span style="color:#a269dc;">8                  </span><span style="color:#969696;">// shift data
</span></td></tr><tr><td>161</td><td><span>                    new_tx_data </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1                       </span><span style="color:#969696;">// send the byte
</span></td></tr><tr><td>162</td><td><span>                    byte_ct.d </span><span style="color:#ed4343;">=</span><span> byte_ct.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1             </span><span style="color:#969696;">// increase the byte counter
</span></td></tr><tr><td>163</td><td><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>byte_ct.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {                 </span><span style="color:#969696;">// if we sent 4 bytes
</span></td></tr><tr><td>164</td><td><span>                        addr_ct.d </span><span style="color:#ed4343;">=</span><span> addr_ct.q </span><span style="color:#ed4343;">- </span><span style="color:#a269dc;">1         </span><span style="color:#969696;">// decrement the number of reads to perform
</span></td></tr><tr><td>165</td><td><span>                        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>addr_ct.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">) {             </span><span style="color:#969696;">// if no more commands
</span></td></tr><tr><td>166</td><td><span>                            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">IDLE         </span><span style="color:#969696;">// return to IDLE
</span></td></tr><tr><td>167</td><td><span>                        </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{                          </span><span style="color:#969696;">// else
</span></td></tr><tr><td>168</td><td><span>                            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">REQUEST_READ </span><span style="color:#969696;">// request another read
</span></td></tr><tr><td>169</td><td><span>                            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>inc.q</span><span style="color:#ed4343;">)                    </span><span style="color:#969696;">// if auto-increment
</span></td></tr><tr><td>170</td><td><span>                                addr.d </span><span style="color:#ed4343;">=</span><span> addr.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1       </span><span style="color:#969696;">// increment the address
</span></td></tr><tr><td>171</td><td><span>                        </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>172</td><td><span>                    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>173</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>174</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>175</td><td><span>
</span></td></tr><tr><td>176</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(&amp;</span><span>timeout.q</span><span style="color:#ed4343;">)                                   </span><span style="color:#969696;">// if we timed out
</span></td></tr><tr><td>177</td><td><span>            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">States</span><span>.</span><span style="color:#d45ada;">IDLE                         </span><span style="color:#969696;">// reset to IDLE
</span></td></tr><tr><td>178</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>179</td><td><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>I'm not going to dive into too much detail on <em>how</em> it all works but mostly go over what it does and how to use it.
It is essentially just a large FSM (see <a href="https://alchitry.com/tutorials/starter/roms-and-fsms/">the FSM tutorial</a> for background).
Check out <a href="https://alchitry.com/tutorials/intermediate/register-interface/#the-api">The API</a> section for info on the actual protocol.</p>
<p>For now, we will dive into using it.</p>
<h1 id="controlling-the-leds">Controlling the LEDs</h1>
<p>To get your feet wet, we will use the interface to control the LEDs on the board.</p>
<p>First, we need to instantiate the modules in the <code class ="language-lucid" data-lang="lucid"><span>alchitry_top</span></code> module.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>16</td><td><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>17</td><td><span>            </span><span style="color:#0a8dbf;">dff</span><span> led_reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]
</span></td></tr><tr><td>18</td><td><span>            </span><span style="color:#ed4343;">#</span><span style="color:#d45ada;">CLK_FREQ</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">100_000_000</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>19</td><td><span>                register_interface reg
</span></td></tr><tr><td>20</td><td><span>                </span><span style="color:#ed4343;">#</span><span style="color:#d45ada;">BAUD</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1_000_000</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>21</td><td><span>                    uart_rx rx
</span></td></tr><tr><td>22</td><td><span>                    uart_tx tx
</span></td></tr><tr><td>23</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>24</td><td><span>            </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>25</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>Here I used connection blocks for the parameters <code class ="language-lucid" data-lang="lucid"><span style="color:#d45ada;">CLK_FREQ</span></code> and <code class ="language-lucid" data-lang="lucid"><span style="color:#d45ada;">BAUD</span></code> to easily set them for all the modules that need them.
This is optional, but I like to do it this way to guarantee they are all the same.</p>
<p>I also added the <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span><span> led_reg</span></code> that we will use to save the value written to the LEDs.</p>
<p>In the <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">always</span></code> block, we can connect up the modules.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>28</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>29</td><td><span>        reset_cond.in </span><span style="color:#ed4343;">= ~</span><span>rst_n  </span><span style="color:#969696;">// input raw inverted reset signal
</span></td></tr><tr><td>30</td><td><span>        rst </span><span style="color:#ed4343;">=</span><span> reset_cond.out    </span><span style="color:#969696;">// conditioned reset
</span></td></tr><tr><td>31</td><td><span>        
</span></td></tr><tr><td>32</td><td><span>        led </span><span style="color:#ed4343;">=</span><span> led_reg.q
</span></td></tr><tr><td>33</td><td><span>        
</span></td></tr><tr><td>34</td><td><span>        usb_tx </span><span style="color:#ed4343;">=</span><span> tx.tx
</span></td></tr><tr><td>35</td><td><span>        rx.rx </span><span style="color:#ed4343;">=</span><span> usb_rx
</span></td></tr><tr><td>36</td><td><span>        
</span></td></tr><tr><td>37</td><td><span>        reg.rx_data </span><span style="color:#ed4343;">=</span><span> rx.data
</span></td></tr><tr><td>38</td><td><span>        reg.new_rx_data </span><span style="color:#ed4343;">=</span><span> rx.new_data
</span></td></tr><tr><td>39</td><td><span>        tx.data </span><span style="color:#ed4343;">=</span><span> reg.tx_data
</span></td></tr><tr><td>40</td><td><span>        tx.new_data </span><span style="color:#ed4343;">=</span><span> reg.new_tx_data
</span></td></tr><tr><td>41</td><td><span>        reg.tx_busy </span><span style="color:#ed4343;">=</span><span> tx.busy
</span></td></tr><tr><td>42</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>We now need to deal with incoming requests.
This is done through the <code class ="language-lucid" data-lang="lucid"><span>reg_out</span></code> and <code class ="language-lucid" data-lang="lucid"><span>reg_in</span></code> ports of the <code class ="language-lucid" data-lang="lucid"><span>register_interface</span></code> module.
These ports use <a href="https://alchitry.com/tutorials/references/lucid-reference/#struct">structs</a> to bundle a bunch of signals together.</p>
<p>The <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">struct</span></code> for each one is defined in the <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">global</span></code> block in the same file.
These are available anywhere in your design by using the designations <code class ="language-lucid" data-lang="lucid"><span style="color:#da5a8c;">Register</span><span>.request</span></code> and <code class ="language-lucid" data-lang="lucid"><span style="color:#da5a8c;">Register</span><span>.response</span></code>.</p>
<p>We can connect up these signals to respond to read/write requests to address 0 with the value of the LEDs.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>44</td><td><span>        </span><span style="color:#969696;">// default value
</span></td></tr><tr><td>45</td><td><span>        reg.reg_in </span><span style="color:#ed4343;">= &lt;</span><span style="color:#da5a8c;">Register</span><span>.response</span><span style="color:#ed4343;">&gt;(</span><span>.data</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">32bx</span><span style="color:#ed4343;">),</span><span> .drdy</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">))
</span></td></tr><tr><td>46</td><td><span>        
</span></td></tr><tr><td>47</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.new_cmd</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>48</td><td><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.write</span><span style="color:#ed4343;">) { </span><span style="color:#969696;">// write
</span></td></tr><tr><td>49</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.address </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">) { </span><span style="color:#969696;">// address matches
</span></td></tr><tr><td>50</td><td><span>                    led_reg.d </span><span style="color:#ed4343;">=</span><span> reg.reg_out.data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] </span><span style="color:#969696;">// update the value
</span></td></tr><tr><td>51</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>52</td><td><span>            </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{ </span><span style="color:#969696;">// read
</span></td></tr><tr><td>53</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.address </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">) { </span><span style="color:#969696;">// address matches
</span></td></tr><tr><td>54</td><td><span>                    reg.reg_in.drdy </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1 </span><span style="color:#969696;">// data ready
</span></td></tr><tr><td>55</td><td><span>                    reg.reg_in.data </span><span style="color:#ed4343;">=</span><span> led_reg.q </span><span style="color:#969696;">// return the value
</span></td></tr><tr><td>56</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>57</td><td><span>            </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>58</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>Notice on line 45 I used the <a href="https://alchitry.com/tutorials/references/lucid-reference/#structs">struct literal syntax</a> to assign a constant value
to every element in the struct.</p>
<p>You can now build your project and load it onto your board.</p>
<p>In Alchitry Labs, you can now open the <em>Register Interface</em> tool to read/write registers.
Click the <em>Tools</em> icon (looks like a terminal) and select <em>Register Interface</em>.
A new tab will open.</p>
<p><img src="https://cdn.alchitry.com/tutorials/register-interface/register-interface.png" alt="Register Interface" /></p>
<p>Click the chain icon to connect.
Make sure the baud rate matches what you set in your code.
In the above example I used 1M baud which is what Alchitry Labs defaults to.</p>
<p>You can enter a value, like <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">3</span></code>, into the <em>Value</em> box and click <em>Write</em> to write it to address 0.
If you then click <em>Read</em> it'll read it back.</p>
<p><img src="https://cdn.alchitry.com/tutorials/register-interface/register-interface-read-write.png" alt="Read and Write" /></p>
<p>You should see your board's first two LEDs turn on.
Try writing a few other values just to make sure it's working as expected.</p>
<p>Don't forget to disconnect the register interface by clicking the chain icon.
You won't be able to program it while connected.</p>
<p>If you try to read from an address other than 0, you'll get an error along the lines of 
&quot;Read failed: Read 0 but expected 4 bytes!&quot;
This happens because we only set the <code class ="language-lucid" data-lang="lucid"><span>drdy</span></code> flag to <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">1</span></code> when address <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">0</span></code> was read and ignored every other request.
The tool only waits a short time after sending a read request for a result.</p>
<p>To expand the address you respond to, you would typically use a <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">case</span></code> statement instead of the <code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#0abfbf;">if</span></code>.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>47</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.new_cmd</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>48</td><td><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.write</span><span style="color:#ed4343;">) { </span><span style="color:#969696;">// write
</span></td></tr><tr><td>49</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>reg.reg_out.address</span><span style="color:#ed4343;">) { 
</span></td></tr><tr><td>50</td><td><span>                    </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">:</span><span> led_reg.d </span><span style="color:#ed4343;">=</span><span> reg.reg_out.data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] </span><span style="color:#969696;">// update the value
</span></td></tr><tr><td>51</td><td><span>                    </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">: </span><span style="color:#969696;">// do something with address 1
</span></td></tr><tr><td>52</td><td><span>                    </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">: </span><span style="color:#969696;">// do something with address 2
</span></td></tr><tr><td>53</td><td><span>                    </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">: </span><span style="color:#969696;">// do something with address 3
</span></td></tr><tr><td>54</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>55</td><td><span>            </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{ </span><span style="color:#969696;">// read
</span></td></tr><tr><td>56</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>reg.reg_out.address</span><span style="color:#ed4343;">) {  </span><span style="color:#969696;">// address matches
</span></td></tr><tr><td>57</td><td><span>                    </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>58</td><td><span>                        reg.reg_in.drdy </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1 </span><span style="color:#969696;">// data ready
</span></td></tr><tr><td>59</td><td><span>                        reg.reg_in.data </span><span style="color:#ed4343;">=</span><span> led_reg.q </span><span style="color:#969696;">// return the value
</span></td></tr><tr><td>60</td><td><span>                    </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>61</td><td><span>                        </span><span style="color:#969696;">// respond to address 1
</span></td></tr><tr><td>62</td><td><span>                    </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>63</td><td><span>                        </span><span style="color:#969696;">// respond to address 2
</span></td></tr><tr><td>64</td><td><span>                    </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>65</td><td><span>                        </span><span style="color:#969696;">// respond to address 3
</span></td></tr><tr><td>66</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>67</td><td><span>            </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>68</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>Each address targets a 32bit value.
In the LED example, we are throwing away the top 24 bits, but you could use them for something else.</p>
<p>Here's the full <code class ="language-lucid" data-lang="lucid"><span>alchitry_top</span></code> module.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><table><tbody><tr><td>1</td><td><span style="font-weight:bold;color:#faac1f;">module</span><span> alchitry_top </span><span style="color:#ed4343;">(
</span></td></tr><tr><td>2</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,              </span><span style="color:#969696;">// 100MHz clock
</span></td></tr><tr><td>3</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> rst_n</span><span style="color:#ed4343;">,            </span><span style="color:#969696;">// reset button (active low)
</span></td></tr><tr><td>4</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> led</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">],          </span><span style="color:#969696;">// 8 user controllable LEDs
</span></td></tr><tr><td>5</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> usb_rx</span><span style="color:#ed4343;">,           </span><span style="color:#969696;">// USB-&gt;Serial input
</span></td></tr><tr><td>6</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> usb_tx           </span><span style="color:#969696;">// USB-&gt;Serial output
</span></td></tr><tr><td>7</td><td><span style="color:#ed4343;">) {
</span></td></tr><tr><td>8</td><td><span>    
</span></td></tr><tr><td>9</td><td><span>    </span><span style="color:#0a8dbf;">sig</span><span> rst                 </span><span style="color:#969696;">// reset signal
</span></td></tr><tr><td>10</td><td><span>    
</span></td></tr><tr><td>11</td><td><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>12</td><td><span>        </span><span style="color:#969696;">// The reset conditioner is used to synchronize the reset signal to the FPGA
</span></td></tr><tr><td>13</td><td><span>        </span><span style="color:#969696;">// clock. This ensures the entire FPGA comes out of reset at the same time.
</span></td></tr><tr><td>14</td><td><span>        reset_conditioner reset_cond
</span></td></tr><tr><td>15</td><td><span>        
</span></td></tr><tr><td>16</td><td><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>17</td><td><span>            </span><span style="color:#0a8dbf;">dff</span><span> led_reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]
</span></td></tr><tr><td>18</td><td><span>            </span><span style="color:#ed4343;">#</span><span style="color:#d45ada;">CLK_FREQ</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">100_000_000</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>19</td><td><span>                register_interface reg
</span></td></tr><tr><td>20</td><td><span>                </span><span style="color:#ed4343;">#</span><span style="color:#d45ada;">BAUD</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1_000_000</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>21</td><td><span>                    uart_rx rx
</span></td></tr><tr><td>22</td><td><span>                    uart_tx tx
</span></td></tr><tr><td>23</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>24</td><td><span>            </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>25</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>26</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>27</td><td><span>    
</span></td></tr><tr><td>28</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>29</td><td><span>        reset_cond.in </span><span style="color:#ed4343;">= ~</span><span>rst_n  </span><span style="color:#969696;">// input raw inverted reset signal
</span></td></tr><tr><td>30</td><td><span>        rst </span><span style="color:#ed4343;">=</span><span> reset_cond.out    </span><span style="color:#969696;">// conditioned reset
</span></td></tr><tr><td>31</td><td><span>        
</span></td></tr><tr><td>32</td><td><span>        led </span><span style="color:#ed4343;">=</span><span> led_reg.q
</span></td></tr><tr><td>33</td><td><span>        
</span></td></tr><tr><td>34</td><td><span>        usb_tx </span><span style="color:#ed4343;">=</span><span> tx.tx
</span></td></tr><tr><td>35</td><td><span>        rx.rx </span><span style="color:#ed4343;">=</span><span> usb_rx
</span></td></tr><tr><td>36</td><td><span>        
</span></td></tr><tr><td>37</td><td><span>        reg.rx_data </span><span style="color:#ed4343;">=</span><span> rx.data
</span></td></tr><tr><td>38</td><td><span>        reg.new_rx_data </span><span style="color:#ed4343;">=</span><span> rx.new_data
</span></td></tr><tr><td>39</td><td><span>        tx.data </span><span style="color:#ed4343;">=</span><span> reg.tx_data
</span></td></tr><tr><td>40</td><td><span>        tx.new_data </span><span style="color:#ed4343;">=</span><span> reg.new_tx_data
</span></td></tr><tr><td>41</td><td><span>        reg.tx_busy </span><span style="color:#ed4343;">=</span><span> tx.busy
</span></td></tr><tr><td>42</td><td><span>        
</span></td></tr><tr><td>43</td><td><span>        </span><span style="color:#969696;">// default value
</span></td></tr><tr><td>44</td><td><span>        reg.reg_in </span><span style="color:#ed4343;">= &lt;</span><span style="color:#da5a8c;">Register</span><span>.response</span><span style="color:#ed4343;">&gt;(</span><span>.data</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">32bx</span><span style="color:#ed4343;">),</span><span> .drdy</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">))
</span></td></tr><tr><td>45</td><td><span>        
</span></td></tr><tr><td>46</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.new_cmd</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>47</td><td><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.reg_out.write</span><span style="color:#ed4343;">) { </span><span style="color:#969696;">// write
</span></td></tr><tr><td>48</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>reg.reg_out.address</span><span style="color:#ed4343;">) { 
</span></td></tr><tr><td>49</td><td><span>                    </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">:</span><span> led_reg.d </span><span style="color:#ed4343;">=</span><span> reg.reg_out.data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] </span><span style="color:#969696;">// update the value
</span></td></tr><tr><td>50</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>51</td><td><span>            </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{ </span><span style="color:#969696;">// read
</span></td></tr><tr><td>52</td><td><span>                </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>reg.reg_out.address</span><span style="color:#ed4343;">) {  </span><span style="color:#969696;">// address matches
</span></td></tr><tr><td>53</td><td><span>                    </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>54</td><td><span>                        reg.reg_in.drdy </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1 </span><span style="color:#969696;">// data ready
</span></td></tr><tr><td>55</td><td><span>                        reg.reg_in.data </span><span style="color:#ed4343;">=</span><span> led_reg.q </span><span style="color:#969696;">// return the value
</span></td></tr><tr><td>56</td><td><span>                </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>57</td><td><span>            </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>58</td><td><span>        </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>59</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>60</td><td><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<h1 id="the-api">The API</h1>
<p>This built in register interface tool is helpful, but manually entering everything isn't always practical. 
Here we will go over how the protocol works for issuing read and write requests so that you can use this in your own 
applications.</p>
<p>Every request starts with 5 bytes being sent. 
The first byte is the command byte and the next four are the address (32 bits = 4 bytes) sent with the least significant 
byte first.</p>
<p>In many cases you will want to read or write to many consecutive addresses, or perhaps the same address many times. 
It would be inefficient to have to issue the entire command each time so the command byte contains info for consecutive 
or multiple read/write requests in one.</p>
<p>The MSB (bit 7) of the command byte specifies if the command is a read (0) or write (1). 
The next bit (bit 6), specifies if consecutive addresses should be read/written (1) or if the same address should be 
read/written multiple times (0). 
The 6 LSBs (bits 5-0) represent how many read/write requests should be generated. Note that the number of requests will 
always be 1 more than the value of these bits. 
That means if you want to read or write a single address, they should be set to 0. 
Setting them to 1 will generate two read or write requests.</p>
<p>If you send a write request, after sending the command byte and address, you continue sending the data to be written. 
Data is always sent as four bytes per write request and the least significant byte should be sent first.</p>
<p>For reads, after sending the command byte and address, you simply wait for the data to be returned. 
Data is returned in least significant byte order. 
Note that you may not always receive all the data you ask for if there is an issue with the FPGA design 
(i.e. the requested data is never presented, like in our LED example).</p>
<p>Let's take a look at an example.</p>
<p>If you want to write to addresses 5, 6, and 7, you could issue the following request. 
0xC2 (1100 0010), 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00. 
This would write 1 to address 5, 2 to address 6, and 3 to address 7. 
If you changed the command byte to 0x82 (1000 0010) you would write 1 to address 5, 2 to address 5, and then 3 to 
address 5 (in that order).</p>
<p>Issuing a read follows the exact same format except the data bytes are received instead of sent.</p>
<p>A single command can generate up to 64 read/write requests. 
If you need to read/write more, you need to issue separate commands.</p>
<p>After a short period, the interface times out and resets to the <code class ="language-lucid" data-lang="lucid"><span style="color:#d45ada;">IDLE</span></code> state.
This ensures that a bad command doesn't permanently mess up the stream.</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        
        <a class="next" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;intermediate&#x2F;basic-cpu&#x2F;">
            <span class="title">Next »</span>
            <br>
            <span>Basic CPU</span>
        </a>
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2026 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"><path d="M440-320h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168Zm40 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            let codeText = '';

            // 1. Check if the codeblock contains a table (Line Numbers present)
            const tableRows = codeblock.querySelectorAll('table tr');

            if (tableRows.length > 0) {
                const lines = [];
                tableRows.forEach(row => {
                    // The actual code is in the last TD
                    const codeCell = row.lastElementChild;
                    if (codeCell) {
                        let cellText = codeCell.textContent;

                        if (cellText.endsWith('\n')) {
                            cellText = cellText.slice(0, -1);
                        }

                        lines.push(cellText);
                    }
                });
                codeText = lines.join('\n');
            } else {
                // 2. No table, use standard text extraction
                codeText = codeblock.textContent;
            }

            // 3. Copy the cleaned text to clipboard
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeText);
                copyingDone();
                return;
            }

            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
                console.error('Copy failed', e);
            }
            document.body.removeChild(textArea);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
<script type="module" src="https://alchitry.com/table-toggles.js"></script>
    
</body>
</html>
