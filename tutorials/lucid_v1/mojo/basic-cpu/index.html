<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Basic CPU</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;lucid_v1&#x2F;mojo&#x2F;basic-cpu&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://alchitry.com/css/styles.css">
<link rel="stylesheet" href="https://alchitry.com/css/override.css">


<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;">Tutorials</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;lucid_v1&#x2F;">Lucid V1</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;lucid_v1&#x2F;mojo&#x2F;">Mojo</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;lucid_v1&#x2F;mojo&#x2F;basic-cpu&#x2F;">Basic CPU</a>
            </div>
            
        </div>
        <h1 class="post-title">Basic CPU</h1>
        
        
        <div class="post-meta">
            













23 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/tutorials&#x2F;lucid_v1&#x2F;mojo&#x2F;basic-cpu.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#what-is-a-cpu" aria-label="What is a CPU?">What is a CPU?</a>
                    
                    <ul>
                    
                        <li>
                            <a href="#instruction-set" aria-label="Instruction Set">Instruction Set</a>
                            
                        </li>
                    
                        <li>
                            <a href="#memory" aria-label="Memory">Memory</a>
                            
                        </li>
                    
                        <li>
                            <a href="#operations" aria-label="Operations">Operations</a>
                            
                            <ul>
                                
                                <li>
                                    <a href="#nop" aria-label="NOP">NOP</a>
                                    
                                </li>
                                
                                <li>
                                    <a href="#load-and-store" aria-label="LOAD and STORE">LOAD and STORE</a>
                                    
                                </li>
                                
                                <li>
                                    <a href="#set" aria-label="SET">SET</a>
                                    
                                </li>
                                
                                <li>
                                    <a href="#lt-and-eq" aria-label="LT and EQ">LT and EQ</a>
                                    
                                </li>
                                
                                <li>
                                    <a href="#beq-and-bneq" aria-label="BEQ and BNEQ">BEQ and BNEQ</a>
                                    
                                </li>
                                
                                <li>
                                    <a href="#the-alu" aria-label="The ALU">The ALU</a>
                                    
                                </li>
                                
                            </ul>
                            
                        </li>
                    
                        <li>
                            <a href="#the-program-counter" aria-label="The Program Counter">The Program Counter</a>
                            
                        </li>
                    
                        <li>
                            <a href="#the-cpu" aria-label="The CPU">The CPU</a>
                            
                        </li>
                    
                    </ul>
                    
                </li>
                
                <li>
                    <a href="#the-program" aria-label="The Program">The Program</a>
                    
                </li>
                
                <li>
                    <a href="#the-assembler" aria-label="The Assembler">The Assembler</a>
                    
                </li>
                
                <li>
                    <a href="#writing-code" aria-label="Writing Code">Writing Code</a>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p>In this tutorial we will create a super basic CPU that you can then write some assembly for. You can then go brag to all your friends what a badass you are.</p>
<h2 id="what-is-a-cpu">What is a CPU?</h2>
<p>If you are reading this, there is an excellent chance you already have a decent idea what a CPU is. However, since we are going to be making one, we need to have a clear idea of exactly we are going to be making.</p>
<p>In its most abstract form, a CPU is a circuit whose behavior is determined by the code it is fed. This way, the same circuit can perform a completely different task simply by changing some values in a ROM. In general, a CPU will also have some form of memory to perform work and they all need a way to input and output data (if you don't have any IO, you can't do anything useful).</p>
<p>A CPU is some circuit that has a stream of instructions fed to it and those instructions determine what it will do. But what sort of operations do we need?</p>
<h3 id="instruction-set">Instruction Set</h3>
<p>A CPU's <em>instruction set</em> is the set of instructions that the CPU understands. It is the language of that particular processor. Each CPU has its own instruction set, however, many CPUs share the same, or very similar, instruction sets. For example, x86 is the name of Intel's instruction set for their 32 bit processors. By keeping the instruction set the same between generations of processors, the exact same software can run on different processors without needing to be modified.</p>
<p>For our super basic CPU, we will be making up our own instruction set (because we are cool like that). Our set will be pretty minimal (16 instructions) and will consist only of the essentials.</p>
<p>There are two important sizes in a CPU. The first, and the one you hear about the most, is the data path size. This determines the largest values that can be operated on at any time. When you hear that a CPU is 8 bit, 32 bit, etc., these are the data path sizes. An 8 bit processor can only operate on 8 bits at a time while a 64 bit processor can operate on 8 times that. The other important size is the instruction size. Depending on the CPU these may or may not be the same size and depending on the instruction set, instructions may actually have varying lengths!</p>
<p>For our CPU, we are going to make it 8 bit with a 16 bit instruction size. This means all our instructions need to be encoded with 16 bits. By having a fixed instruction size, it is easy to know where the next instruction starts without having to inspect every instruction before it.</p>
<h3 id="memory">Memory</h3>
<p>Before we dive into what our CPU will actually do, we need to figure out how data will get in and out and when it is in, how do we work with it? CPUs typically have a tiny bit of super duper fast memory built into them. This memory is known as the CPU's registers and serves as the working memory of the CPU. Our CPU will only be able to perform operations directly on its registers. So if all the work happens on these registers, how do we process outside data? We need a way to load data into a register and output the value of a register. The interface we will use will be basically the same as the RAM interface in the <a href="https://alchitry.com/tutorials/lucid_v1/mojo/hello-your-name-here/">Hello YOUR_NAME_HERE</a> tutorial. We will specify an address and data (for a write) or an address and we will receive data (for a read). This will be covered a bit more later. For now, just know that we have internal memory called registers and we will have a way to load and store values to/from the outside world.</p>
<h3 id="operations">Operations</h3>
<p>We now need a way to encode the instructions for our CPU. We are going to fit each instruction into 16 bits. The first four bits will be to encode what the operation is (since we will have 16 operations), and the remaining 12 bits will be unique to each operation. The four bits that encode the type of operation are known as the <strong>opcode</strong>.</p>
<p>Because some of our instructions will require 3 arguments, that leaves 4 bits for each argument. If each argument is the address of a register, we can haven at most 16 registers without increasing our instruction size.</p>
<h4 id="nop">NOP</h4>
<p>What is the most basic operation you can think of? If you thought of nothing, you win! The <em>do nothing</em> instruction, or <em>no operation</em> (often abbreviated to <strong>NOP</strong>), is going to be our first instruction.</p>
<table><thead><tr><th></th><th></th></tr></thead><tbody>
<tr><td>NOP</td><td>0</td></tr>
</tbody></table>
<p>This instruction does nothing so we can just fill the 12 bits with 0.</p>
<h4 id="load-and-store">LOAD and STORE</h4>
<p>As you should recall from only a few lines up, all CPUs need some form of IO. If you can't input data and output results, the CPU would be useless. It would be like a fully paralyzed person with no senses. They may have super interesting thoughts, but no one would ever know. We can then create two more instructions, <strong>LOAD</strong> and <strong>STORE</strong> for loading a value (input) and storing a value (output) respectively.</p>
<table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>LOAD</td><td>DEST</td><td>ADDR</td><td>OFFSET</td></tr>
<tr><td>STORE</td><td>SRC</td><td>ADDR</td><td>OFFSET</td></tr>
</tbody></table>
<p>Since the loads and stores need to provide both a value and an address, we need two arguments. The <strong>DEST</strong> argument is the register that will get the value from a <strong>LOAD</strong>. The <strong>SRC</strong> argument is the register whose value will be output. The <strong>ADDR</strong> argument is the register whose value should be used as the address. Finally, <strong>OFFSET</strong> is a constant that will be added to the value of the <strong>ADDR</strong> register to get the address. This offset can be convenient to have, but you don't really need it. I added it because there were 4 extra bits we could do something with.</p>
<h4 id="set">SET</h4>
<p>We will commonly need to set the value of a register to some constant. The <strong>SET</strong> operation will let us do that.</p>
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>SET</td><td>DEST</td><td>CONST</td></tr>
</tbody></table>
<p>Here <strong>DEST</strong> is the register that will be set and <strong>CONST</strong> is the 8 bit value to set it to. Keep in mind that since we are making an 8 bit processor, the registers are 8 bits wide.</p>
<h4 id="lt-and-eq">LT and EQ</h4>
<p>We will likely want to be able to compare two different values. To do any comparison, we only need two operators, less-than (<strong>LT</strong>) and equal (<strong>EQ</strong>). If we then wanted to perform a greater-than we could simply use less-than and flip the arguments. Less-than or equal to can be achieved by using both.</p>
<table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>LT</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>EQ</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
</tbody></table>
<p>In the <strong>LT</strong> case the <strong>DEST</strong> register will be 1 if <strong>OP1</strong> is less than <strong>OP2</strong> and 0 otherwise. <strong>EQ</strong> is the same, except it checks for equality.</p>
<h4 id="beq-and-bneq">BEQ and BNEQ</h4>
<p>Typically, a program will execute instruction after instruction. However, it can be really powerful to be able to control the flow. This is where branching instructions are useful.</p>
<table><thead><tr><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>BEQ</td><td>OP1</td><td>CONST</td></tr>
<tr><td>BNEQ</td><td>OP1</td><td>CONST</td></tr>
</tbody></table>
<p>If register <strong>OP1</strong> is equal to the value <strong>CONST</strong> then the <strong>BEQ</strong> instruction will skip the instruction following it. Otherwise, the program will continue as normal. <strong>BNEQ</strong> does the same thing but skips is they are not equal.</p>
<p>These instructions allow you to create <em>if statements</em> in your code.</p>
<h4 id="the-alu">The ALU</h4>
<p>CPUs commonly need to manipulate the values in the registers. Operations like addition, AND, OR, bit shifting, etc. are all typically contained in something called the <strong>ALU</strong> or <strong>A</strong>rithmetic <strong>L</strong>ogic <strong>U</strong>nit. These types of instructions will make up the remainder of our instruction set.</p>
<table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody>
<tr><td>ADD</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>SUB</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>SHL</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>SHR</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>AND</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>OR</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
<tr><td>INV</td><td>DEST</td><td>OP1</td><td>0</td></tr>
<tr><td>XOR</td><td>DEST</td><td>OP1</td><td>OP2</td></tr>
</tbody></table>
<p><strong>ADD</strong> and <strong>SUB</strong> add or subtract <strong>OP1</strong> and <strong>OP2</strong> and store the result into <strong>DEST</strong>.</p>
<p><strong>SHL</strong> and <strong>SHR</strong> shift <strong>OP1</strong> to the right or left by <strong>OP2</strong> bits and store the result into <strong>DEST</strong>.</p>
<p><strong>AND</strong>, <strong>OR</strong>, and <strong>XOR</strong> perform their respective bit-wise operations on <strong>OP1</strong> and <strong>OP2</strong> and store their result into <strong>DEST</strong>.</p>
<p><strong>INV</strong> does a bit-wise inversion of <strong>OP1</strong> and stores the result into <strong>DEST</strong>.</p>
<h3 id="the-program-counter">The Program Counter</h3>
<p>We are going to put all the instructions for whatever program we write into a ROM. The ROM will need an address in order to know what instruction we need. This address will be specified by the <em>program counter</em>. For our CPU, we will use register 0 as our program counter. This will allow us to directly manipulate the flow of program by messing with its value.</p>
<h3 id="the-cpu">The CPU</h3>
<p>Now that we have all the pieces, let's take a look at the actual module. You should create a new project based on the <em>Base Project</em> and create a new module named <em>cpu</em>.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><table><tbody><tr><td>1</td><td><span style="font-weight:bold;color:#faac1f;">global </span><span style="color:#da5a8c;">Inst </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>2</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">NOP   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// 0 filled
</span></td></tr><tr><td>3</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">LOAD  </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, offset  : R[dest] = M[R[op1] + offset]
</span></td></tr><tr><td>4</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">STORE </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d2</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// src, op1, offset   : M[R[op1] + offset] = R[src]
</span></td></tr><tr><td>5</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SET   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d3</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, const        : R[dest] = const
</span></td></tr><tr><td>6</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">LT    </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d4</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &lt; R[op2]
</span></td></tr><tr><td>7</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">EQ    </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d5</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] == R[op2]
</span></td></tr><tr><td>8</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">BEQ   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d6</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// op1, const         : R[0] = R[0] + (R[op1] == const ? 2 : 1)
</span></td></tr><tr><td>9</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">BNEQ  </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d7</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// op1, const         : R[0] = R[0] + (R[op1] != const ? 2 : 1)
</span></td></tr><tr><td>10</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">ADD   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d8</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] + R[op2]
</span></td></tr><tr><td>11</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SUB   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d9</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] - R[op2]
</span></td></tr><tr><td>12</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SHL   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d10</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &lt;&lt; R[op2]
</span></td></tr><tr><td>13</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SHR   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d11</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &gt;&gt; R[op2]
</span></td></tr><tr><td>14</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">AND   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d12</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &amp; R[op2]
</span></td></tr><tr><td>15</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">OR    </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d13</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] | R[op2]
</span></td></tr><tr><td>16</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">INV   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d14</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1          : R[dest] = ~R[op1]
</span></td></tr><tr><td>17</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">XOR   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d15</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] ^ R[op2]
</span></td></tr><tr><td>18</td><td><span style="color:#ed4343;">}
</span></td></tr><tr><td>19</td><td><span> 
</span></td></tr><tr><td>20</td><td><span style="font-weight:bold;color:#faac1f;">module</span><span> cpu </span><span style="color:#ed4343;">(
</span></td></tr><tr><td>21</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,         </span><span style="color:#969696;">// clock
</span></td></tr><tr><td>22</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,         </span><span style="color:#969696;">// reset
</span></td></tr><tr><td>23</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> write</span><span style="color:#ed4343;">,      </span><span style="color:#969696;">// CPU write request
</span></td></tr><tr><td>24</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> read</span><span style="color:#ed4343;">,       </span><span style="color:#969696;">// CPU read request
</span></td></tr><tr><td>25</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> address</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">], </span><span style="color:#969696;">// read/write address
</span></td></tr><tr><td>26</td><td><span>    </span><span style="color:#0a8dbf;">output</span><span> dout</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">],    </span><span style="color:#969696;">// write data
</span></td></tr><tr><td>27</td><td><span>    </span><span style="color:#0a8dbf;">input</span><span> din</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]       </span><span style="color:#969696;">// read data
</span></td></tr><tr><td>28</td><td><span>  </span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>29</td><td><span> 
</span></td></tr><tr><td>30</td><td><span>  .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">),</span><span> .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>31</td><td><span>    </span><span style="color:#0a8dbf;">dff</span><span> reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]; </span><span style="color:#969696;">// CPU Registers
</span></td></tr><tr><td>32</td><td><span>  </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>33</td><td><span> 
</span></td></tr><tr><td>34</td><td><span>  instRom instRom</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// program ROM
</span></td></tr><tr><td>35</td><td><span> 
</span></td></tr><tr><td>36</td><td><span>  </span><span style="color:#0a8dbf;">sig</span><span> op</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];        </span><span style="color:#969696;">// opcode
</span></td></tr><tr><td>37</td><td><span>  </span><span style="color:#0a8dbf;">sig</span><span> arg1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];      </span><span style="color:#969696;">// first arg
</span></td></tr><tr><td>38</td><td><span>  </span><span style="color:#0a8dbf;">sig</span><span> arg2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];      </span><span style="color:#969696;">// second arg
</span></td></tr><tr><td>39</td><td><span>  </span><span style="color:#0a8dbf;">sig</span><span> dest</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];      </span><span style="color:#969696;">// destination arg
</span></td></tr><tr><td>40</td><td><span>  </span><span style="color:#0a8dbf;">sig</span><span> constant</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// constant arg
</span></td></tr><tr><td>41</td><td><span> 
</span></td></tr><tr><td>42</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>43</td><td><span>    </span><span style="color:#969696;">// defaults
</span></td></tr><tr><td>44</td><td><span>    write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">;      </span><span style="color:#969696;">// don&#39;t write
</span></td></tr><tr><td>45</td><td><span>    read </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">;       </span><span style="color:#969696;">// don&#39;t read
</span></td></tr><tr><td>46</td><td><span>    address </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8hxx</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// don&#39;t care
</span></td></tr><tr><td>47</td><td><span>    dout </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8hxx</span><span style="color:#ed4343;">;    </span><span style="color:#969696;">// don&#39;t care
</span></td></tr><tr><td>48</td><td><span> 
</span></td></tr><tr><td>49</td><td><span>    instRom.address </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// reg 0 is program counter
</span></td></tr><tr><td>50</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">;      </span><span style="color:#969696;">// increment PC by default
</span></td></tr><tr><td>51</td><td><span> 
</span></td></tr><tr><td>52</td><td><span>    op </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">15</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">12</span><span style="color:#ed4343;">];     </span><span style="color:#969696;">// opcode is top 4 bits
</span></td></tr><tr><td>53</td><td><span>    dest </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">11</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">];    </span><span style="color:#969696;">// dest is next 4 bits
</span></td></tr><tr><td>54</td><td><span>    arg1 </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];     </span><span style="color:#969696;">// arg1 is next 4 bits
</span></td></tr><tr><td>55</td><td><span>    arg2 </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">];     </span><span style="color:#969696;">// arg2 is last 4 bits
</span></td></tr><tr><td>56</td><td><span>    constant </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]; </span><span style="color:#969696;">// constant is last 8 bits
</span></td></tr><tr><td>57</td><td><span> 
</span></td></tr><tr><td>58</td><td><span>    </span><span style="color:#969696;">// Perform the operation
</span></td></tr><tr><td>59</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>op</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>60</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">LOAD</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>61</td><td><span>        read </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">;                                  </span><span style="color:#969696;">// request a read
</span></td></tr><tr><td>62</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> din</span><span style="color:#ed4343;">;                         </span><span style="color:#969696;">// save the data
</span></td></tr><tr><td>63</td><td><span>        address </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] +</span><span> arg2</span><span style="color:#ed4343;">;              </span><span style="color:#969696;">// set the address
</span></td></tr><tr><td>64</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">STORE</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>65</td><td><span>        write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">;                                 </span><span style="color:#969696;">// request a write
</span></td></tr><tr><td>66</td><td><span>        dout </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">];                        </span><span style="color:#969696;">// output the data
</span></td></tr><tr><td>67</td><td><span>        address </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] +</span><span> arg2</span><span style="color:#ed4343;">;              </span><span style="color:#969696;">// set the address
</span></td></tr><tr><td>68</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>69</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> constant</span><span style="color:#ed4343;">;                    </span><span style="color:#969696;">// set the reg to constant
</span></td></tr><tr><td>70</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">LT</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>71</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &lt;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// less-than comparison
</span></td></tr><tr><td>72</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">EQ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>73</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] ==</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// equals comparison
</span></td></tr><tr><td>74</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BEQ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>75</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.q</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] ==</span><span> constant</span><span style="color:#ed4343;">)               </span><span style="color:#969696;">// if R[dest] == constant
</span></td></tr><tr><td>76</td><td><span>          reg.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">;                 </span><span style="color:#969696;">// skip next instruction
</span></td></tr><tr><td>77</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BNEQ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>78</td><td><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.q</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] !=</span><span> constant</span><span style="color:#ed4343;">)               </span><span style="color:#969696;">// if R[dest] != constant
</span></td></tr><tr><td>79</td><td><span>          reg.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">;                 </span><span style="color:#969696;">// skip next instruction
</span></td></tr><tr><td>80</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>81</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] +</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// addition
</span></td></tr><tr><td>82</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SUB</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>83</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] -</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// subtraction
</span></td></tr><tr><td>84</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SHL</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>85</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &lt;&lt;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// shift left
</span></td></tr><tr><td>86</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SHR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>87</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &gt;&gt;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// shift right
</span></td></tr><tr><td>88</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">AND</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>89</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &amp;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// bit-wise AND
</span></td></tr><tr><td>90</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">OR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>91</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] |</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// bit-wise OR
</span></td></tr><tr><td>92</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">INV</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>93</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] = ~</span><span>reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">];                </span><span style="color:#969696;">// bit-wise invert
</span></td></tr><tr><td>94</td><td><span>      </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">XOR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>95</td><td><span>        reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] ^</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// bit-wise XOR
</span></td></tr><tr><td>96</td><td><span>    </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>97</td><td><span>  </span><span style="color:#ed4343;">}
</span></td></tr><tr><td>98</td><td><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>The astute observer will notice that the entire CPU file is less than 100 lines long! It's pretty amazing how much functionality you can get with such a simple design.</p>
<p>Take a look at the <em>global block</em> at the beginning of the file.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>1</td><td><span style="font-weight:bold;color:#faac1f;">global </span><span style="color:#da5a8c;">Inst </span><span style="color:#ed4343;">{
</span></td></tr><tr><td>2</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">NOP   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// 0 filled
</span></td></tr><tr><td>3</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">LOAD  </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, offset  : R[dest] = M[R[op1] + offset]
</span></td></tr><tr><td>4</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">STORE </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d2</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// src, op1, offset   : M[R[op1] + offset] = R[src]
</span></td></tr><tr><td>5</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SET   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d3</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, const        : R[dest] = const
</span></td></tr><tr><td>6</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">LT    </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d4</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &lt; R[op2]
</span></td></tr><tr><td>7</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">EQ    </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d5</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] == R[op2]
</span></td></tr><tr><td>8</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">BEQ   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d6</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// op1, const         : R[0] = R[0] + (R[op1] == const ? 2 : 1)
</span></td></tr><tr><td>9</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">BNEQ  </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d7</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// op1, const         : R[0] = R[0] + (R[op1] != const ? 2 : 1)
</span></td></tr><tr><td>10</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">ADD   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d8</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] + R[op2]
</span></td></tr><tr><td>11</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SUB   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d9</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] - R[op2]
</span></td></tr><tr><td>12</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SHL   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d10</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &lt;&lt; R[op2]
</span></td></tr><tr><td>13</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">SHR   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d11</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &gt;&gt; R[op2]
</span></td></tr><tr><td>14</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">AND   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d12</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] &amp; R[op2]
</span></td></tr><tr><td>15</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">OR    </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d13</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] | R[op2]
</span></td></tr><tr><td>16</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">INV   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d14</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1          : R[dest] = ~R[op1]
</span></td></tr><tr><td>17</td><td><span>  </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">XOR   </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4d15</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// dest, op1, op2     : R[dest] = R[op1] ^ R[op2]
</span></td></tr><tr><td>18</td><td><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>This block allows us to define constants that can be used in any Lucid file in out project. This is helpful since we will be using these in our instruction ROM. The name you give a <em>global block</em> is the <em>namespace</em> that its contents live in. To access a globally defined constant, you use the syntax <em>Namespace.CONST</em>. The name of a <em>namespace</em> needs to start with a capital and contain at least one lowercase letter.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>30</td><td><span>.clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">),</span><span> .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>31</td><td><span>  </span><span style="color:#0a8dbf;">dff</span><span> reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]; </span><span style="color:#969696;">// CPU Registers
</span></td></tr><tr><td>32</td><td><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>Our CPU's registers are nothing other than a set of <em>dffs</em>. We use a 2D array of 16 by 8 since we want 16 registers of width 8.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>34</td><td><span>instRom instRom</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// program ROM
</span></td></tr></tbody></table></code></pre>
<p>We can't forget out program ROM! We will cover the actual ROM in a bit. However, it has only two ports, <em>address</em> and <em>inst</em>. It simply outputs the corresponding instruction on <em>inst</em> for the given <em>address</em>.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>36</td><td><span style="color:#0a8dbf;">sig</span><span> op</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];        </span><span style="color:#969696;">// opcode
</span></td></tr><tr><td>37</td><td><span style="color:#0a8dbf;">sig</span><span> arg1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];      </span><span style="color:#969696;">// first arg
</span></td></tr><tr><td>38</td><td><span style="color:#0a8dbf;">sig</span><span> arg2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];      </span><span style="color:#969696;">// second arg
</span></td></tr><tr><td>39</td><td><span style="color:#0a8dbf;">sig</span><span> dest</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];      </span><span style="color:#969696;">// destination arg
</span></td></tr><tr><td>40</td><td><span style="color:#0a8dbf;">sig</span><span> constant</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// constant arg
</span></td></tr></tbody></table></code></pre>
<p>These signals aren't strictly needed, but they help make the code a bit more readable by allowing us to rename parts of the instruction.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>52</td><td><span>op </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">15</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">12</span><span style="color:#ed4343;">];     </span><span style="color:#969696;">// opcode is top 4 bits
</span></td></tr><tr><td>53</td><td><span>dest </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">11</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">];    </span><span style="color:#969696;">// dest is next 4 bits
</span></td></tr><tr><td>54</td><td><span>arg1 </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">];     </span><span style="color:#969696;">// arg1 is next 4 bits
</span></td></tr><tr><td>55</td><td><span>arg2 </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">];     </span><span style="color:#969696;">// arg2 is last 4 bits
</span></td></tr><tr><td>56</td><td><span>constant </span><span style="color:#ed4343;">=</span><span> instRom.inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]; </span><span style="color:#969696;">// constant is last 8 bits
</span></td></tr></tbody></table></code></pre>
<p>Here is the actual assignment. The way we defined our instruction set, the <em>opcode</em> is always the 4 most-significant bits. The other four signals are just the common names for the different parts of the instruction.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>43</td><td><span style="color:#969696;">// defaults
</span></td></tr><tr><td>44</td><td><span>write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">;      </span><span style="color:#969696;">// don&#39;t write
</span></td></tr><tr><td>45</td><td><span>read </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">;       </span><span style="color:#969696;">// don&#39;t read
</span></td></tr><tr><td>46</td><td><span>address </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8hxx</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// don&#39;t care
</span></td></tr><tr><td>47</td><td><span>dout </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8hxx</span><span style="color:#ed4343;">;    </span><span style="color:#969696;">// don&#39;t care
</span></td></tr></tbody></table></code></pre>
<p>In the beginning of an <em>always</em> block, it is a good idea to assign defaults at the top so you don't have to worry about assigning a value in every possible conditional branch. In this case, by default we don't want to perform a read or write and if we aren't performing a read or write we don't care what the values of <em>address</em> or <em>dout</em> are.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>49</td><td><span>instRom.address </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// reg 0 is program counter
</span></td></tr><tr><td>50</td><td><span>reg.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">;      </span><span style="color:#969696;">// increment PC by default
</span></td></tr></tbody></table></code></pre>
<p>We decided to use the first register as our program counter. This means we are going to feed its value into the instruction ROM. We also need to increment it each cycle so that our program continues to execute. Since the line to perform the increment comes before the code to execute the instruction, if the instruction writes to the first register it will have precedence over the increment. This will allow us to manipulate the program counter with our code.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>58</td><td><span style="color:#969696;">// Perform the operation
</span></td></tr><tr><td>59</td><td><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>op</span><span style="color:#ed4343;">) {
</span></td></tr><tr><td>60</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">LOAD</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>61</td><td><span>    read </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">;                                  </span><span style="color:#969696;">// request a read
</span></td></tr><tr><td>62</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> din</span><span style="color:#ed4343;">;                         </span><span style="color:#969696;">// save the data
</span></td></tr><tr><td>63</td><td><span>    address </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] +</span><span> arg2</span><span style="color:#ed4343;">;              </span><span style="color:#969696;">// set the address
</span></td></tr><tr><td>64</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">STORE</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>65</td><td><span>    write </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">;                                 </span><span style="color:#969696;">// request a write
</span></td></tr><tr><td>66</td><td><span>    dout </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">];                        </span><span style="color:#969696;">// output the data
</span></td></tr><tr><td>67</td><td><span>    address </span><span style="color:#ed4343;">=</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] +</span><span> arg2</span><span style="color:#ed4343;">;              </span><span style="color:#969696;">// set the address
</span></td></tr><tr><td>68</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>69</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> constant</span><span style="color:#ed4343;">;                    </span><span style="color:#969696;">// set the reg to constant
</span></td></tr><tr><td>70</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">LT</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>71</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &lt;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// less-than comparison
</span></td></tr><tr><td>72</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">EQ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>73</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] ==</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// equals comparison
</span></td></tr><tr><td>74</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BEQ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>75</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.q</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] ==</span><span> constant</span><span style="color:#ed4343;">)               </span><span style="color:#969696;">// if R[dest] == constant
</span></td></tr><tr><td>76</td><td><span>      reg.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">;                 </span><span style="color:#969696;">// skip next instruction
</span></td></tr><tr><td>77</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BNEQ</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>78</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>reg.q</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] !=</span><span> constant</span><span style="color:#ed4343;">)               </span><span style="color:#969696;">// if R[dest] != constant
</span></td></tr><tr><td>79</td><td><span>      reg.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">;                 </span><span style="color:#969696;">// skip next instruction
</span></td></tr><tr><td>80</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>81</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] +</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// addition
</span></td></tr><tr><td>82</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SUB</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>83</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] -</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// subtraction
</span></td></tr><tr><td>84</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SHL</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>85</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &lt;&lt;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// shift left
</span></td></tr><tr><td>86</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SHR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>87</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &gt;&gt;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];  </span><span style="color:#969696;">// shift right
</span></td></tr><tr><td>88</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">AND</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>89</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] &amp;</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// bit-wise AND
</span></td></tr><tr><td>90</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">OR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>91</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] |</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// bit-wise OR
</span></td></tr><tr><td>92</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">INV</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>93</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] = ~</span><span>reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">];                </span><span style="color:#969696;">// bit-wise invert
</span></td></tr><tr><td>94</td><td><span>  </span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">XOR</span><span style="color:#ed4343;">:
</span></td></tr><tr><td>95</td><td><span>    reg.d</span><span style="color:#ed4343;">[</span><span>dest</span><span style="color:#ed4343;">] =</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg1</span><span style="color:#ed4343;">] ^</span><span> reg.q</span><span style="color:#ed4343;">[</span><span>arg2</span><span style="color:#ed4343;">];   </span><span style="color:#969696;">// bit-wise XOR
</span></td></tr><tr><td>96</td><td><span style="color:#ed4343;">}
</span></td></tr></tbody></table></code></pre>
<p>Here we execute the instruction. You may be surprised how simple this is. We simply use a <em>case statement</em> to select what behavior we want.</p>
<h2 id="the-program">The Program</h2>
<p>Now that we have a CPU, we need to write a program for it. Before getting deep into it, let's get something running to make sure everything is working.</p>
<p>Create a new module <em>instRom</em> and paste in the following.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> instRom </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> address</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> inst</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>  </span><span style="color:#ed4343;">) {
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>    inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">NOP</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">12b0</span><span style="color:#ed4343;">};
</span><span> 
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>address</span><span style="color:#ed4343;">) {
</span><span>      </span><span style="color:#969696;">// begin:
</span><span>      </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};              </span><span style="color:#969696;">// SET R2, 0
</span><span>      </span><span style="color:#969696;">// loop:
</span><span>      </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d128</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// SET R1, 128
</span><span>      </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">STORE</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">};       </span><span style="color:#969696;">// STORE R2, R1, 0
</span><span>      </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d1</span><span style="color:#ed4343;">};              </span><span style="color:#969696;">// SET R1, 1
</span><span>      </span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">};         </span><span style="color:#969696;">// ADD R2, R2, R1
</span><span>      </span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d15</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d1</span><span style="color:#ed4343;">};             </span><span style="color:#969696;">// SET R15, loop
</span><span>      </span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d7</span><span style="color:#ed4343;">};              </span><span style="color:#969696;">// SET R0, delay
</span><span>      </span><span style="color:#969696;">// delay:
</span><span>      </span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};             </span><span style="color:#969696;">// SET R11, 0
</span><span>      </span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d12</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};             </span><span style="color:#969696;">// SET R12, 0
</span><span>      </span><span style="color:#a269dc;">9</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d13</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};             </span><span style="color:#969696;">// SET R13, 0
</span><span>      </span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d1</span><span style="color:#ed4343;">};             </span><span style="color:#969696;">// SET R1, 1
</span><span>      </span><span style="color:#969696;">// delay_loop:
</span><span>      </span><span style="color:#a269dc;">11</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">};      </span><span style="color:#969696;">// ADD R11, R11, R1
</span><span>      </span><span style="color:#a269dc;">12</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BEQ</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// BEQ R11, 0
</span><span>      </span><span style="color:#a269dc;">13</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d11</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// SET R0, delay_loop
</span><span>      </span><span style="color:#a269dc;">14</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d12</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d12</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">};      </span><span style="color:#969696;">// ADD R12, R12, R1
</span><span>      </span><span style="color:#a269dc;">15</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BEQ</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d12</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// BEQ R12, 0
</span><span>      </span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d11</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// SET R0, delay_loop
</span><span>      </span><span style="color:#a269dc;">17</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d13</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d13</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">};      </span><span style="color:#969696;">// ADD R13, R13, R1
</span><span>      </span><span style="color:#a269dc;">18</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">BEQ</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d13</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// BEQ R13, 0
</span><span>      </span><span style="color:#a269dc;">19</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d11</span><span style="color:#ed4343;">};            </span><span style="color:#969696;">// SET R0, delay_loop
</span><span>      </span><span style="color:#a269dc;">20</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">SET</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8d0</span><span style="color:#ed4343;">};             </span><span style="color:#969696;">// SET R1, 0
</span><span>      </span><span style="color:#a269dc;">21</span><span style="color:#ed4343;">:</span><span> inst </span><span style="color:#ed4343;">= c{</span><span style="color:#da5a8c;">Inst</span><span>.</span><span style="color:#d45ada;">ADD</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d15</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">4d1</span><span style="color:#ed4343;">};       </span><span style="color:#969696;">// ADD R0, R15, R1
</span><span>    </span><span style="color:#ed4343;">}
</span><span>  </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>This code will slowly increment a counter and output it to address 128. We will go over the details of it a bit later, but first let us hook it up to the LEDs.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> mojo_top </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,              </span><span style="color:#969696;">// 50MHz clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst_n</span><span style="color:#ed4343;">,            </span><span style="color:#969696;">// reset button (active low)
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> led </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">],         </span><span style="color:#969696;">// 8 user controllable LEDs
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> cclk</span><span style="color:#ed4343;">,             </span><span style="color:#969696;">// configuration clock, AVR ready when high
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> spi_miso</span><span style="color:#ed4343;">,        </span><span style="color:#969696;">// AVR SPI MISO
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> spi_ss</span><span style="color:#ed4343;">,           </span><span style="color:#969696;">// AVR SPI Slave Select
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> spi_mosi</span><span style="color:#ed4343;">,         </span><span style="color:#969696;">// AVR SPI MOSI
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> spi_sck</span><span style="color:#ed4343;">,          </span><span style="color:#969696;">// AVR SPI Clock
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> spi_channel </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">], </span><span style="color:#969696;">// AVR general purpose pins (used by default to select ADC channel)
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> avr_tx</span><span style="color:#ed4343;">,           </span><span style="color:#969696;">// AVR TX (FPGA RX)
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> avr_rx</span><span style="color:#ed4343;">,          </span><span style="color:#969696;">// AVR RX (FPGA TX)
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> avr_rx_busy       </span><span style="color:#969696;">// AVR RX buffer full
</span><span>  </span><span style="color:#ed4343;">) {
</span><span> 
</span><span>  </span><span style="color:#0a8dbf;">sig</span><span> rst</span><span style="color:#ed4343;">;                  </span><span style="color:#969696;">// reset signal
</span><span> 
</span><span>  .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>    </span><span style="color:#969696;">// The reset conditioner is used to synchronize the reset signal to the FPGA
</span><span>    </span><span style="color:#969696;">// clock. This ensures the entire FPGA comes out of reset at the same time.
</span><span>    reset_conditioner reset_cond</span><span style="color:#ed4343;">;
</span><span> 
</span><span>    .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>      cpu cpu</span><span style="color:#ed4343;">;        </span><span style="color:#969696;">// our snazzy CPU
</span><span>      </span><span style="color:#0a8dbf;">dff</span><span> led_reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]; </span><span style="color:#969696;">// storage for LED value
</span><span>    </span><span style="color:#ed4343;">}
</span><span>  </span><span style="color:#ed4343;">}
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>    reset_cond.in </span><span style="color:#ed4343;">= ~</span><span>rst_n</span><span style="color:#ed4343;">;   </span><span style="color:#969696;">// input raw inverted reset signal
</span><span>    rst </span><span style="color:#ed4343;">=</span><span> reset_cond.out</span><span style="color:#ed4343;">;     </span><span style="color:#969696;">// conditioned reset
</span><span> 
</span><span>    spi_miso </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bz</span><span style="color:#ed4343;">;            </span><span style="color:#969696;">// not using SPI
</span><span>    spi_channel </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bzzzz</span><span style="color:#ed4343;">;      </span><span style="color:#969696;">// not using flags
</span><span>    avr_rx </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bz</span><span style="color:#ed4343;">;              </span><span style="color:#969696;">// not using serial port
</span><span> 
</span><span>    cpu.din </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8hxx</span><span style="color:#ed4343;">;           </span><span style="color:#969696;">// default to don&#39;t care
</span><span> 
</span><span>    </span><span style="color:#969696;">// if cpu uses address 128
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>cpu.address </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">128</span><span style="color:#ed4343;">) {
</span><span>      </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>cpu.write</span><span style="color:#ed4343;">)
</span><span>        led_reg.d </span><span style="color:#ed4343;">=</span><span> cpu.dout</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// update the LED value
</span><span>      </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>cpu.read</span><span style="color:#ed4343;">)
</span><span>        cpu.din </span><span style="color:#ed4343;">=</span><span> led_reg.q</span><span style="color:#ed4343;">;  </span><span style="color:#969696;">// let the CPU read the LED value
</span><span>    </span><span style="color:#ed4343;">}
</span><span> 
</span><span>    led </span><span style="color:#ed4343;">=</span><span> led_reg.q</span><span style="color:#ed4343;">;          </span><span style="color:#969696;">// connect LEDs to led_reg
</span><span>  </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>In <em>mojo_top</em> we need to add the CPU and a <em>dff</em> to hold the value for the LEDs. When the CPU writes to address 128, we can save the value in the <em>dff</em> and connect that to the LEDs. This way, the CPU can directly control the LEDs by writing to this address!</p>
<p>Why use address 128? In practice could have chosen any address, but the reason we used 128 instead of say 0, is because the first half of the address space is typically reserved for RAM. Our CPU doesn't currently have access to RAM, but we <em>could</em> hook it up to some. Using a memory interface like this to perform IO is known as <strong>memory mapped IO</strong>. This is how basically all CPUs perform IO. If you've ever worked with AVRs and written something like <em>PORTA = 0x5A;</em>, <em>PORTA</em> is actually just a special memory address that instead of writing to RAM writes to the IO port (exactly what we are doing here).</p>
<p>Go ahead and build/load the project to your Mojo. The LEDs should now count slowly.</p>
<h2 id="the-assembler">The Assembler</h2>
<p>While we could write the <em>instRom</em> module ourselves to create programs, but it becomes a huge pain to edit them. If you want to insert an instruction you have to renumber everything. It is a nightmare. Luckily we don't have to! I wrote a basic assembler for us (you're welcome &lt;3). You can find the assembler code on <a href="https://github.com/embmicro/SkinnyAssembler">GitHub</a>. If you just want to download the runnable JAR you can <a href="https://github.com/embmicro/SkinnyAssembler/raw/master/skinny-asm.jar">click here</a>. It should run on any OS with Java 1.7.</p>
<p>I used <a href="http://www.antlr.org/">ANTLR</a> to parse the assembly. This is an awesome library that makes writing something like this pretty easy.</p>
<p>To use the assembler, use the following command.</p>
<pre data-lang="bash" style="background-color:#282828;color:#ffffff;" class="language-bash "><code class ="language-bash" data-lang="bash"><span style="color:#6699cc;">java</span><span style="color:#a269dc;"> -jar</span><span style="color:#6699cc;"> skinny-asm.jar assembly-file.asm
</span></code></pre>
<p>It should then turn your assembly in <em>assembly-file.asm</em> into the <em>instRom</em> module, or tell you what's wrong with your file.</p>
<p>Here is the assembly file I used to generate the ROM from earlier.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><span>begin</span><span style="color:#ed4343;">:  
</span><span>  </span><span style="color:#d45ada;">SET R2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0           </span><span style="color:#969696;">// R2 = 0
</span><span>loop</span><span style="color:#ed4343;">:
</span><span>  </span><span style="color:#d45ada;">SET R1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">128         </span><span style="color:#969696;">// R1 = 128
</span><span>  </span><span style="color:#d45ada;">STORE R2</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0     </span><span style="color:#969696;">// M[128] = R2
</span><span>  </span><span style="color:#d45ada;">SET R1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">1           </span><span style="color:#969696;">// R1 = 1
</span><span>  </span><span style="color:#d45ada;">ADD R2</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R2</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1      </span><span style="color:#969696;">// R2++
</span><span>  </span><span style="color:#d45ada;">SET R15</span><span style="color:#ed4343;">,</span><span> loop       </span><span style="color:#969696;">// R15 = loop, R15 is return address
</span><span>  </span><span style="color:#d45ada;">SET R0</span><span style="color:#ed4343;">,</span><span> delay       </span><span style="color:#969696;">// goto delay
</span><span>delay</span><span style="color:#ed4343;">:
</span><span>  </span><span style="color:#d45ada;">SET R11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0          </span><span style="color:#969696;">// R11 = 0
</span><span>  </span><span style="color:#d45ada;">SET R12</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0          </span><span style="color:#969696;">// R12 = 0
</span><span>  </span><span style="color:#d45ada;">SET R13</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0          </span><span style="color:#969696;">// R13 = 0
</span><span>  </span><span style="color:#d45ada;">SET R1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">1           </span><span style="color:#969696;">// R1 = 1
</span><span>delay_loop</span><span style="color:#ed4343;">:
</span><span>  </span><span style="color:#d45ada;">ADD R11</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R11</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1    </span><span style="color:#969696;">// R11++
</span><span>  </span><span style="color:#d45ada;">BEQ R11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0          </span><span style="color:#969696;">// skip next if (R11 == 0)
</span><span>  </span><span style="color:#d45ada;">SET R0</span><span style="color:#ed4343;">,</span><span> delay_loop  </span><span style="color:#969696;">// goto delay_loop
</span><span>  </span><span style="color:#d45ada;">ADD R12</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R12</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1    </span><span style="color:#969696;">// R12++
</span><span>  </span><span style="color:#d45ada;">BEQ R12</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0          </span><span style="color:#969696;">// skip next if (R12 == 0)
</span><span>  </span><span style="color:#d45ada;">SET R0</span><span style="color:#ed4343;">,</span><span> delay_loop  </span><span style="color:#969696;">// goto delay_loop
</span><span>  </span><span style="color:#d45ada;">ADD R13</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R13</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1    </span><span style="color:#969696;">// R13++
</span><span>  </span><span style="color:#d45ada;">BEQ R13</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0          </span><span style="color:#969696;">// skip next if (R13 == 0)
</span><span>  </span><span style="color:#d45ada;">SET R0</span><span style="color:#ed4343;">,</span><span> delay_loop  </span><span style="color:#969696;">// goto delay_loop
</span><span>  </span><span style="color:#d45ada;">SET R1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">0           </span><span style="color:#969696;">// R1 = 0
</span><span>  </span><span style="color:#d45ada;">ADD R0</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R15</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1     </span><span style="color:#969696;">// R0 = R15 (return)
</span></code></pre>
<p>There are two types of lines that the assembler will accept, labels and instructions. A label is simply a name followed by a ':'. These act as constants that will be replaced with the line number of the instruction following it. For example, the label <em>begin</em> in the above code will have the value 0 since it is before the first instruction. These make it easy to reference instructions without having to relay on fixed numbers (to avoid the insert problem).</p>
<p>Instructions consist of the name of the <em>opcode</em> followed by a list of comma separated arguments. Constants can either be a decimal number or a label. Registers take the form <em>R#</em> where <em>#</em> is the register number.</p>
<h2 id="writing-code">Writing Code</h2>
<p>While our CPU only treats R0 specially (it's the program counter), it is helpful to assign special roles to some registers for use in our programs. For example, for many instructions it can be handy to have a temporary register to load a constant into. I used R1 for this purpose. The other special register I used was R15 to store the return address from a function call (more on this later).</p>
<p>The goal of this program was to count and output the count to address 128. Since we have no external RAM, all our memory needs to fit in the 16 registers. I chose R2 to store our primary counter.</p>
<p>The first line initializes R2 to 0, we then enter the main loop. The main loop starts by writing R2 to address 128. R1 is used to store the address 128 used by the <em>STORE</em> instruction. We then increment R2 by one. Again, we use R1 to store the constant 1 to add to R2.</p>
<p>We could simply loop here, however, it would count way too fast for us to see on the LEDs. So we need to create a delay function. A function is just a block of code that can be called from anywhere and will return to where it's called from. We use R15 to specify the address we want to return to. In our case, we cheat a little bit and set R15 to the beginning of our loop instead of the instruction after the call to <em>delay</em>. This is just a little more efficient.</p>
<p>We can use the <em>SET</em> instruction with R0 to jump to anywhere in our program. There is where labels are really helpful since we don't care what the actual instruction number is as the label will get replaced with the proper value.</p>
<p>The delay function uses R11, R12, and R13 to count from 0 to 16,777,215. This takes a decent amount of time so we can actually see the LEDs change.</p>
<p>Once the counter overflows, the delay function returns to the address in R15 using the <em>ADD</em> instruction to set R0 to R15.</p>
<p>Try editing this code, or write you own program! Feel free to even swap out some of the instructions for your own if you can think of something more useful. Maybe you'd rather an instruction for directly setting a bit instead of XOR, or maybe you would rather be able to tell if a value is even than shifting right.</p>
<p>That's it for this tutorial. I hope you enjoyed making a basic CPU! It's pretty freaking awesome to write code for hardware that you designed! Go make something awesome!</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        <a class="prev" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;lucid_v1&#x2F;mojo&#x2F;servos&#x2F;">
            <span class="title">« Prev</span>
            <br>
            <span>Servos</span>
        </a>
        
        
        <a class="next" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;lucid_v1&#x2F;mojo&#x2F;register-interface&#x2F;">
            <span class="title">Next »</span>
            <br>
            <span>Register Interface</span>
        </a>
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2025 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z"/>
    </svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
    
</body>
</html>
