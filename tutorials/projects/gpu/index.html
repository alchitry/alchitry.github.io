<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>GPU</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;gpu&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
</script>
<script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
</script>

<link rel="stylesheet" href="https://alchitry.com/styles.css">
<link rel="stylesheet" href="https://alchitry.com/override.css">

<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;">Tutorials</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;">Projects</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;gpu&#x2F;">GPU</a>
            </div>
            
        </div>
        <h1 class="post-title">GPU</h1>
        
        
        <div class="post-meta">
            













31 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/tutorials&#x2F;projects&#x2F;gpu.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#basic-architecture" aria-label="Basic Architecture">Basic Architecture</a>
                    
                </li>
                
                <li>
                    <a href="#the-pipeline" aria-label="The Pipeline">The Pipeline</a>
                    
                    <ul>
                    
                        <li>
                            <a href="#stage-1-generate-the-model-matrix" aria-label="Stage 1 - Generate the Model Matrix">Stage 1 - Generate the Model Matrix</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-2-triangle-assembly" aria-label="Stage 2 - Triangle Assembly">Stage 2 - Triangle Assembly</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-3-transformation" aria-label="Stage 3 - Transformation">Stage 3 - Transformation</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-4-shader" aria-label="Stage 4 - Shader">Stage 4 - Shader</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-5-projector" aria-label="Stage 5 - Projector">Stage 5 - Projector</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-6-bounding-box" aria-label="Stage 6 - Bounding Box">Stage 6 - Bounding Box</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-7-rasterizer" aria-label="Stage 7 - Rasterizer">Stage 7 - Rasterizer</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-8-z-buffer" aria-label="Stage 8 - Z-Buffer">Stage 8 - Z-Buffer</a>
                            
                        </li>
                    
                        <li>
                            <a href="#stage-9-write-buffer" aria-label="Stage 9 - Write Buffer">Stage 9 - Write Buffer</a>
                            
                        </li>
                    
                    </ul>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p><img src="https://cdn.alchitry.com/projects/gpu/GPU.gif" alt="GPU Demo" /></p>
<p>This is by far the most complicated project/tutorial to date. 
On this first page I’ll be giving a rough overview of the main pieces, and in later pages I’ll be diving deep into how each one works.</p>
<p>This project is now built into Alchitry Labs.
It is the <em>Hd GPU</em> template project available for the <a href="https://shop.alchitry.com/products/alchitry-au">Au V2</a>, or <a href="https://shop.alchitry.com/products/alchitry-pt">Pt V2</a>.</p>
<p>It outputs the video data through the <a href="https://shop.alchitry.com/products/alchitry-hd">Hd</a> at 720p60.</p>
<h1 id="basic-architecture">Basic Architecture</h1>
<p>Before getting into any FPGA specific details, we need to go over what our goal is and what has to happen to get there.</p>
<p>The goal of this GPU is to take a 3D model and render it onto a 2D frame. 
When you put it like that, it doesn’t sound so bad. 
There are a few minor other details to consider first, though…</p>
<p>Graphics in general rely heavily on linear algebra. 
If you aren’t familiar with vectors and matrices, now would be a good time to freshen up. 
There are tons of tutorials out there about it. 
For most of this tutorial, you really only need to know how to multiply a vector by a matrix.</p>
<p>Our GPU will accept a few parameters.</p>
<p>First, we need something to draw. 
Our GPU, like every good GPU, will draw triangles. 
We will specify the triangles with two ROMs. 
The first ROM contains all the vertices (and colors of those vertices). 
The second ROM contains the faces. 
That is, the list of three vertices that make up a triangle.</p>
<p>While manually coming up with and typing out hundreds of vertices and faces sounds fun, we will use <a href="https://www.blender.org/">Blender</a>
to model something, and some Java to convert it into a ROM.</p>
<p>Second, we need a model transformation matrix. 
This matrix is responsible for moving around objects. 
By multiplying our model’s 3D points by this matrix, we can rotate, translate, and scale the model however we want. 
Most renders will have two of these. 
One for the model and one for the camera (viewpoint into the scene). 
To keep things a bit simpler, our pipeline will only have one. 
Our camera will be stationary, but you could make it seem like it is moving by transforming the entire scene.</p>
<p>By using a matrix to specify the transformations, our GPU only needs to perform basic matrix multiplication instead of trig to rotate points! 
The trig functions still need to be calculated but only once (per object) to produce the matrix.</p>
<p>We also need some kind of lighting. 
We could have no lighting and just color every triangle its specified color, but this significantly reduces the 
perceived details of the model. 
There are huge numbers of ways to calculate lighting in a scene with the holy grail being ray tracing. 
That is where you simulate the actual rays of light and calculate how they bounce and interact with the objects in the scene. 
This is what you can get with a modern GPU and is not what we will be doing.</p>
<p>Instead, we will be taking a much simpler approach. 
Our GPU will accept a single light vector. 
That is, the direction light is coming from. 
We will then calculate the angle between each triangle and the light vector and use that to calculate the color. 
This method has no concept of shadows, which are substantially more complicated. 
It still produces a nice effect where we can make it look like things are illuminated from above.</p>
<p>Finally, we need a projection matrix for converting 3D points to 2D points. 
This matrix is set up in such a way that when a 3D point is multiplied by it, we will get the 2D coordinate of it.
We will be using a fixed frustum style projection. 
This projection works in such a way that further objects appear smaller. 
At the core of it, you divide the X and Y coordinates by their Z coordinate. 
Larger Z (further away) means the X and Y get pulled more into the center of the frame.</p>
<h1 id="the-pipeline">The Pipeline</h1>
<h2 id="stage-1-generate-the-model-matrix">Stage 1 - Generate the Model Matrix</h2>
<p>I wouldn’t necessarily consider this part of the GPU’s job as this matrix would generally be provided to the GPU. 
However, our pipeline is self-contained and this matrix is the first thing needed for producing a frame.</p>
<p>As mentioned above, this matrix is responsible for all the translations, rotations, and scaling, we want to apply to our model.</p>
<p>The <code class ="language-lucid" data-lang="lucid"><span>matrix_generator</span></code> module is responsible for creating the matrix.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> matrix_generator </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">], </span><span style="color:#969696;">// 2.8 FP
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> valid
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">N_PI </span><span style="color:#ed4343;">= -</span><span style="color:#a269dc;">10d402
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">PI </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">10d402
</span><span>    
</span><span>    cordic cordic </span><span style="color:#ed4343;">(</span><span>.aclk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">))
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> angle</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">] (#</span><span style="color:#d45ada;">INIT</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">N_PI</span><span style="color:#ed4343;">))
</span><span>        </span><span style="color:#ed4343;">}
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> cos</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> sin</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">]
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        cordic.s_axis_phase_tdata </span><span style="color:#ed4343;">=</span><span> angle.q
</span><span>        cordic.s_axis_phase_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>cordic.s_axis_phase_tready</span><span style="color:#ed4343;">) {
</span><span>            angle.d </span><span style="color:#ed4343;">=</span><span> angle.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">5
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>angle.q</span><span style="color:#ed4343;">) &gt;= </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">PI </span><span style="color:#ed4343;">- </span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">))
</span><span>                angle.d </span><span style="color:#ed4343;">= </span><span style="color:#d45ada;">N_PI
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        cordic.m_axis_dout_tready </span><span style="color:#ed4343;">= !</span><span>stall
</span><span>        sin </span><span style="color:#ed4343;">=</span><span> cordic.m_axis_dout_tdata</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">25</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        cos </span><span style="color:#ed4343;">=</span><span> cordic.m_axis_dout_tdata</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">9</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        valid </span><span style="color:#ed4343;">=</span><span> cordic.m_axis_dout_tvalid
</span><span>        
</span><span>        matrix </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">x{{</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">x{{</span><span style="color:#a269dc;">10b0</span><span style="color:#ed4343;">}}}}
</span><span>        
</span><span>        </span><span style="color:#969696;">/*
</span><span style="color:#969696;">        // Rotate Z
</span><span style="color:#969696;">        matrix[0][0] = cos;
</span><span style="color:#969696;">        matrix[0][1] = -sin;
</span><span style="color:#969696;">        matrix[1][0] = sin;
</span><span style="color:#969696;">        matrix[1][1] = cos;
</span><span style="color:#969696;">        matrix[2][2] = 10h100; // 1
</span><span style="color:#969696;">        */        
</span><span>        
</span><span>        
</span><span>        </span><span style="color:#969696;">// Rotate Y
</span><span>        matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> cos
</span><span>        matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> sin
</span><span>        matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">10h100 </span><span style="color:#969696;">// 1
</span><span>        matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = -</span><span>sin
</span><span>        matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> cos
</span><span>        
</span><span>        
</span><span>        </span><span style="color:#969696;">/*
</span><span style="color:#969696;">        // Rotate X
</span><span style="color:#969696;">        matrix[0][0] = 10h100 // 1
</span><span style="color:#969696;">        matrix[1][1] = cos
</span><span style="color:#969696;">        matrix[1][2] = -sin
</span><span style="color:#969696;">        matrix[2][1] = sin
</span><span style="color:#969696;">        matrix[2][2] = cos
</span><span style="color:#969696;">        */        
</span><span>        
</span><span>        matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">400 </span><span style="color:#969696;">// 1
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>For the demo, the matrix will rotate the model along a given axis. 
The default is Y. 
To perform any rotations, we need to calculate the sin and cos values for the angle we want to rotate.</p>
<p>We can calculate these on the FPGA by using the CORDIC core from Xilinx. 
CORDIC is a clever algorithm that can be used to calculate a few things, including sin and cos, efficiently in hardware. 
Check out the <a href="https://en.wikipedia.org/wiki/CORDIC">Wikipedia page</a> for the nitty-gritty. 
All we care about here is Xilinx provides a module that uses this algorithm, and we can use it to get sin and cos values for an input angle.</p>
<p>We set up the CORDIC core to accept a radian angle input in 3.7 fixed point format. 
This means the input value is 10 bits wide, but the lower 7 bits are fractional. 
For example, <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">10b0010000000</span></code> is equal to 1 and <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">10b0001000000</span></code> is equal to 0.5.</p>
<p>We want to input values from -Pi to Pi. 
To get the value of Pi in 3.7 fixed point, we can multiply it by 2^7. 
Pi * 2^7 ≈ 402.</p>
<p>The output of the CORDIC is in 2.8 fixed point format as the values are bound to +/-1. 
To keep things simple, our matrix will also be in 2.8 fixed point with a minor exception.</p>
<p>You may have noticed the matrix is 3x4 and not 3x3. 
Each row has an extra dimension. 
This dimension is used for translating. 
Technically, a linear transformation can only rotate and scale the input vector. 
However, by working in four dimensions instead of three, we can effectively translate in the third dimension. 
If we force the fourth (aka <em>W</em>) value of each input vector to always be 1, we effectively just add the <em>W</em> value of the matrix to it.</p>
<p>This is what happens on the last line of the module where the <em>Z</em> row’s <em>W</em> column is set to <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">400</span></code>. 
This pushes the object 400 units away. 
The <em>W</em> values are 10.0 fixed point, meaning they are standard numbers without a fractional component.</p>
<h2 id="stage-2-triangle-assembly">Stage 2 - Triangle Assembly</h2>
<p>Now that we have a matrix to apply to our model, we need to start generating triangles. 
The ROMs that our model is stored in consist of vertices and faces. 
Each face is three numbers that point to a vertex in the vertex ROM. 
That means we first need to fetch the face entry and then use its contents to fetch each vertex to build the entire triangle.</p>
<p>The vertex data itself is in 16.16 fixed point. 
This is the format used through most of the pipeline.</p>
<p>This is all done in the <code class ="language-lucid" data-lang="lucid"><span>model_provider</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> model_provider </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> draw</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> idle</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> triangle</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> color</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span style="color:#ed4343;">) {
</span><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">State </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WAIT_FACE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">GV1</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">GV2</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">GV3</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">GV4</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WAIT</span><span style="color:#ed4343;">}
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        suzanne_face_rom face
</span><span>        suzanne_vert_rom vert
</span><span>        
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">State</span><span style="color:#ed4343;">)]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> face_addr</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$clog2</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">FaceRom</span><span>.</span><span style="color:#d45ada;">FACES</span><span style="color:#ed4343;">)]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> c</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        vert.addr </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        face.addr </span><span style="color:#ed4343;">=</span><span> face_addr.q
</span><span>        
</span><span>        color </span><span style="color:#ed4343;">=</span><span> c.q
</span><span>        triangle </span><span style="color:#ed4343;">=</span><span> t.q
</span><span>        valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0   
</span><span>        
</span><span>        idle </span><span style="color:#ed4343;">=</span><span> state.q </span><span style="color:#ed4343;">== </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span><span>                face_addr.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>draw</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT_FACE
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT_FACE</span><span style="color:#ed4343;">:
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV1
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV1</span><span style="color:#ed4343;">:
</span><span>                vert.addr </span><span style="color:#ed4343;">=</span><span> face.face</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV2
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV2</span><span style="color:#ed4343;">:
</span><span>                vert.addr </span><span style="color:#ed4343;">=</span><span> face.face</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>                t.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> vert.vert
</span><span>                c.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> vert.color
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV3
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV3</span><span style="color:#ed4343;">:
</span><span>                vert.addr </span><span style="color:#ed4343;">=</span><span> face.face</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>                t.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> vert.vert
</span><span>                c.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> vert.color
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV4
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GV4</span><span style="color:#ed4343;">:
</span><span>                t.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> vert.vert
</span><span>                c.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> vert.color
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>stall</span><span style="color:#ed4343;">) {
</span><span>                    valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>face_addr.q </span><span style="color:#ed4343;">== </span><span style="color:#da5a8c;">FaceRom</span><span>.</span><span style="color:#d45ada;">FACES</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">) {
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT_FACE
</span><span>                        face_addr.d </span><span style="color:#ed4343;">=</span><span> face_addr.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>This module is an FSM that waits for a draw command, fetches a face, fetches each vertex, and then waits for the pipeline to not be stalled.</p>
<p>This is as good a time as any to talk about stalling and back pressure.</p>
<p>This GPU is architected as a pipeline. 
That means that there are many stages that work separately and concurrently from one another with each feeding into the next. 
This architecture allows as much work to be done on each clock cycle as possible, but it has one big caveat. 
Each stage in the pipeline doesn’t take the same amount of time to complete.</p>
<p>For example, it is way faster to fetch a triangle from the ROMs than it is to rasterize it pixel by pixel.</p>
<p>To compensate for this, we need our pipeline to support back pressure. 
This means that later stages can stall previous stages until they are ready for more data. 
This back pressure needs to flow back up through the entire pipeline to prevent lost data.</p>
<p>So when the <code class ="language-lucid" data-lang="lucid"><span>stall</span></code> signal is <code class ="language-lucid" data-lang="lucid"><span style="color:#a269dc;">1</span></code>, we <em>must</em> wait to output the face and move onto the next one.</p>
<p>It’s worth noting that each vertex has its own color. 
Currently, only the first color is used for the entire triangle, but without too much extra work, each vertex color could be blended across the triangle.</p>
<p>These two stages are packed into the <code class ="language-lucid" data-lang="lucid"><span>model_drawer</span></code> module. 
This module is kind of like the client of our GPU. 
It makes the requests of what to draw.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> model_drawer </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> draw</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> busy</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> m</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> color</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> model_matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">State </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">GEN_MAT</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">DRAW</span><span style="color:#ed4343;">}
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            model_provider model
</span><span>            matrix_generator mat_gen
</span><span>            
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">State</span><span style="color:#ed4343;">)]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        m </span><span style="color:#ed4343;">=</span><span> model.triangle
</span><span>        color </span><span style="color:#ed4343;">=</span><span> model.color
</span><span>        model_matrix </span><span style="color:#ed4343;">=</span><span> matrix.q
</span><span>        valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        busy </span><span style="color:#ed4343;">=</span><span> state.q </span><span style="color:#ed4343;">!= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>        
</span><span>        mat_gen.stall </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>        model.draw </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        model.stall </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>draw</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GEN_MAT
</span><span>                    model.draw </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">GEN_MAT</span><span style="color:#ed4343;">:
</span><span>                mat_gen.stall </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>mat_gen.valid</span><span style="color:#ed4343;">) {
</span><span>                    matrix.d </span><span style="color:#ed4343;">=</span><span> mat_gen.matrix
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">DRAW
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">DRAW</span><span style="color:#ed4343;">:
</span><span>                model.stall </span><span style="color:#ed4343;">=</span><span> stall
</span><span>                valid </span><span style="color:#ed4343;">=</span><span> model.valid
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>model.idle</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>                </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<h2 id="stage-3-transformation">Stage 3 - Transformation</h2>
<p>The next stage in the pipeline is the model transformation. 
This stage takes the triangle and multiplies each coordinate by the model matrix.</p>
<p>This is done in the <code class ="language-lucid" data-lang="lucid"><span>model_transform</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> model_transform </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> m</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> color_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> model_matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> color_out</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> draw</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> busy
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">State </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">P1</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">P2</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">P3</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">P4</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">P5</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">P6</span><span style="color:#ed4343;">}
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">State</span><span style="color:#ed4343;">)] 
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> products</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> matrix</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> pt</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> opt</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> tri</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> model</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> color</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        t </span><span style="color:#ed4343;">=</span><span> tri.q
</span><span>        color_out </span><span style="color:#ed4343;">=</span><span> color.q
</span><span>        valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        
</span><span>        busy </span><span style="color:#ed4343;">=</span><span> state.q </span><span style="color:#ed4343;">!= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>        
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">,</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">48</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>matrix.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>pt.q.x</span><span style="color:#ed4343;">)
</span><span>            products.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            tmp </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>matrix.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>pt.q.y</span><span style="color:#ed4343;">)
</span><span>            products.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            tmp </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>matrix.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>pt.q.z</span><span style="color:#ed4343;">)
</span><span>            products.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        opt.d.x </span><span style="color:#ed4343;">=</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] +</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] + c{</span><span>matrix.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">], </span><span style="color:#a269dc;">16b0</span><span style="color:#ed4343;">}
</span><span>        opt.d.y </span><span style="color:#ed4343;">=</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] +</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] + c{</span><span>matrix.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">], </span><span style="color:#a269dc;">16b0</span><span style="color:#ed4343;">}
</span><span>        opt.d.z </span><span style="color:#ed4343;">=</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] +</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> products.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] + c{</span><span>matrix.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">], </span><span style="color:#a269dc;">16b0</span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>draw</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P1
</span><span>                    matrix.d </span><span style="color:#ed4343;">=</span><span> model_matrix
</span><span>                    model.d </span><span style="color:#ed4343;">=</span><span> m
</span><span>                    pt.d </span><span style="color:#ed4343;">=</span><span> m</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>                    color.d </span><span style="color:#ed4343;">=</span><span> color_in
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P1</span><span style="color:#ed4343;">:
</span><span>                pt.d </span><span style="color:#ed4343;">=</span><span> model.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P2
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P2</span><span style="color:#ed4343;">:
</span><span>                pt.d </span><span style="color:#ed4343;">=</span><span> model.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P3
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P3</span><span style="color:#ed4343;">:
</span><span>                tri.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> opt.q
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P4
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P4</span><span style="color:#ed4343;">:
</span><span>                tri.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> opt.q
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P5
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P5</span><span style="color:#ed4343;">:
</span><span>                tri.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> opt.q
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P6
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">P6</span><span style="color:#ed4343;">:
</span><span>                valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>stall</span><span style="color:#ed4343;">)
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>        </span><span style="color:#ed4343;">}
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>When a triangle is fed into the module, each vertex is multiplied by the model matrix. 
This is done in three steps, assign the <code class ="language-lucid" data-lang="lucid"><span>pt</span></code> <code class ="language-lucid" data-lang="lucid"><span style="color:#0a8dbf;">dff</span></code> the vertex values, calculate the intermediate products of the multiplication, 
and finally sum them into the next vertex in <code class ="language-lucid" data-lang="lucid"><span>opt</span></code>.</p>
<p>Note that the <em>W</em> coordinate of the matrix is added directly with the products since the <em>W</em> coordinate of each vertex is implicitly 1 and can skip being multiplied by 1.
It is also shifted 16 bits to the left to convert the 10.0 fixed point format to 10.16 which can be added to the other 16.16 values.</p>
<p>The first three cycles of the FSM feed the values into the pipe, and the next three catch the results as they come out. 
Once all three vertices have been transformed, it attempts to output the new triangle.</p>
<p>Note that color data is passed in and out of this module, but nothing is done to it. 
This is done just to ensure that the color data associated with this triangle stays with this triangle.</p>
<h2 id="stage-4-shader">Stage 4 - Shader</h2>
<p>The shader is responsible for calculating the color of each vertex.
In our case, this means calculating the cosine of the angle between a vector perpendicular to the triangle and the light source.
Then using this value to apply a shadow to the triangle.</p>
<p>This is done in the <code class ="language-lucid" data-lang="lucid"><span>shader</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> shader </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> color_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> in_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> stalled</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> out_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> color_out</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> t_out</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> valid_pipe</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            cross_product cross
</span><span>            dot_product nn_dot
</span><span>            dot_product nl_dot
</span><span>            
</span><span>            fifo color_fifo</span><span style="color:#ed4343;">(#</span><span style="color:#d45ada;">ENTRIES</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">), #</span><span style="color:#d45ada;">WIDTH</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">))
</span><span>            fifo tri_fifo</span><span style="color:#ed4343;">(#</span><span style="color:#d45ada;">ENTRIES</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">), #</span><span style="color:#d45ada;">WIDTH</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">))
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> tri_reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> color_reg</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> u</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> v</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> frac</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> color</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> pipe_stalled
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> light</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>    
</span><span>    sqrt_calc sqrt</span><span style="color:#ed4343;">(</span><span>.aclk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">))
</span><span>    div_gen_16_16 div</span><span style="color:#ed4343;">(</span><span>.aclk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">))
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        light.x </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">LIGHT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        light.y </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">LIGHT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        light.z </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">LIGHT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        color_fifo.rget </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        color_fifo.wput </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        color_fifo.din </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        
</span><span>        tri_fifo.wput </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        tri_fifo.din </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        tri_fifo.rget </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">,</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {
</span><span>            t_out</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.z </span><span style="color:#ed4343;">=</span><span> tri_reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span>i</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>            t_out</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">=</span><span> tri_reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span>i</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>            t_out</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">=</span><span> tri_reg.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">*</span><span>i</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        color_out </span><span style="color:#ed4343;">=</span><span> color.q
</span><span>        out_valid </span><span style="color:#ed4343;">=</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> stall
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 8 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            tri_fifo.rget </span><span style="color:#ed4343;">=</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] =</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>            tri_reg.d </span><span style="color:#ed4343;">=</span><span> tri_fifo.dout
</span><span>            
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {
</span><span>                </span><span style="color:#0a8dbf;">sig</span><span> r</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">] =</span><span> color_reg.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">11</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">]
</span><span>                </span><span style="color:#0a8dbf;">sig</span><span> g</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">] =</span><span> color_reg.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]
</span><span>                </span><span style="color:#0a8dbf;">sig</span><span> b</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">] =</span><span> color_reg.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">]
</span><span>                
</span><span>                </span><span style="color:#0a8dbf;">sig</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">22</span><span style="color:#ed4343;">] =</span><span> r </span><span style="color:#ed4343;">*</span><span> frac.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>                r </span><span style="color:#ed4343;">=</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">]
</span><span>                
</span><span>                tmp </span><span style="color:#ed4343;">=</span><span> g </span><span style="color:#ed4343;">*</span><span> frac.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>                g </span><span style="color:#ed4343;">=</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]
</span><span>                
</span><span>                tmp </span><span style="color:#ed4343;">=</span><span> b </span><span style="color:#ed4343;">*</span><span> frac.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>                b </span><span style="color:#ed4343;">=</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">]
</span><span>                
</span><span>                color.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">] = c{</span><span>r</span><span style="color:#ed4343;">,</span><span>g</span><span style="color:#ed4343;">,</span><span>b</span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 7 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            color_fifo.rget </span><span style="color:#ed4343;">=</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            color_reg.d </span><span style="color:#ed4343;">=</span><span> color_fifo.dout
</span><span>            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            frac.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> frac.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 6 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        div.m_axis_dout_tready </span><span style="color:#ed4343;">= !</span><span>pipe_stalled
</span><span>            
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> quotient</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">] =</span><span> div.m_axis_dout_tdata</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">21</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> fractinal</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">] =</span><span> div.m_axis_dout_tdata</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span>quotient</span><span style="color:#ed4343;">) + </span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span>fractinal</span><span style="color:#ed4343;">) - </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>quotient </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">)
</span><span>            result </span><span style="color:#ed4343;">= c{</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">x{</span><span>fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]},</span><span>fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]}
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">else if </span><span style="color:#ed4343;">(</span><span>quotient</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">])
</span><span>            result </span><span style="color:#ed4343;">= -c{-</span><span>quotient</span><span style="color:#ed4343;">, -</span><span>fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]}
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">else
</span><span>            result </span><span style="color:#ed4343;">= c{</span><span>quotient</span><span style="color:#ed4343;">,</span><span> fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]}
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> div.m_axis_dout_tvalid
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>result</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]) {
</span><span>                frac.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">8h40 </span><span style="color:#969696;">// 0.5 minimum
</span><span>            </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{                         
</span><span>                frac.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">] + </span><span style="color:#a269dc;">8h40 </span><span style="color:#969696;">// 1.7 fixed point between 0.5 and 1
</span><span>            </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 5 */
</span><span>        div.s_axis_dividend_tvalid </span><span style="color:#ed4343;">=</span><span> sqrt.m_axis_dout_tvalid
</span><span>        div.s_axis_divisor_tvalid </span><span style="color:#ed4343;">=</span><span> sqrt.m_axis_dout_tvalid
</span><span>        div.s_axis_dividend_tdata </span><span style="color:#ed4343;">=</span><span> sqrt.m_axis_dout_tuser   </span><span style="color:#969696;">// normal and light dot product
</span><span>        div.s_axis_divisor_tdata </span><span style="color:#ed4343;">=</span><span> sqrt.m_axis_dout_tdata    </span><span style="color:#969696;">// normal vector magnitued
</span><span>        sqrt.m_axis_dout_tready </span><span style="color:#ed4343;">=</span><span> div.s_axis_dividend_tready </span><span style="color:#ed4343;">&amp;</span><span> div.s_axis_divisor_tready
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 4 */
</span><span>        sqrt.s_axis_cartesian_tvalid </span><span style="color:#ed4343;">=</span><span> nn_dot.out_valid
</span><span>        sqrt.s_axis_cartesian_tuser </span><span style="color:#ed4343;">=</span><span> nl_dot.dot</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        sqrt.s_axis_cartesian_tdata </span><span style="color:#ed4343;">=</span><span> nn_dot.dot</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">]
</span><span>        pipe_stalled </span><span style="color:#ed4343;">= !</span><span>sqrt.s_axis_cartesian_tready
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 3 */
</span><span>        nn_dot.in_valid </span><span style="color:#ed4343;">=</span><span> cross.out_valid
</span><span>        nn_dot.u </span><span style="color:#ed4343;">=</span><span> cross.ucv
</span><span>        nn_dot.v </span><span style="color:#ed4343;">=</span><span> cross.ucv
</span><span>        nn_dot.stall </span><span style="color:#ed4343;">=</span><span> pipe_stalled
</span><span>        
</span><span>        nl_dot.in_valid </span><span style="color:#ed4343;">=</span><span> cross.out_valid
</span><span>        nl_dot.u </span><span style="color:#ed4343;">=</span><span> cross.ucv
</span><span>        nl_dot.v </span><span style="color:#ed4343;">=</span><span> light
</span><span>        nl_dot.stall </span><span style="color:#ed4343;">=</span><span> pipe_stalled
</span><span>        
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> nn_dot.stalled
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 2 */
</span><span>        cross.in_valid </span><span style="color:#ed4343;">=</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        cross.stall </span><span style="color:#ed4343;">=</span><span> pipe_stalled
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> cross.stalled
</span><span>        
</span><span>        cross.u </span><span style="color:#ed4343;">=</span><span> u.q
</span><span>        cross.v </span><span style="color:#ed4343;">=</span><span> v.q
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 1 */
</span><span>        </span><span style="color:#969696;">// calculate u and v
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> in_valid
</span><span>            
</span><span>            u.d.x </span><span style="color:#ed4343;">=</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            u.d.y </span><span style="color:#ed4343;">=</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            u.d.z </span><span style="color:#ed4343;">=</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.z </span><span style="color:#ed4343;">-</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.z
</span><span>            
</span><span>            v.d.x </span><span style="color:#ed4343;">=</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            v.d.y </span><span style="color:#ed4343;">=</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            v.d.z </span><span style="color:#ed4343;">=</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.z </span><span style="color:#ed4343;">-</span><span> t_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.z
</span><span>            
</span><span>            color_fifo.din </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$flatten</span><span style="color:#ed4343;">(</span><span>color_in</span><span style="color:#ed4343;">)
</span><span>            color_fifo.wput </span><span style="color:#ed4343;">=</span><span> in_valid
</span><span>            
</span><span>            tri_fifo.din </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$flatten</span><span style="color:#ed4343;">(</span><span>t_in</span><span style="color:#ed4343;">)
</span><span>            tri_fifo.wput </span><span style="color:#ed4343;">=</span><span> in_valid
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>color_fifo.full </span><span style="color:#ed4343;">||</span><span> tri_fifo.full</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">)
</span><span>                valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">0
</span><span>            color_fifo.wput </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>            tri_fifo.wput </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>            pipe_stalled </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>The module starts by calculating the cross-product of two edges of the triangle.
This results in a vector that is perpendicular (aka <em>normal</em>) to the triangle. </p>
<p>Dot products are then calculated between the normal vector and itself and the normal vector and light vector.
A dot product calculates the cosine between two vectors multiplied by their magnitudes.</p>
<p>The dot product of the normal vector and itself is the magnitude of the normal vector squared.
We can take the square-root of this using another CORDIC module.</p>
<p>If we then divide the dot product of the normal and light vectors by the magnitude of the normal vector, we get just
the cosine of the angle between the normal and the light vector.
This is because the light vector magnitude is defined to be 1, so we don't need to divide it out.</p>
<p>The cosine value is then clipped to be between 0.5 and 1.
By setting a minimum we make sure that even triangles facing away from the light source still have some color to them.</p>
<p>We multiply the vertices' colors by this fraction and output them as the new colors.</p>
<h2 id="stage-5-projector">Stage 5 - Projector</h2>
<p>The projector stage is responsible for taking the 3D vertices and projecting them onto the 2D screenspace.</p>
<p>This is done in the <code class ="language-lucid" data-lang="lucid"><span>projector</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> projector </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> p</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> in_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> out_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> dr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">], </span><span style="color:#969696;">// 1/((y1-y2)(x0-x2) + (x2-x1)(y0-y2)) in 8.24 FP
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> ready
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">State </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">X</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">Y</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">Z</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R1</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R2</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R3</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">R4</span><span style="color:#ed4343;">}
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">State</span><span style="color:#ed4343;">)]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> a</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> b</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> c</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mul</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> dp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p4d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> pt_ct</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> op</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> odr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> out_ready
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    div_gen_0 divider</span><span style="color:#ed4343;">(</span><span>.aclk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">))
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>stall</span><span style="color:#ed4343;">)
</span><span>            out_ready.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        out_valid </span><span style="color:#ed4343;">=</span><span> out_ready.q
</span><span>        dr </span><span style="color:#ed4343;">=</span><span> odr.q
</span><span>        p </span><span style="color:#ed4343;">=</span><span> op.q
</span><span>        
</span><span>        divider.s_axis_divisor_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        divider.s_axis_divisor_tuser </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        divider.s_axis_divisor_tdata </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        
</span><span>        divider.s_axis_dividend_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        divider.s_axis_dividend_tdata </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> quotient</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] =</span><span> divider.m_axis_dout_tdata</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">50</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">19</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> fractinal</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">19</span><span style="color:#ed4343;">] =</span><span> divider.m_axis_dout_tdata</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">18</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span>quotient</span><span style="color:#ed4343;">) + </span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span>fractinal</span><span style="color:#ed4343;">) - </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>quotient </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">)
</span><span>            result </span><span style="color:#ed4343;">= c{</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">x{</span><span>fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]},</span><span>fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]}
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">else if </span><span style="color:#ed4343;">(</span><span>quotient</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">])
</span><span>            result </span><span style="color:#ed4343;">= -c{-</span><span>quotient</span><span style="color:#ed4343;">, -</span><span>fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]}
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">else
</span><span>            result </span><span style="color:#ed4343;">= c{</span><span>quotient</span><span style="color:#ed4343;">,</span><span> fractinal</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]}
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>divider.m_axis_dout_tvalid</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>divider.m_axis_dout_tuser</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]) {
</span><span>                </span><span style="color:#a269dc;">2d0</span><span style="color:#ed4343;">:
</span><span>                    op.d</span><span style="color:#ed4343;">[</span><span>divider.m_axis_dout_tuser</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]]</span><span>.x </span><span style="color:#ed4343;">=</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>                </span><span style="color:#a269dc;">2d1</span><span style="color:#ed4343;">:
</span><span>                    op.d</span><span style="color:#ed4343;">[</span><span>divider.m_axis_dout_tuser</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]]</span><span>.y </span><span style="color:#ed4343;">=</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>                </span><span style="color:#a269dc;">2d2</span><span style="color:#ed4343;">:
</span><span>                    op.d</span><span style="color:#ed4343;">[</span><span>divider.m_axis_dout_tuser</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]]</span><span>.z </span><span style="color:#ed4343;">=</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>                </span><span style="color:#a269dc;">2d3</span><span style="color:#ed4343;">:
</span><span>                    odr.d </span><span style="color:#ed4343;">=</span><span> result</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>                    out_ready.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>            </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        ready </span><span style="color:#ed4343;">=</span><span> state.q </span><span style="color:#ed4343;">== </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>        
</span><span>        divider.m_axis_dout_tready </span><span style="color:#ed4343;">= !</span><span>stall
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">sig</span><span> div_ready </span><span style="color:#ed4343;">=</span><span> divider.s_axis_dividend_tready </span><span style="color:#ed4343;">&amp;&amp;</span><span> divider.s_axis_divisor_tready
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>in_valid</span><span style="color:#ed4343;">) {
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">,</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {
</span><span>                        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>t</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">PROJ_MAT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">])
</span><span>                        dp.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">=</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">18</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">35</span><span style="color:#ed4343;">]
</span><span>                        tmp </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>t</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">PROJ_MAT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">])
</span><span>                        dp.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">=</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">18</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">35</span><span style="color:#ed4343;">]
</span><span>                        tmp </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>t</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.z</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">PROJ_MAT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">])
</span><span>                        dp.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.z </span><span style="color:#ed4343;">=</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">35</span><span style="color:#ed4343;">] + </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">PROJ_MAT</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">])
</span><span>                        dp.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.w </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.z
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">X
</span><span>                </span><span style="color:#ed4343;">}
</span><span>                pt_ct.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">X</span><span style="color:#ed4343;">:
</span><span>                divider.s_axis_divisor_tuser </span><span style="color:#ed4343;">= c{</span><span>pt_ct.q</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">2d0</span><span style="color:#ed4343;">}
</span><span>                divider.s_axis_dividend_tdata </span><span style="color:#ed4343;">=</span><span> dp.q</span><span style="color:#ed4343;">[</span><span>pt_ct.q</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#969696;">// top number
</span><span>                divider.s_axis_divisor_tdata </span><span style="color:#ed4343;">=</span><span> dp.q</span><span style="color:#ed4343;">[</span><span>pt_ct.q</span><span style="color:#ed4343;">]</span><span>.w  </span><span style="color:#969696;">// bottom number
</span><span>                
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>div_ready</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">Y
</span><span>                    divider.s_axis_dividend_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    divider.s_axis_divisor_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">Y</span><span style="color:#ed4343;">:
</span><span>                divider.s_axis_divisor_tuser </span><span style="color:#ed4343;">= c{</span><span>pt_ct.q</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">2d1</span><span style="color:#ed4343;">}
</span><span>                divider.s_axis_dividend_tdata </span><span style="color:#ed4343;">=</span><span> dp.q</span><span style="color:#ed4343;">[</span><span>pt_ct.q</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#969696;">// top number
</span><span>                divider.s_axis_divisor_tdata </span><span style="color:#ed4343;">=</span><span> dp.q</span><span style="color:#ed4343;">[</span><span>pt_ct.q</span><span style="color:#ed4343;">]</span><span>.w  </span><span style="color:#969696;">// bottom number
</span><span>                
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>div_ready</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">Z
</span><span>                    divider.s_axis_dividend_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    divider.s_axis_divisor_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">Z</span><span style="color:#ed4343;">:
</span><span>                divider.s_axis_divisor_tuser </span><span style="color:#ed4343;">= c{</span><span>pt_ct.q</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">2d2</span><span style="color:#ed4343;">}
</span><span>                divider.s_axis_dividend_tdata </span><span style="color:#ed4343;">=</span><span> dp.q</span><span style="color:#ed4343;">[</span><span>pt_ct.q</span><span style="color:#ed4343;">]</span><span>.z </span><span style="color:#969696;">// top number
</span><span>                divider.s_axis_divisor_tdata </span><span style="color:#ed4343;">=</span><span> dp.q</span><span style="color:#ed4343;">[</span><span>pt_ct.q</span><span style="color:#ed4343;">]</span><span>.w  </span><span style="color:#969696;">// bottom number
</span><span>                
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>div_ready</span><span style="color:#ed4343;">) {
</span><span>                    divider.s_axis_dividend_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    divider.s_axis_divisor_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    
</span><span>                    pt_ct.d </span><span style="color:#ed4343;">=</span><span> pt_ct.q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>pt_ct.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">) {
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R1
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">X
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R1</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>divider.m_axis_dout_tvalid </span><span style="color:#ed4343;">&amp;&amp; (</span><span>divider.m_axis_dout_tuser</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] == </span><span style="color:#a269dc;">4b1010</span><span style="color:#ed4343;">))
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R2
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R2</span><span style="color:#ed4343;">:
</span><span>                a.d </span><span style="color:#ed4343;">=</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y
</span><span>                b.d </span><span style="color:#ed4343;">=</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x
</span><span>                c.d </span><span style="color:#ed4343;">=</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.x
</span><span>                d.d </span><span style="color:#ed4343;">=</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> op.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R3
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R3</span><span style="color:#ed4343;">:
</span><span>                mul.d </span><span style="color:#ed4343;">= (</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>a.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>b.q</span><span style="color:#ed4343;">)) + (</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>c.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>d.q</span><span style="color:#ed4343;">))
</span><span>                state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R4
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">R4</span><span style="color:#ed4343;">:
</span><span>                divider.s_axis_divisor_tuser </span><span style="color:#ed4343;">= c{</span><span style="color:#a269dc;">2b11</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">2b11</span><span style="color:#ed4343;">}
</span><span>                divider.s_axis_dividend_tdata </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">32h01000000 </span><span style="color:#969696;">// 1 in 8.24
</span><span>                divider.s_axis_divisor_tdata </span><span style="color:#ed4343;">=</span><span> mul.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">18</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]  </span><span style="color:#969696;">// bottom number
</span><span>                
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>div_ready</span><span style="color:#ed4343;">) {
</span><span>                    divider.s_axis_dividend_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    divider.s_axis_divisor_tvalid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>                </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>This module takes some shortcuts by making assumptions about the projection matrix.
It assumes that only values (0,0), (1,1), (2,2), and (2,3) hold meaningful data, (3,3) is 1, and everything else is 0.</p>
<p>Most values being 0 means we can save a lot of multiplications.</p>
<p>The projection matrix defined in <code class ="language-lucid" data-lang="lucid"><span>geometry_definitions</span></code> is for a frustum projection with z-clipping at 100-1000.</p>
<pre data-linenos data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="language-lucid" data-lang="lucid"><table><tbody><tr><td>36</td><td><span>    </span><span style="color:#969696;">// Z-Clip is 100 to 1000
</span></td></tr><tr><td>37</td><td><span>    </span><span style="color:#969696;">// reverse is used so that it can be typed in normal notaion and [0][0] is the top left
</span></td></tr><tr><td>38</td><td><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">PROJ_MAT </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$reverse</span><span style="color:#ed4343;">({
</span></td></tr><tr><td>39</td><td><span>            </span><span style="color:#1bddaf;">$reverse</span><span style="color:#ed4343;">({</span><span style="color:#a269dc;">32h06000000</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">}),
</span></td></tr><tr><td>40</td><td><span>            </span><span style="color:#1bddaf;">$reverse</span><span style="color:#ed4343;">({</span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32h06000000</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">}),
</span></td></tr><tr><td>41</td><td><span>            </span><span style="color:#1bddaf;">$reverse</span><span style="color:#ed4343;">({</span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d80100</span><span style="color:#ed4343;">, </span><span style="color:#1bddaf;">$resize</span><span style="color:#ed4343;">(-</span><span style="color:#a269dc;">32d14563556</span><span style="color:#ed4343;">,</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">)}),
</span></td></tr><tr><td>42</td><td><span>            </span><span style="color:#1bddaf;">$reverse</span><span style="color:#ed4343;">({</span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">FP1616_1</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32d0</span><span style="color:#ed4343;">})
</span></td></tr><tr><td>43</td><td><span>        </span><span style="color:#ed4343;">})
</span></td></tr></tbody></table></code></pre>
<p>After the vertex is multiplied by this matrix, we need to normalize it so that the <em>W</em> component is 1.
This is how we end up scaling X and Y based on the Z value.
The matrix is set up so that the W value <em>is</em> the original Z value.</p>
<p>The <code class ="language-lucid" data-lang="lucid"><span style="color:#d45ada;">X</span></code>, <code class ="language-lucid" data-lang="lucid"><span style="color:#d45ada;">Y</span></code>, and <code class ="language-lucid" data-lang="lucid"><span style="color:#d45ada;">Z</span></code> states of the FSM use the divider to divide each value by <em>W</em>.
The same divider is used to save resources as this isn't typically the bottleneck for rendering.</p>
<p>Finally, the module calculates the determinant for the triangle.
This doesn't really logically fit in the projection module, but it needs a divider to do the calculation.
By putting it here, we can reuse the same divider again.</p>
<p>We will get to what this value is and how it is used in the <a href="https://alchitry.com/tutorials/projects/gpu/#stage-7-rasterizer">rasterizer</a>.</p>
<h2 id="stage-6-bounding-box">Stage 6 - Bounding Box</h2>
<p>The bounding box stage is relatively simple compared to what we've seen so far.
It takes in the triangle data and outputs the minimum bounding box that the rasterizer will need to scan over.</p>
<p>It takes into account the display resolution, so time isn't wasted looking at pixels off-screen.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> bounding_box </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> in_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> stalled</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> out_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> it</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> ot</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> max</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> min</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> valid_pipe
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> t_pipe</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> dmax</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> dmin</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">DISP_BOUNDS_X </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$fixed_point</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">DISP_H</span><span style="color:#ed4343;">/</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">)
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">DISP_BOUNDS_Y </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$fixed_point</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">DISP_V</span><span style="color:#ed4343;">/</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">)
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        ot </span><span style="color:#ed4343;">=</span><span> t_pipe.q
</span><span>        out_valid </span><span style="color:#ed4343;">=</span><span> valid_pipe.q
</span><span>        
</span><span>        stalled </span><span style="color:#ed4343;">=</span><span> stall </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>stall </span><span style="color:#ed4343;">|| !</span><span>valid_pipe.q</span><span style="color:#ed4343;">) {
</span><span>            valid_pipe.d </span><span style="color:#ed4343;">=</span><span> in_valid
</span><span>            t_pipe.d </span><span style="color:#ed4343;">=</span><span> it
</span><span>            
</span><span>            </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> maxy</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] =</span><span> it</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> maxx</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] =</span><span> it</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> miny</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] =</span><span> it</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> minx</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] =</span><span> it</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">) {
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>maxy</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y</span><span style="color:#ed4343;">))
</span><span>                    maxy </span><span style="color:#ed4343;">=</span><span> it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>maxx</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x</span><span style="color:#ed4343;">))
</span><span>                    maxx </span><span style="color:#ed4343;">=</span><span> it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>miny</span><span style="color:#ed4343;">) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y</span><span style="color:#ed4343;">))
</span><span>                    miny </span><span style="color:#ed4343;">=</span><span> it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.y
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>minx</span><span style="color:#ed4343;">) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x</span><span style="color:#ed4343;">))
</span><span>                    minx </span><span style="color:#ed4343;">=</span><span> it</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            </span><span style="color:#ed4343;">}
</span><span>            
</span><span>            </span><span style="color:#969696;">// clamp to display edges
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>maxx</span><span style="color:#ed4343;">) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">DISP_BOUNDS_X</span><span style="color:#ed4343;">))
</span><span>                maxx </span><span style="color:#ed4343;">= </span><span style="color:#d45ada;">DISP_BOUNDS_X
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>maxx</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(-</span><span style="color:#d45ada;">DISP_BOUNDS_X</span><span style="color:#ed4343;">))
</span><span>                maxx </span><span style="color:#ed4343;">= -</span><span style="color:#d45ada;">DISP_BOUNDS_X
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>minx</span><span style="color:#ed4343;">) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">DISP_BOUNDS_X</span><span style="color:#ed4343;">))
</span><span>                minx </span><span style="color:#ed4343;">= </span><span style="color:#d45ada;">DISP_BOUNDS_X
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>minx</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(-</span><span style="color:#d45ada;">DISP_BOUNDS_X</span><span style="color:#ed4343;">))
</span><span>                minx </span><span style="color:#ed4343;">= -</span><span style="color:#d45ada;">DISP_BOUNDS_X
</span><span>            
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>maxy</span><span style="color:#ed4343;">) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">DISP_BOUNDS_Y</span><span style="color:#ed4343;">))
</span><span>                maxy </span><span style="color:#ed4343;">= </span><span style="color:#d45ada;">DISP_BOUNDS_Y
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>maxy</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(-</span><span style="color:#d45ada;">DISP_BOUNDS_Y</span><span style="color:#ed4343;">))
</span><span>                maxy </span><span style="color:#ed4343;">= -</span><span style="color:#d45ada;">DISP_BOUNDS_Y
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>miny</span><span style="color:#ed4343;">) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">DISP_BOUNDS_Y</span><span style="color:#ed4343;">))
</span><span>                miny </span><span style="color:#ed4343;">= </span><span style="color:#d45ada;">DISP_BOUNDS_Y
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>miny</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(-</span><span style="color:#d45ada;">DISP_BOUNDS_Y</span><span style="color:#ed4343;">))
</span><span>                miny </span><span style="color:#ed4343;">= -</span><span style="color:#d45ada;">DISP_BOUNDS_Y
</span><span>            
</span><span>            dmax.d.x </span><span style="color:#ed4343;">=</span><span> maxx</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>            dmax.d.y </span><span style="color:#ed4343;">=</span><span> maxy</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>            dmin.d.x </span><span style="color:#ed4343;">=</span><span> minx</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>            dmin.d.y </span><span style="color:#ed4343;">=</span><span> miny</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">31</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        max </span><span style="color:#ed4343;">=</span><span> dmax.q
</span><span>        min </span><span style="color:#ed4343;">=</span><span> dmin.q
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<h2 id="stage-7-rasterizer">Stage 7 - Rasterizer</h2>
<p>The rasterizer is the heart of the whole pipeline.
This stage is responsible for figuring out what pixels belong to the triangle.</p>
<p>It takes in the triangle data (vertices, colors, determinant, and bounding box) and outputs the barycentric 
weights for every display address that is covered by the triangle.</p>
<p>This is done in the <code class ="language-lucid" data-lang="lucid"><span>rasterizer</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> rasterizer </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,    </span><span style="color:#969696;">// triangle points
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> dr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],         </span><span style="color:#969696;">// 1/((y1-y2)(x0-x2) + (x2-x1)(y0-y2)) in 8.24 FP
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> pt_min</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;,  </span><span style="color:#969696;">// top left corner of bounding box
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> pt_max</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;,  </span><span style="color:#969696;">// bottom right corner of bounding box
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> start</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> disp_addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">], </span><span style="color:#969696;">// address data
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> weights</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> z</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> idle
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> active
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> valid_pipe</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        barycentric_calc bary
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> min</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> max</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> triangle</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> denom</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> current_point</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> covered_point</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> covered
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> invY</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> dptx</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#0a8dbf;">sig</span><span> dpty</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        idle </span><span style="color:#ed4343;">= !</span><span>active.q </span><span style="color:#ed4343;">&amp;&amp; !</span><span>stall </span><span style="color:#ed4343;">&amp;&amp; (</span><span>valid_pipe.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">)
</span><span>        
</span><span>        bary.t </span><span style="color:#ed4343;">=</span><span> triangle.q
</span><span>        bary.dr </span><span style="color:#ed4343;">=</span><span> denom.q
</span><span>        bary.pt </span><span style="color:#ed4343;">=</span><span> current_point.q
</span><span>        bary.stall </span><span style="color:#ed4343;">=</span><span> stall
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>stall</span><span style="color:#ed4343;">) {
</span><span>            valid_pipe.d </span><span style="color:#ed4343;">= c{</span><span>valid_pipe.q</span><span style="color:#ed4343;">[-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">],</span><span> active.q</span><span style="color:#ed4343;">}
</span><span>            covered_point.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> current_point.q
</span><span>            covered_point.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> covered_point.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">5</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>active.q </span><span style="color:#ed4343;">&amp;&amp; (</span><span>valid_pipe.q </span><span style="color:#ed4343;">== </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">) &amp;&amp;</span><span> start</span><span style="color:#ed4343;">) {
</span><span>                active.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                max.d </span><span style="color:#ed4343;">=</span><span> pt_max
</span><span>                min.d </span><span style="color:#ed4343;">=</span><span> pt_min
</span><span>                triangle.d </span><span style="color:#ed4343;">=</span><span> t
</span><span>                denom.d </span><span style="color:#ed4343;">=</span><span> dr
</span><span>                current_point.d </span><span style="color:#ed4343;">=</span><span> pt_min
</span><span>            </span><span style="color:#ed4343;">}
</span><span>            
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>active.q</span><span style="color:#ed4343;">) {
</span><span>                current_point.d.x </span><span style="color:#ed4343;">=</span><span> current_point.q.x </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>current_point.q.x </span><span style="color:#ed4343;">==</span><span> max.q.x</span><span style="color:#ed4343;">) {
</span><span>                    current_point.d.x </span><span style="color:#ed4343;">=</span><span> min.q.x
</span><span>                    current_point.d.y </span><span style="color:#ed4343;">=</span><span> current_point.q.y </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>current_point.q.y </span><span style="color:#ed4343;">==</span><span> max.q.y</span><span style="color:#ed4343;">) {
</span><span>                        active.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        dptx </span><span style="color:#ed4343;">=</span><span> covered_point.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">+ (</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">DISP_H</span><span style="color:#ed4343;">/</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">)
</span><span>        dpty </span><span style="color:#ed4343;">=</span><span> covered_point.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">+ (</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">DISP_V</span><span style="color:#ed4343;">/</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">)
</span><span>        
</span><span>        invY </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">DISP_V </span><span style="color:#ed4343;">- </span><span style="color:#a269dc;">1 </span><span style="color:#ed4343;">-</span><span> dpty </span><span style="color:#969696;">// flip y so up is up
</span><span>        disp_addr </span><span style="color:#ed4343;">=</span><span> dptx </span><span style="color:#ed4343;">+</span><span> invY </span><span style="color:#ed4343;">* </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">DISP_H </span><span style="color:#969696;">// x + y * X_RES
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">)
</span><span>            z</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">] =</span><span> triangle.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]</span><span>.z
</span><span>        
</span><span>        covered </span><span style="color:#ed4343;">=</span><span> bary.covered
</span><span>        weights </span><span style="color:#ed4343;">=</span><span> bary.w
</span><span>        
</span><span>        valid </span><span style="color:#ed4343;">=</span><span> covered </span><span style="color:#ed4343;">&amp;&amp; !</span><span>stall </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">6</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>The core of the module lies in calculating the barycentric weights for each pixel.</p>
<p>This actually happens in a separate module, the <code class ="language-lucid" data-lang="lucid"><span>barycentric_calc</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="color:#969696;">/* 7-cycle latency */
</span><span style="font-weight:bold;color:#faac1f;">module</span><span> barycentric_calc </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p3d</span><span style="color:#ed4343;">&gt;,  </span><span style="color:#969696;">// triangle points
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> dr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],   </span><span style="color:#969696;">// 1/((y1-y2)(x0-x2) + (x2-x1)(y0-y2)) in 8.24 FP
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> pt</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Geo</span><span>.p2d</span><span style="color:#ed4343;">&gt;,   </span><span style="color:#969696;">// point to test
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> covered</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> w</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] </span><span style="color:#969696;">// weights in 8.24 FP
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> a</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> b</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> c</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> e</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> f</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> ara</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> arb</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> arc</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> ard</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mar</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mar1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mar2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> m1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> m2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> dp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> wp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mr1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mr2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mr3</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> mr4</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> wr1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> wr2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> wun1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> wun2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">dff</span><span> wun3</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> covered_pipe</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>stall</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#969696;">/* Cycle 1 */
</span><span>            a.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            b.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            c.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            d.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            e.d </span><span style="color:#ed4343;">= c{</span><span>pt.x</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">16b0</span><span style="color:#ed4343;">} -</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            f.d </span><span style="color:#ed4343;">= c{</span><span>pt.y</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">16b0</span><span style="color:#ed4343;">} -</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            dp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> dr
</span><span>            ara.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            arb.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            arc.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.x </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]</span><span>.x
</span><span>            ard.d </span><span style="color:#ed4343;">=</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span>.y </span><span style="color:#ed4343;">-</span><span> t</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]</span><span>.y
</span><span>            
</span><span>            </span><span style="color:#969696;">/* Cycle 2 */
</span><span>            mr1.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>a.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>e.q</span><span style="color:#ed4343;">)
</span><span>            mr2.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>b.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>f.q</span><span style="color:#ed4343;">)
</span><span>            mr3.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>c.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>e.q</span><span style="color:#ed4343;">)
</span><span>            mr4.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>d.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>f.q</span><span style="color:#ed4343;">)
</span><span>            dp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> dp.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            mar1.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>ara.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>arb.q</span><span style="color:#ed4343;">)
</span><span>            mar2.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>arc.q</span><span style="color:#ed4343;">) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>ard.q</span><span style="color:#ed4343;">)
</span><span>            
</span><span>            </span><span style="color:#969696;">/* Cycle 3 */
</span><span>            mr1.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> mr1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            mr2.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> mr2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            mr3.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> mr3.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            mr4.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> mr4.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            dp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> dp.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            mar1.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> mar1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            mar2.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> mar2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            </span><span style="color:#969696;">/* Cycle 4 */
</span><span>            m1.d </span><span style="color:#ed4343;">=</span><span> mr1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> mr2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            m2.d </span><span style="color:#ed4343;">=</span><span> mr3.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> mr4.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            dp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] =</span><span> dp.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>            mar.d </span><span style="color:#ed4343;">=</span><span> mar1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> mar2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            </span><span style="color:#969696;">/* Cycle 5 */
</span><span>            wun1.d </span><span style="color:#ed4343;">=</span><span> m1.q
</span><span>            wun2.d </span><span style="color:#ed4343;">=</span><span> m2.q
</span><span>            wun3.d </span><span style="color:#ed4343;">=</span><span> mar.q </span><span style="color:#ed4343;">-</span><span> m1.q </span><span style="color:#ed4343;">-</span><span> m2.q
</span><span>            
</span><span>            </span><span style="color:#0a8dbf;">sig</span><span> tmp1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">128</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>m1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>dp.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">])
</span><span>            </span><span style="color:#0a8dbf;">sig</span><span> tmp2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">128</span><span style="color:#ed4343;">] = </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>m2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]) * </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>dp.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">])
</span><span>            wr1.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> tmp1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] +</span><span> tmp1</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">48</span><span style="color:#ed4343;">]
</span><span>            wr2.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> tmp2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">] +</span><span> tmp2</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">48</span><span style="color:#ed4343;">]
</span><span>            
</span><span>            </span><span style="color:#969696;">/* Cycle 6 */
</span><span>            wr1.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> wr1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            wr2.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> wr2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>wun1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">63</span><span style="color:#ed4343;">] ||</span><span> wun2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">63</span><span style="color:#ed4343;">] ||</span><span> wun3.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">63</span><span style="color:#ed4343;">])
</span><span>                covered_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">0
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">else
</span><span>                covered_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">1
</span><span>            
</span><span>            </span><span style="color:#969696;">/* Cycle 7 */
</span><span>            wp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> wr1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            wp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> wr2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            wp.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">32h01000000 </span><span style="color:#ed4343;">-</span><span> wr1.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] -</span><span> wr2.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            covered_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> covered_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        w </span><span style="color:#ed4343;">=</span><span> wp.q
</span><span>        covered </span><span style="color:#ed4343;">=</span><span> covered_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>OK, so what are barycentric weights or coordinates?
Without diving into the math, they're a way to represent the location of any point relative to the vertices of the triangle.</p>
<p>Each point has three weights.
They correspond to the signed area of the triangle formed from that point and a pair of points on the triangle divided by the 
area of the main triangle.</p>
<p>If all three weights are positive, then the point lies inside the triangle.
If any of them are negative, then the point lies outside the triangle and can be ignored.</p>
<p>This is only one way to check if a point lines within a triangle, but it has some nice properties.</p>
<p>By definition, the three weights sum to 1.
They also have the nice property of allowing for linear interpolation between the three triangle points.</p>
<p>This is critical in the next stage, the Z-buffer, as we need the Z coordinate for each pixel.
We can use the three barycentric weights to interpolate the triangle's vertices' Z coordinates to get the pixel's coordinates.</p>
<p>It can also be used for more advanced GPU features that aren't implemented here, like smooth shading.
To do smooth shading, each vertex has its own normal vector, and the three vectors are interpolated across the triangle.</p>
<h2 id="stage-8-z-buffer">Stage 8 - Z-Buffer</h2>
<p>If we were just drawing one triangle, then we could skip this stage.
However, we need to account for when triangles overlap.
We can do this by keeping track of how far away each pixel is on screen.</p>
<p>If the pixel we are about to draw is closer than the one on screen, we draw our new pixel.
If not, we throw away our pixel.</p>
<p>This is done in the <code class ="language-lucid" data-lang="lucid"><span>z_buffer</span></code> module.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> z_buffer </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> addr_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> in_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> weights_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> z</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> color_in</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> stalled</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> stall</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> addr_out</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> out_valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> weights_out</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> color_out</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> mem_out</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Memory</span><span>.out</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> mem_in</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Memory</span><span>.in</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> flush_cache</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> frame</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span style="color:#ed4343;">) {
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">Z_MAX </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">32d16777216  </span><span style="color:#969696;">// 1
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">Z_MIN </span><span style="color:#ed4343;">= -</span><span style="color:#a269dc;">32d16777216 </span><span style="color:#969696;">// -1
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">const </span><span style="color:#d45ada;">PIPE_LENGTH </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">5
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">State </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WAIT_READ</span><span style="color:#ed4343;">}
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        lru_cache cache</span><span style="color:#ed4343;">(</span><span>.rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">))
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> valid_pipe</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> read_valid
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">State</span><span style="color:#ed4343;">)]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> m</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> weight_pipe</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> addr_pipe</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> color_pipe</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> wz</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> read_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        </span><span style="color:#0a8dbf;">sig</span><span> pipe_stalled </span><span style="color:#ed4343;">=</span><span> stall
</span><span>        
</span><span>        cache.mem_out </span><span style="color:#ed4343;">=</span><span> mem_out
</span><span>        mem_in </span><span style="color:#ed4343;">=</span><span> cache.mem_in
</span><span>        cache.flush </span><span style="color:#ed4343;">=</span><span> flush_cache
</span><span>        cache.wr_addr </span><span style="color:#ed4343;">=</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">] | </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">Z_BUFFER_MASK </span><span style="color:#ed4343;">| (</span><span>frame </span><span style="color:#ed4343;">&lt;&lt; (</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">FRAME_BITS</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">))
</span><span>        cache.wr_data </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">bx
</span><span>        cache.wr_valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        cache.rd_addr </span><span style="color:#ed4343;">=</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] | </span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">Z_BUFFER_MASK </span><span style="color:#ed4343;">| (</span><span>frame </span><span style="color:#ed4343;">&lt;&lt; (</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">FRAME_BITS</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">))
</span><span>        cache.rd_cmd_valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">b0
</span><span>        
</span><span>        addr_out </span><span style="color:#ed4343;">=</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] | (</span><span>frame </span><span style="color:#ed4343;">&lt;&lt; (</span><span style="color:#da5a8c;">Geo</span><span>.</span><span style="color:#d45ada;">FRAME_BITS</span><span style="color:#ed4343;">+</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">))
</span><span>        out_valid </span><span style="color:#ed4343;">=</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] &amp;&amp;</span><span> cache.wr_ready
</span><span>        weights_out </span><span style="color:#ed4343;">=</span><span> weight_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        color_out </span><span style="color:#ed4343;">=</span><span> color_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#d45ada;">PIPE_LENGTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 6 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">|| !</span><span>cache.wr_ready
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            cache.wr_valid </span><span style="color:#ed4343;">=</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>            cache.wr_data </span><span style="color:#ed4343;">=</span><span> wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 4 &amp; 5 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">)
</span><span>                    valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">0
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] &amp;&amp;</span><span> cache.rd_ready</span><span style="color:#ed4343;">) {
</span><span>                    cache.rd_cmd_valid </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    weight_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] =</span><span> weight_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>                    addr_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] =</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>                    color_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] =</span><span> color_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>                    wz.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT_READ
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WAIT_READ</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> cache.rd_data_valid</span><span style="color:#ed4343;">) {
</span><span>                    read_data.d </span><span style="color:#ed4343;">=</span><span> cache.rd_data
</span><span>                    read_valid.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="color:#ed4343;">}
</span><span>                
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>                    </span><span style="color:#0a8dbf;">sig</span><span> active </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                    </span><span style="color:#0abfbf;">signed </span><span style="color:#0a8dbf;">sig</span><span> comp_data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">bx
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>cache.rd_data_valid</span><span style="color:#ed4343;">) {
</span><span>                        active </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                        comp_data </span><span style="color:#ed4343;">=</span><span> cache.rd_data
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else if </span><span style="color:#ed4343;">(</span><span>read_valid.q</span><span style="color:#ed4343;">) {
</span><span>                        active </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                        comp_data </span><span style="color:#ed4343;">=</span><span> read_data.q
</span><span>                        read_valid.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                    
</span><span>                    valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">0
</span><span>                    
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>active</span><span style="color:#ed4343;">) {
</span><span>                        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>comp_data</span><span style="color:#ed4343;">) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">10</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]))
</span><span>                            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">0
</span><span>                        </span><span style="font-weight:bold;color:#0abfbf;">else
</span><span>                            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">1
</span><span>                        
</span><span>                        wz.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] =</span><span> wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>                        weight_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">] =</span><span> weight_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>                        addr_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">] =</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>                        color_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">] =</span><span> color_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        pipe_stalled </span><span style="color:#ed4343;">= (</span><span>state.q </span><span style="color:#ed4343;">!= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">) || !</span><span>cache.rd_ready
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 3 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">((</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]) &gt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">Z_MAX</span><span style="color:#ed4343;">)) || (</span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span>wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]) &lt; </span><span style="color:#1bddaf;">$signed</span><span style="color:#ed4343;">(</span><span style="color:#d45ada;">Z_MIN</span><span style="color:#ed4343;">))) </span><span style="color:#969696;">// only write if in bounds
</span><span>                valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">0
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">else
</span><span>                valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            weight_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> weight_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            color_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> color_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            addr_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] =</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>            wz.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> wz.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 2 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            addr_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> addr_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            color_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> color_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            weight_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> weight_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>            wz.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> m.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] +</span><span> m.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] +</span><span> m.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        </span><span style="color:#969696;">/* Cycle 1 */
</span><span>        pipe_stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled </span><span style="color:#ed4343;">&amp;&amp;</span><span> valid_pipe.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>pipe_stalled</span><span style="color:#ed4343;">) {
</span><span>            addr_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> addr_in
</span><span>            color_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> color_in
</span><span>            valid_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> in_valid
</span><span>            weight_pipe.d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> weights_in
</span><span>            </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">,</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">) {
</span><span>                </span><span style="color:#0a8dbf;">sig</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">64</span><span style="color:#ed4343;">] =</span><span> z</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">] *</span><span> weights_in</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]
</span><span>                m.d</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">] =</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">32</span><span style="color:#ed4343;">]
</span><span>            </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        
</span><span>        stalled </span><span style="color:#ed4343;">=</span><span> pipe_stalled
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>This module starts by calculating this pixel's Z value using the barycentric weights from the rasterizer and the 
triangle's Z values.
This is done using a weighted sum.</p>
<p>Once we have the Z value, we need to read the Z value from the Z-buffer.
The Z-buffer is stored in the DDR memory and has an entry for every pixel.</p>
<p>When a new frame is being prepared to be rendered, the buffer is filled with maximum distance at every pixel so any pixel will override it.</p>
<p>If a pixel is in front of the current z-buffer value, we output that pixel and its associated colors and barycentric weights.
We also need to write this pixel's Z value to the buffer so future pixels don't cover it unless they're in front.</p>
<p>Right now, the barycentric weights and two of the three vertex colors are ignored.
However, another module that interpolates the three colors with the weights could be added to allow blended colors on a single triangle.</p>
<p>The barycentric weights along with texture coordinates could be used to texture map the triangle.
If this was implemented, we would keep track of texture coordinates instead of color for each vertex.
At this stage, we would then interpolate the texture coordinates and use that to look up the color in the texture at that location.</p>
<p>As you can see, the barycentric weights provide a powerful tool beyond just calculating if a pixel is inside or outside the triangle.</p>
<h2 id="stage-9-write-buffer">Stage 9 - Write Buffer</h2>
<p>The last stage is writing the pixel to the framebuffer.</p>
<p>This isn't strictly part of the graphics pipeline, but since we are storing the framebuffer in the DDR memory we need to
spend a little effort in using it efficiently.</p>
<p>The DDR controller batches reads and writes in 128-bit chunks. 
Our values are only 16 bits wide, so we can batch eight of them to each memory access.</p>
<p>This is what the <code class ="language-lucid" data-lang="lucid"><span>write_buffer</span></code> does for us.</p>
<pre data-lang="lucid" style="background-color:#282828;color:#ffffff;" class="language-lucid "><code class ="short language-lucid" data-lang="lucid"><span style="font-weight:bold;color:#faac1f;">module</span><span> write_buffer </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// clock
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,  </span><span style="color:#969696;">// reset
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> data</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">],
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> valid</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> flush</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> ready</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> mem_out</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Memory</span><span>.out</span><span style="color:#ed4343;">&gt;,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> mem_in</span><span style="color:#ed4343;">&lt;</span><span style="color:#da5a8c;">Memory</span><span>.in</span><span style="color:#ed4343;">&gt;
</span><span style="color:#ed4343;">) {
</span><span>    
</span><span>    </span><span style="color:#0a8dbf;">enum </span><span style="color:#da5a8c;">State </span><span style="color:#ed4343;">{</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WRITE_DATA</span><span style="color:#ed4343;">, </span><span style="color:#d45ada;">WRITE_CMD</span><span style="color:#ed4343;">}
</span><span>    
</span><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">) {
</span><span>        .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> dirty</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">]
</span><span>            </span><span style="color:#0a8dbf;">dff</span><span> state</span><span style="color:#ed4343;">[</span><span style="color:#1bddaf;">$width</span><span style="color:#ed4343;">(</span><span style="color:#da5a8c;">State</span><span style="color:#ed4343;">)]
</span><span>        </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> buffer</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">][</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> address</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">25</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> tmp</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">16</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> new_addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">28</span><span style="color:#ed4343;">]
</span><span>        </span><span style="color:#0a8dbf;">dff</span><span> flushing
</span><span>    </span><span style="color:#ed4343;">}
</span><span>    
</span><span>    
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">{
</span><span>        mem_in.enable </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        mem_in.wr_data </span><span style="color:#ed4343;">= </span><span style="color:#1bddaf;">$flatten</span><span style="color:#ed4343;">(</span><span>buffer.q</span><span style="color:#ed4343;">)
</span><span>        mem_in.cmd </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        mem_in.addr </span><span style="color:#ed4343;">= c{</span><span>address.q</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">3b000</span><span style="color:#ed4343;">}
</span><span>        mem_in.wr_enable </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>        ready </span><span style="color:#ed4343;">=</span><span> state.q </span><span style="color:#ed4343;">== </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span>i</span><span style="color:#ed4343;">, </span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">)
</span><span>            mem_in.wr_mask</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">*</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">+:</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">] = </span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">x{~</span><span>dirty.q</span><span style="color:#ed4343;">[</span><span>i</span><span style="color:#ed4343;">]}
</span><span>        
</span><span>        </span><span style="font-weight:bold;color:#0abfbf;">case </span><span style="color:#ed4343;">(</span><span>state.q</span><span style="color:#ed4343;">) {
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE</span><span style="color:#ed4343;">:
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>flush </span><span style="color:#ed4343;">&amp;&amp; |</span><span>dirty.q</span><span style="color:#ed4343;">) {
</span><span>                    flushing.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    mem_in.wr_enable </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>mem_out.wr_rdy</span><span style="color:#ed4343;">) {
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_CMD
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span><span>                        state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_DATA
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                </span><span style="color:#ed4343;">}
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>valid</span><span style="color:#ed4343;">) {
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">27</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">] ==</span><span> address.q</span><span style="color:#ed4343;">) {
</span><span>                        buffer.d</span><span style="color:#ed4343;">[</span><span>addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]] =</span><span> data
</span><span>                        dirty.d</span><span style="color:#ed4343;">[</span><span>addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]] = </span><span style="color:#a269dc;">1
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else if </span><span style="color:#ed4343;">(|</span><span>dirty.q</span><span style="color:#ed4343;">) {
</span><span>                        tmp.d </span><span style="color:#ed4343;">=</span><span> data
</span><span>                        new_addr.d </span><span style="color:#ed4343;">=</span><span> addr
</span><span>                        
</span><span>                        flushing.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                        mem_in.wr_enable </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                        </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>mem_out.wr_rdy</span><span style="color:#ed4343;">) {
</span><span>                            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_CMD
</span><span>                        </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span><span>                            state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_DATA
</span><span>                        </span><span style="color:#ed4343;">}
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span><span>                        buffer.d</span><span style="color:#ed4343;">[</span><span>addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]] =</span><span> data
</span><span>                        dirty.d</span><span style="color:#ed4343;">[</span><span>addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]] = </span><span style="color:#a269dc;">1
</span><span>                        address.d </span><span style="color:#ed4343;">=</span><span> addr</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">27</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_DATA</span><span style="color:#ed4343;">:
</span><span>                mem_in.wr_enable </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>mem_out.wr_rdy</span><span style="color:#ed4343;">) {
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_CMD
</span><span>                </span><span style="color:#ed4343;">}
</span><span>            
</span><span>            </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">WRITE_CMD</span><span style="color:#ed4343;">:
</span><span>                mem_in.enable </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1
</span><span>                </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>mem_out.rdy</span><span style="color:#ed4343;">) {
</span><span>                    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>flushing.q</span><span style="color:#ed4343;">) {
</span><span>                        buffer.d</span><span style="color:#ed4343;">[</span><span>new_addr.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]] =</span><span> tmp.q
</span><span>                        dirty.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8b1 </span><span style="color:#ed4343;">&lt;&lt;</span><span> new_addr.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">2</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]
</span><span>                        address.d </span><span style="color:#ed4343;">=</span><span> new_addr.q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">27</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">]
</span><span>                    </span><span style="color:#ed4343;">} </span><span style="font-weight:bold;color:#0abfbf;">else </span><span style="color:#ed4343;">{
</span><span>                        dirty.d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">0
</span><span>                    </span><span style="color:#ed4343;">}
</span><span>                    state.d </span><span style="color:#ed4343;">= </span><span style="color:#da5a8c;">State</span><span>.</span><span style="color:#d45ada;">IDLE
</span><span>                </span><span style="color:#ed4343;">}
</span><span>        </span><span style="color:#ed4343;">}
</span><span>    </span><span style="color:#ed4343;">}
</span><span style="color:#ed4343;">}
</span></code></pre>
<p>This module allows individual 16-bit values to be written arbitrarily to memory locations and only writes them out
when the next value doesn't reside in the same chunk.</p>
<p>It also keeps track of which pieces of the chunk have been written to so it can mask out the unwritten sections.
This prevents the need for it to read the current value when doing a partial write.</p>
<p>Since the stage before this is the rasterizer that checks each pixel in order, most of the writes will be sequential.
That means we will take advantage of batching writes under most conditions.</p>
<p>Once a full frame has been rendered, it is flipped and streamed over the HDMI port of the Hd.
The old dirty frame is cleaned up and the process starts again.</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        
        <a class="next" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;clock-clock&#x2F;">
            <span class="title">Next »</span>
            <br>
            <span>Clock Clock</span>
        </a>
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2026 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"><path d="M440-320h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168Zm40 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            let codeText = '';

            // 1. Check if the codeblock contains a table (Line Numbers present)
            const tableRows = codeblock.querySelectorAll('table tr');

            if (tableRows.length > 0) {
                const lines = [];
                tableRows.forEach(row => {
                    // The actual code is in the last TD
                    const codeCell = row.lastElementChild;
                    if (codeCell) {
                        let cellText = codeCell.textContent;

                        if (cellText.endsWith('\n')) {
                            cellText = cellText.slice(0, -1);
                        }

                        lines.push(cellText);
                    }
                });
                codeText = lines.join('\n');
            } else {
                // 2. No table, use standard text extraction
                codeText = codeblock.textContent;
            }

            // 3. Copy the cleaned text to clipboard
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeText);
                copyingDone();
                return;
            }

            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
                console.error('Copy failed', e);
            }
            document.body.removeChild(textArea);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
<script type="module" src="https://alchitry.com/table-toggles.js"></script>
    
</body>
</html>
