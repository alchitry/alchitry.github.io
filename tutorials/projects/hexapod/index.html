<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Hexapod</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;hexapod&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
</script>
<script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
</script>

<link rel="stylesheet" href="https://alchitry.com/styles.css">
<link rel="stylesheet" href="https://alchitry.com/override.css">

<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;">Tutorials</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;">Projects</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;hexapod&#x2F;">Hexapod</a>
            </div>
            
        </div>
        <h1 class="post-title">Hexapod</h1>
        
        
        <div class="post-meta">
            













14 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/tutorials&#x2F;projects&#x2F;hexapod.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#example-designs" aria-label="Example Designs">Example Designs</a>
                    
                </li>
                
                <li>
                    <a href="#more-images" aria-label="More Images">More Images</a>
                    
                </li>
                
                <li>
                    <a href="#blob-tracking" aria-label="Blob Tracking">Blob Tracking</a>
                    
                    <ul>
                    
                        <li>
                            <a href="#overview" aria-label="Overview">Overview</a>
                            
                        </li>
                    
                        <li>
                            <a href="#interfacing-with-the-camera" aria-label="Interfacing with the camera">Interfacing with the camera</a>
                            
                        </li>
                    
                        <li>
                            <a href="#color-conversion" aria-label="Color conversion">Color conversion</a>
                            
                        </li>
                    
                        <li>
                            <a href="#finding-runs" aria-label="Finding runs">Finding runs</a>
                            
                        </li>
                    
                        <li>
                            <a href="#blob-detection" aria-label="Blob detection">Blob detection</a>
                            
                        </li>
                    
                        <li>
                            <a href="#arduino-code" aria-label="Arduino code">Arduino code</a>
                            
                        </li>
                    
                    </ul>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p><img src="https://cdn.alchitry.com/projects/hexapod/DSC_0166.resized.jpg" alt="DSC_0166.resized.jpg" /></p>
<p>This hexapod is fully controlled by a single Mojo leveraging the power that an FPGA provides. It consists of an aluminum frame (purchased from MicroMagic Systems which no longer seems to exist), 20 servo motors (12x HS-645MG, 7x HS-225MG, 1x HS-322HD), a Mojo V3 with an SDRAM Shield, Servo Shield, and a custom camera shield. The camera used is an OV2640. </p>
<h3 id="example-designs">Example Designs</h3>
<p><a href="http://cdn.embeddedmicro.com/hexapod/Mojo-Hexapod-Arduino.zip"><strong>Arduino Project</strong></a> - The following FPGA projects assume that this project is loaded onto the ATmega32U4. The microcontroller is responsible for calculating the angles of the legs for the FPGA.</p>
<p><a href="http://cdn.embeddedmicro.com/hexapod/Mojo-Hexapod-Capture.zip"><strong>Image Capture</strong></a> - This design will take a snapshot from the camera and store it in SDRAM. The image can then be read out to your computer through the ATmega32U4. I used a simple Java program to do this. The Eclipse project is below.</p>
<p><a href="http://cdn.embeddedmicro.com/hexapod/ImageCapture.zip"><strong>Image Capture Java Program</strong></a> - This is the Eclipse project for a simple Java program that will interface with the Mojo to capture and show an image. The image can then be saved as a PNG.</p>
<p><a href="http://cdn.embeddedmicro.com/hexapod/Mojo-Hexapod-Blob.zip"><strong>Blob Tracking</strong></a> - This design uses the camera to detect red blobs. The color of the blob can be set in the <strong>color_threshold.v</strong> file. For more information see below.</p>
<h3 id="more-images">More Images</h3>
<p><img src="https://cdn.alchitry.com/projects/hexapod/DSC_0198.resized_large.jpg" alt="DSC_0198.resized_large.jpg" /></p>
<p><img src="https://cdn.alchitry.com/projects/hexapod/DSC_0144.resized_large.jpg" alt="DSC_0144.resized_large.jpg" /></p>
<p><img src="https://cdn.alchitry.com/projects/hexapod/DSC_0181.resized_dfaaaf80-fad4-4e2e-b9df-42009b1c83f5_large.jpg" alt="DSC_0181.resized_dfaaaf80-fad4-4e2e-b9df-42009b1c83f5_large.jpg" /></p>
<p><img src="https://cdn.alchitry.com/projects/hexapod/DSC_0172.resized_large.jpg" alt="DSC_0172.resized_large.jpg" /></p>
<h2 id="blob-tracking">Blob Tracking</h2>
<div class="video-container">
    <iframe class="video" src="https://www.youtube.com/embed/KxeSHZFrkOw?si=FpYJ0RTmOG-YkKYP"
            title="YouTube video player" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>
<p>You can download the complete FPGA project and Arduino project below.</p>
<ul>
<li><a href="http://cdn.embeddedmicro.com/hexapod/Mojo-Hexapod-Blob.zip">FPGA Project</a></li>
<li><a href="http://cdn.embeddedmicro.com/hexapod/Mojo-Hexapod-Arduino.zip">Arduino Project</a></li>
</ul>
<h3 id="overview">Overview</h3>
<p>The flow of this design is as follows.</p>
<ol>
<li>The camera is configured to output 1600x1200 images at its full 15 FPS.</li>
<li>The camera starts streaming frames to the FPGA</li>
<li>Each pixel is converted from RGB to HSV (<strong>H</strong>ue <strong>S</strong>aturation <strong>V</strong>alue)
<ol>
<li>The HSV value is compared to some preset values to determine if the pixel is a <em>red</em> pixel</li>
<li><em>Red</em> pixels are converted into a 1 while non-red are converted into a 0</li>
</ol>
</li>
<li>In each row, groups of red pixels are joined together to form <strong>runs</strong>
<ol>
<li>A run consists of the starting and ending indices of the group</li>
</ol>
</li>
<li>Each run is compared to the previous row's runs
<ol>
<li>If the runs overlap then the new run takes on the label of the overlapping run</li>
<li>The associated object properties are updated including bounding box, center of mass, and mass (number of pixels)</li>
</ol>
</li>
<li>If the new run has already been labeled, but overlaps with another run of a different label, the two objects are joined
<ol>
<li>The second object becomes a pointer to the first and their properties are merged</li>
<li>Any updates to the now invalid object are redirected</li>
</ol>
</li>
<li>If an object has not been updated after an entire row, it is considered to be finished
<ol>
<li>Finished objects are written to SDRAM if their mass is greater than a preset size</li>
</ol>
</li>
<li>Once a frame has finished processing, a pin connecting to the microcontroller is pulled high
<ol>
<li>The microcontroller reads the objects from the SDRAM through the FPGA using SPI and picks the largest one</li>
<li>It calculates new angles for all the servos so that the robot will look towards the object</li>
<li>The new servo values are sent back to the FPGA to update the PWM signals</li>
</ol>
</li>
</ol>
<h3 id="interfacing-with-the-camera">Interfacing with the camera</h3>
<p>The camera used in this project is the OV2640. This is a decent camera for the price, but that's assuming you can get it configured properly.</p>
<p>The datasheet for this camera leaves a lot to be desired. The actual recommended configuration is completely missing. However, after visiting the <em>second</em> page of a Google search, I was able to find a C header that defined various configurations for the camera used in the Linux kernel. I took the header and modified it a bit to make a C program that would print out text that could be used in a Verilog ROM. You can download the source for that program <a href="http://cdn.embeddedmicro.com/hexapod/ov2640reg.zip">here</a>.</p>
<p>In that program you can set the resolution and format you want, but unfortunately, even at lower resolutions you still only get 15 FPS since that driver simply sets the camera up to scale the images instead of changing the mode.</p>
<p>Take a look at the <strong>ov2640_reg.v</strong> file to see the register configuration. The first value in each entry is the address while the second value is the actual value. Don't ask me what these values do because I have no idea. Most of them are marked <em>Reserved</em> in the datasheets I've seen, but this configuration works.</p>
<p>Note that if you change the ROM make sure to update the <strong>REG_COUNT</strong> localparam in <strong>ov2640.v</strong> to reflect the number of entries.</p>
<p>Take a look now at the <strong>ov2640.v</strong> file. This is the actual interface to the camera. There are two important possibly unusual pieces of code here.</p>
<pre data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><span style="color:#969696;">// This is used to drive the camera clock
</span><span style="color:#fac863;">ODDR2 </span><span style="font-weight:bold;color:#0abfbf;">#</span><span style="color:#ed4343;">(
</span><span>    .DDR_ALIGNMENT</span><span style="color:#ed4343;">(</span><span style="color:#77bf0a;">&quot;NONE&quot;</span><span style="color:#ed4343;">),
</span><span>    .INIT</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">),
</span><span>    .SRTYPE</span><span style="color:#ed4343;">(</span><span style="color:#77bf0a;">&quot;SYNC&quot;</span><span style="color:#ed4343;">)
</span><span>  </span><span style="color:#ed4343;">)</span><span> ODDR2_inst </span><span style="color:#ed4343;">(
</span><span>    .Q</span><span style="color:#ed4343;">(</span><span>xclk</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit DDR output data
</span><span>    .C0</span><span style="color:#ed4343;">(</span><span>cam_clk</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit clock input
</span><span>    .C1</span><span style="color:#ed4343;">(~</span><span>cam_clk</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit clock input
</span><span>    .CE</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit clock enable input
</span><span>    .D0</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit data input (associated with C0)
</span><span>    .D1</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit data input (associated with C1)
</span><span>    .R</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// 1-bit reset input
</span><span>    .S</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">) </span><span style="color:#969696;">// 1-bit set input
</span><span>  </span><span style="color:#ed4343;">);
</span></code></pre>
<p>This is used to drive the clock signal xclk out to the camera. In the FPGA clock signals can't be routed like data signals so you have to use an <strong>ODDR</strong> (<strong>O</strong>utput <strong>D</strong>ouble <strong>D</strong>ata <strong>R</strong>ate) block. Typically these blocks are used to output data on the rising and falling edges of a clock (hence <em>double</em> data rate). However, here we fix the data as 1 and 0 so that it toggles with the clock. This same trick was used with the <a href="https://alchitry.com/tutorials/archive/lucid_v1/mojo/sdram/">SDRAM controller</a>.</p>
<p>The clock <strong>xclk</strong> is generated in <strong>mojo_top.v</strong> by the module <strong>sdram_clk_gen</strong>. This module was generated using <a href="https://alchitry.com/tutorials/archive/verilog/mojo/using-core-generator/">CoreGen</a>  and it takes the 50MHz clock from the on board crystal and generates a 100MHz clock and a 20MHz clock. The 100MHz clock is used as the general system clock as well as the clock for the SDRAM (hence the name of the module). The 20MHz clock is only used to feed the camera and is actually not used for anything else.</p>
<p>The second piece of possibly new code is used because the camera outputs data with its own internal clock. The camera takes that 20MHz clock and boosts it to around 30MHz and uses that to output data. That means the FPGA can't simply clock data in using its internal clock because of possible <a href="https://alchitry.com/tutorials/archive/verilog/mojo/metastability-and-debouncing/">meta-stability problems</a>.</p>
<pre data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><span>camera_fifo camera_fifo </span><span style="color:#ed4343;">(
</span><span>    .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// input rst
</span><span>    .wr_clk</span><span style="color:#ed4343;">(</span><span>pclk</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// input wr_clk
</span><span>    .rd_clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// input rd_clk
</span><span>    .din</span><span style="color:#ed4343;">({</span><span>vsync</span><span style="color:#ed4343;">,</span><span>href</span><span style="color:#ed4343;">,</span><span>data</span><span style="color:#ed4343;">}), </span><span style="color:#969696;">// input [9 : 0] din
</span><span>    .wr_en</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// input wr_en
</span><span>    .rd_en</span><span style="color:#ed4343;">(</span><span>rd_en</span><span style="color:#ed4343;">), </span><span style="color:#969696;">// input rd_en
</span><span>    .dout</span><span style="color:#ed4343;">({</span><span>vsync_fifo</span><span style="color:#ed4343;">,</span><span>href_fifo</span><span style="color:#ed4343;">,</span><span>data_fifo</span><span style="color:#ed4343;">}), </span><span style="color:#969696;">// output [9 : 0] dout
</span><span>    .full</span><span style="color:#ed4343;">(), </span><span style="color:#969696;">// output full
</span><span>    .empty</span><span style="color:#ed4343;">(</span><span>empty</span><span style="color:#ed4343;">) </span><span style="color:#969696;">// output empty
</span><span>  </span><span style="color:#ed4343;">);
</span></code></pre>
<p>To prevent any clocking problems, a dual clock <strong>FIFO</strong> (<strong>F</strong>irst <strong>I</strong>n <strong>F</strong>irst <strong>O</strong>ut) buffer is used. This module was also generated using CoreGen.</p>
<p>A FIFO buffer as two ports, an input and and output. Data goes into the FIFO through the <strong>din</strong> input and is added to the buffer every time <strong>wr_clk</strong> rises. The <strong>empty</strong> signal goes low where there is data in the buffer. To data can then come out of <strong>dout</strong> in the order that it was written to <strong>din</strong> but this time the data is clocked with <strong>rd_clk</strong> instead of <strong>wr_clk</strong>. This makes FIFOs an excellent tool for crossing clock domains.</p>
<p>It's important to note that you need to read the data from the FIFO at least as fast as you write it (on average) so that the buffer does not overflow. In this case the read clock is 100MHz while the write clock is only 30MHz so that isn't a problem.</p>
<p>The rest of this module is pretty straight forward. It simply takes the signals from the camera and outputs signals for the end of each frame and line as well as each new pixel.</p>
<h3 id="color-conversion">Color conversion</h3>
<p>The data output from the camera is in <strong>RGB565</strong> (5 bits <strong>R</strong>ed, 6 bits <strong>G</strong>reen, 5 bits <strong>B</strong>lue) format. However, we want to cover this to <strong>HSV</strong> since that will make it easier to tell what color the pixel is. This is done in the <strong>rgb_to_hsv.v</strong> file. This module is based on <a href="http://web.mit.edu/6.111/www/f2011/tools/rgb2hsv.v">this module</a> from MIT. The divider modules are generated again by CoreGen.</p>
<p>The dividers have a latency of 18 clock cycles so the total module has a latency of 19 clock cycles! However, it is fully pipelined so that it can accept a new value every clock cycle. In this case we don't really care about latency too much since it just delays the data by minuscule amount with no chance of dropping any data.</p>
<p>The <strong>color_threshold.v</strong> file holds the code that converts the HSV value to a 0 or 1 depending on its color. Line 52 is where you would change the values if you wanted to track a different color.</p>
<pre data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><span style="font-weight:bold;color:#0abfbf;">assign</span><span> pixel </span><span style="color:#ed4343;">= (</span><span>h </span><span style="color:#ed4343;">&lt; </span><span style="color:#a269dc;">5 </span><span style="color:#ed4343;">||</span><span> h </span><span style="color:#ed4343;">&gt; </span><span style="color:#a269dc;">245</span><span style="color:#ed4343;">) &amp;&amp;</span><span> s </span><span style="color:#ed4343;">&gt; </span><span style="color:#a269dc;">115 </span><span style="color:#ed4343;">&amp;&amp;</span><span> s </span><span style="color:#ed4343;">&lt; </span><span style="color:#a269dc;">210 </span><span style="color:#ed4343;">&amp;&amp;</span><span> v </span><span style="color:#ed4343;">&gt; </span><span style="color:#a269dc;">30</span><span style="color:#ed4343;">;
</span></code></pre>
<p>The <strong>pipeline</strong> module you see being used all over the place is simply a parameterizable module that consists of a bunch of flip-flops chained together. It will simply delay the data by <strong>LENGTH</strong> number of clock cycles. This is useful when you have some data you want to keep paired up with other data that is being processed.</p>
<h3 id="finding-runs">Finding runs</h3>
<p>The <strong>run_finder</strong> module in <strong>run_finder.v</strong> is responsible for taking the binary pixels from <strong>color_threshold</strong> and grouping them into runs. This is a fairly straightforward task with a few edge cases. If a run is still going when the end of a row happens, the run must be finished and output.</p>
<p>The runs from <strong>run_finder</strong> may not be able to be processed immediately by the blob detector so they are buffered by a FIFO in <strong>run_fifo_manager.v</strong>. The format of the runs is slightly changed so that they are easier to handle in blob detector. Each entry in the FIFO is either a new run, the end of a line, or end of the frame.</p>
<p>Since it is possible that an end of line/frame happens at the same time as a new pixel, the module is setup to write new pixels first, then end of lines, and finally end of frames.</p>
<h3 id="blob-detection">Blob detection</h3>
<p>This is where the real magic happens. The file <strong>blob_detector.v</strong> is where a stream of runs are converted into objects.</p>
<p>The blob detection algorithm is based on <a href="http://www.electronics.dit.ie/staff/aschwarzbacher/research/mpc08-1Blob.pdf">this article</a> with a few modifications. This paper is worth reading if you are interested in how this actually works. It's important to have a firm understanding of what is happening before diving into the code.</p>
<p>The basics of what happens is that each new run is compared to a list of runs from the previous row. Each previous run has a label that points into a RAM that temporarily stores the objects being processed. If a new unlabeled run overlaps with a run in the previous row, that run gets the label of the previous run and the object is updated in the RAM to include the new run. If the run is already labeled but overlaps with a run of a different label, the two objects are joined together in the object RAM and the second object is set to point at the first object. That way if any runs overlap with rows that belong to the now invalid object, they can be redirected to the valid merged object. If a run does not overlap with any other runs, it is assumed to be a new object and space is allocated in the object RAM.</p>
<p>To keep track of used and unused objects in the object RAM, two linked lists are maintained. Initially, each entry in the RAM is setup as an unused object and is set to point to the next object. When a new object is created it takes the first element in the list and adds it to the used object list. These linked lists are maintained so that it is easy to keep track of where an unused object is as well as iterate over all the used objects.</p>
<p>After a row is finished, each object in the used object list is marked as <strong>not-updated</strong>. After the next row, each object is checked to see if it was marked <strong>updated</strong>. If it was, it is simply marked <strong>not-updated</strong> again. However, if the object was not updated, that means that that object will never be updated again and should be removed from the RAM to make space for more objects.</p>
<p>When this happens, the unused and used object lists are updated. If the removed object is larger than the <strong>MIN_SIZE</strong> parameter, then it is written to SDRAM.</p>
<p>Once an end of frame is detected, all the valid objects still in the object RAM are flushed out and written to SDRAM if they are large enough. Finally the number of total objects output is written to the SDRAM and the module signals it has finished.</p>
<h3 id="arduino-code">Arduino code</h3>
<p>The microcontroller simply waits for the FPGA to signal that new data exists by pulling one of the shared pins high. There are four pins that can be used for anything. These are called the <strong>flag</strong> pins in this design. Only the first of the four is used.</p>
<p>Once the microcontroller knows that data is ready, it uses the SPI interface that connects it to the FPGA to read that data that is in the SDRAM. The actually details of how this happens will be covered in another tutorial. However, you can take a look at the <strong>fpga_interface</strong> file for the functions used. It basically works by memory mapping some functions in the FPGA and allowing them to be read and written over SPI. One of these functions is reading and writing to the SDRAM. The microcontroller tell the FPGA the address it wants to read and the result shows up in four other registers (since it has a 32 bit interface that equals 4 bytes) that can then be read.</p>
<p>First the number of objects is read. Then for each object it's size/mass is read and if the mass is larger than the previously seen largest object, the rest of the object properties are read.</p>
<p>Finally once all the objects have been read, only the largest objects data is actually kept. This is used to calculate a new position for the servos.</p>
<p>In between samples from the FPGA, the servos are moved smoothly to the last known target. This allows the robot to move smoother than would normally allow, given 15 frames per second from the camera.</p>
<p>The values calculated for the servos are written to the FPGA over SPI using the same memory mapped design. The module <strong>reg_ctrl.v</strong> shows the actual memory mapping used.</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        <a class="prev" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;projects&#x2F;clock-clock&#x2F;">
            <span class="title">« Prev</span>
            <br>
            <span>Clock Clock</span>
        </a>
        
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2026 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"><path d="M440-320h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168Zm40 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            let codeText = '';

            // 1. Check if the codeblock contains a table (Line Numbers present)
            const tableRows = codeblock.querySelectorAll('table tr');

            if (tableRows.length > 0) {
                const lines = [];
                tableRows.forEach(row => {
                    // The actual code is in the last TD
                    const codeCell = row.lastElementChild;
                    if (codeCell) {
                        let cellText = codeCell.textContent;

                        if (cellText.endsWith('\n')) {
                            cellText = cellText.slice(0, -1);
                        }

                        lines.push(cellText);
                    }
                });
                codeText = lines.join('\n');
            } else {
                // 2. No table, use standard text extraction
                codeText = codeblock.textContent;
            }

            // 3. Copy the cleaned text to clipboard
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeText);
                copyingDone();
                return;
            }

            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
                console.error('Copy failed', e);
            }
            document.body.removeChild(textArea);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
<script type="module" src="https://alchitry.com/table-toggles.js"></script>
    
</body>
</html>
