<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Metastability and Debouncing</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;metastability-and-debouncing&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
</script>
<script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
</script>

<link rel="stylesheet" href="https://alchitry.com/styles.css">
<link rel="stylesheet" href="https://alchitry.com/override.css">

<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;">Tutorials</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;">Archive</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;">Verilog</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;">Mojo</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;metastability-and-debouncing&#x2F;">Metastability and Debouncing</a>
            </div>
            
        </div>
        <h1 class="post-title">Metastability and Debouncing</h1>
        
        
        <div class="post-meta">
            













5 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;metastability-and-debouncing.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#metastability" aria-label="Metastability">Metastability</a>
                    
                </li>
                
                <li>
                    <a href="#debouncing" aria-label="Debouncing">Debouncing</a>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p>In this tutorial we will cover some of the pit falls that can happen when having asynchronous inputs to the Mojo. The more general case is <strong>metastability</strong>, but we will also cover <strong>debouncing</strong> of buttons. These are both important if you want to reliably detect when a button is being pressed or interface with anything that is not synchronized to the Mojo's clock.</p>
<h2 id="metastability">Metastability</h2>
<p>To understand metastability, you first need a little background on the timing requirements of the <a href="https://alchitry.com/tutorials/archive/verilog/mojo/synchronous-logic/">flip-flop</a>. As we discussed before, a flip-flop will copy the value at the <strong>D</strong> side to the <strong>Q</strong> side at the positive edge of the clock and hold the value steady until the next positive edge. What we didn't  cover was what is known as the <strong>setup</strong> and <strong>hold</strong> timing constraints.</p>
<p>This tutorial will not go into too much detail on what causes these constraints and what their actual values are. All that is important right now, is to know that the <strong>setup</strong> constraint tells you how long before the positive edge of the clock the value on the <strong>D</strong> side must be stable. The <strong>hold</strong> time tells you how long after the positive edge of the clock the <strong>D</strong> side must continue to be stable. </p>
<p>Here is a diagram illustrating this.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/metastability.png" alt="metastability.png" /></p>
<p>The areas that <strong>D</strong> needs to be constant are shaded in grey on the clock. As you can see the <strong>setup</strong> time specifies the time before the rising edge and the <strong>hold</strong> time is the time after the rising edge.</p>
<p>The <strong>D</strong> and the <strong>Q</strong> signals under the clock are an example of what could happen. The first two rising edges are valid since during the setup and hold time <strong>D</strong> is constant. For the last edge <strong>D</strong> changes when it shouldn't so the value of <strong>Q</strong> becomes unknown.</p>
<p><strong>Q</strong> may take a random value of 0 or 1, however, that is the <em>best</em> case. There is also a possibility that <strong>Q</strong> will get stuck somewhere between 0 and 1 (0.5?!?), or worse yet it may oscillate, flipping between 0 and 1 very rapidly. </p>
<p>As you may have guessed you don't want any of that to happen. Bad things will happen and your circuit will do unexpected things. </p>
<p>There are two solutions to this problem.</p>
<p>First, you can just design your circuit so this never happens! This is exactly what the tools (ISE) does for you when you map your design. If it can't meet timing for some reason you'll get <strong>timing errors</strong>. If you are just running the Mojo at 50MHz, you probably won't encounter these unless you do multiple multiplications between flip flops or some other complicated computational logic. This will be covered more in later tutorials.</p>
<p>As you may have realized, sometimes you can't control when a signal will change. For this tutorial we are using a button. It's impossible for us to guarantee that the button won't be pressed and violate the setup and hold constraints. </p>
<p>The second solution is to then use not one but two flip-flops! </p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/metastability-dualff.png" alt="metastability-dualff.png" /></p>
<p>This will add a small amount of latency to your input signal, but it significantly reduces the chance that you will encounter metastability problems. This is the solution we will use to read the button reliably.</p>
<p>It is important to note that this does not <em>solve</em> the metastability problem and there is still a small chance you could have problems. However, using two flip-flops drastically reduces that chance. If you are really worried about a certain input, you can chain more flip-flops together for a smaller chance of stability issues. However, there are diminishing returns and two will be plenty for most cases.</p>
<h2 id="debouncing">Debouncing</h2>
<p>When you press a button, there is a chance that the button will not simply go from open to closed. Since a button is a mechanical device the contacts can <strong>bounce</strong>. When a button bounces the value it produces looks something like this.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/bouncing.png" alt="bouncing.png" /></p>
<p>For a short period after the button is pressed the value you read from an IO pin may toggle between 0 and 1 a few times before settling on the actual value. This is where <strong>debouncing</strong> comes into play.</p>
<p>To debounce a button, you just need to require that for a button to register as being pressed, it must <em>look</em> like it's being pressed for a set amount of time. In this case, being <em>pressed</em> is when the value of the button is 1. If you read enough 1's in a row it is safe to assume that the button has stopped bouncing and you can register one button press.</p>
<p>If you fail to do this and you are using the button to increment a counter, then the counter may increase by more than 1 per button press since it will appear that each bounce was a separate press.</p>
<pre data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><span style="font-weight:bold;color:#faac1f;">module</span><span> button_conditioner </span><span style="color:#ed4343;">(
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> btn</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> out
</span><span>  </span><span style="color:#ed4343;">);
</span><span> 
</span><span>  </span><span style="color:#0a8dbf;">reg </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">19</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> ctr_d</span><span style="color:#ed4343;">,</span><span> ctr_q</span><span style="color:#ed4343;">;
</span><span>  </span><span style="color:#0a8dbf;">reg </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> sync_d</span><span style="color:#ed4343;">,</span><span> sync_q</span><span style="color:#ed4343;">;
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">assign</span><span> out </span><span style="color:#ed4343;">=</span><span> ctr_q </span><span style="color:#ed4343;">== {</span><span style="color:#a269dc;">20</span><span style="color:#ed4343;">{</span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">}};
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">@(*) </span><span style="font-weight:bold;color:#0abfbf;">begin
</span><span>    sync_d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">] =</span><span> btn</span><span style="color:#ed4343;">;
</span><span>    sync_d</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">] =</span><span> sync_q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">];
</span><span>    ctr_d </span><span style="color:#ed4343;">=</span><span> ctr_q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">;
</span><span> 
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>ctr_q </span><span style="color:#ed4343;">== {</span><span style="color:#a269dc;">20</span><span style="color:#ed4343;">{</span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">}}) </span><span style="font-weight:bold;color:#0abfbf;">begin
</span><span>      ctr_d </span><span style="color:#ed4343;">=</span><span> ctr_q</span><span style="color:#ed4343;">;
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">end
</span><span> 
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(!</span><span>sync_q</span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">])
</span><span>      ctr_d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">20&#39;d0</span><span style="color:#ed4343;">;
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">@(</span><span style="font-weight:bold;color:#0abfbf;">posedge</span><span> clk</span><span style="color:#ed4343;">) </span><span style="font-weight:bold;color:#0abfbf;">begin
</span><span>    ctr_q </span><span style="color:#ed4343;">&lt;=</span><span> ctr_d</span><span style="color:#ed4343;">;
</span><span>    sync_q </span><span style="color:#ed4343;">&lt;=</span><span> sync_d</span><span style="color:#ed4343;">;
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span><span> 
</span><span style="font-weight:bold;color:#faac1f;">endmodule
</span></code></pre>
<p>Here is a simple module that takes a button press and passes it through two flip-flops to prevent stability issues. With the synchronized signal, a counter is incremented when the button is pressed and reset when it is 0. The counter will saturate at it's max value. Once it hit's the max value it is safe to say the the button has been pressed and the output is set to 1.</p>
<p>By using the <strong>button_conditioner</strong> module you can be sure that you will be able to reliably read button presses.</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        <a class="prev" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;external-io&#x2F;">
            <span class="title">« Prev</span>
            <br>
            <span>External IO</span>
        </a>
        
        
        <a class="next" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;fpga-timing&#x2F;">
            <span class="title">Next »</span>
            <br>
            <span>FPGA Timing</span>
        </a>
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2026 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"><path d="M440-320h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168Zm40 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            let codeText = '';

            // 1. Check if the codeblock contains a table (Line Numbers present)
            const tableRows = codeblock.querySelectorAll('table tr');

            if (tableRows.length > 0) {
                const lines = [];
                tableRows.forEach(row => {
                    // The actual code is in the last TD
                    const codeCell = row.lastElementChild;
                    if (codeCell) {
                        let cellText = codeCell.textContent;

                        if (cellText.endsWith('\n')) {
                            cellText = cellText.slice(0, -1);
                        }

                        lines.push(cellText);
                    }
                });
                codeText = lines.join('\n');
            } else {
                // 2. No table, use standard text extraction
                codeText = codeblock.textContent;
            }

            // 3. Copy the cleaned text to clipboard
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeText);
                copyingDone();
                return;
            }

            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
                console.error('Copy failed', e);
            }
            document.body.removeChild(textArea);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
<script type="module" src="https://alchitry.com/table-toggles.js"></script>
    
</body>
</html>
