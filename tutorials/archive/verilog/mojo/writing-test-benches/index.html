<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
    
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Writing Test Benches</title>


<meta name="keywords" content="keyword1, keyword2, keyword3">



<meta name="description" content="">



<meta name="author" content="Justin Rajewski">


<link rel="canonical" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;writing-test-benches&#x2F;">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Ubuntu:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
    {
      "imports": {
        "@material/web/": "https://esm.run/@material/web/"
      }
    }
</script>
<script type="module">
    import '@material/web/all.js';
    import {styles as typescaleStyles} from '@material/web/typography/md-typescale-styles.js';

    document.adoptedStyleSheets.push(typescaleStyles.styleSheet);
</script>

<link rel="stylesheet" href="https://alchitry.com/styles.css">
<link rel="stylesheet" href="https://alchitry.com/override.css">

<link rel="icon" href="https://alchitry.com/favicon.svg" type="image/svg+xml">
<link rel="icon" type="image/png" sizes="16x16" href="https://alchitry.com/favicon_16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://alchitry.com/favicon_32.png">
<link rel="apple-touch-icon" href="https://alchitry.com/apple-touch-icon.png"><!-- 180×180 -->
<meta name="theme-color" content="#333333">


<link rel="alternate" type="application/atom+xml" title="RSS" href="https://alchitry.com/atom.xml">


<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }
    </style>
    
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
    
</noscript>



    
</head>
<body class=" dark" id="top">
    
    
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>
<link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>

<header class="header">

    <nav class="nav">
        <div class="logo">
            <a href="https:&#x2F;&#x2F;alchitry.com" accesskey="h" title="Alchitry (Alt + H)"><img src="https://alchitry.com/alchitry.svg"
                                                         alt="Alchitry"
                                                         aria-label="Alchitry">
            </a>
        </div>
        
        <div id="nav-search">
            <ul id="menu" class="desktop-nav">
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
                        <span>Boards</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
                        <span>News</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
                        <span>Tutorials</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
                        <span>Alchitry Labs</span>
                        
                    </a>
                </li>
                
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
                        <span>Forum</span>
                        
                    </a>
                </li>
                
            </ul>
            <div class="search-container">
                <input class="search" type="search" placeholder="Search" autocomplete="off">
                <span class="material-symbols-outlined search-icon">search</span>

                <div class="search-results">
                    <div class="search-results__items"></div>
                </div>
            </div>
        </div>
        <div id="overlayNavOpen">
            <span onclick="openNav()" class="material-symbols-outlined">menu</span>
        </div>
        
    </nav>
</header>


<div id="overlayNav" class="overlay">
    <div class="overlay-header">
        <div class="search-container">
            <input class="search" type="search" placeholder="Search" autocomplete="off">
            <span class="material-symbols-outlined search-icon">search</span>

            <div class="search-results">
                <div class="search-results__items"></div>
            </div>
        </div>
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    </div>

    <div class="overlay-content">
        
        
        
        <a href="https:&#x2F;&#x2F;shop.alchitry.com&#x2F;collections&#x2F;products" title="Boards">
            <span>Boards</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;news" title="News">
            <span>News</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials" title="Tutorials">
            <span>Tutorials</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;alchitry-labs" title="Alchitry Labs">
            <span>Alchitry Labs</span>
            
        </a>
        
        
        
        <a href="https:&#x2F;&#x2F;forum.alchitry.com" title="Forum">
            <span>Forum</span>
            
        </a>
        
    </div>
</div>

    
    <main class="main">
        
<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs">
            
            <div class="breadcrumb-container">
                <a class="breadcrumb-path" href="/">Home</a>
                
                
                
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;">Tutorials</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;">Archive</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;">Verilog</a>
                
                
                <span class="breadcrumb-separator">»</span>
                
                <a class="breadcrumb-path" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;">Mojo</a>
                
                <span class="breadcrumb-separator">»</span>
                <a class="breadcrumb-path active" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;writing-test-benches&#x2F;">Writing Test Benches</a>
            </div>
            
        </div>
        <h1 class="post-title">Writing Test Benches</h1>
        
        
        <div class="post-meta">
            













10 min&nbsp;·&nbsp;Justin Rajewski

            &nbsp;|&nbsp;&nbsp;<a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry&#x2F;alchitry.github.io&#x2F;tree&#x2F;master/content/tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;writing-test-benches.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

        </div>
        
    </header>

    
    

<div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner">
            <ul>
                
                <li>
                    <a href="#what-is-a-test-bench" aria-label="What is a Test Bench">What is a Test Bench</a>
                    
                </li>
                
                <li>
                    <a href="#running-a-test-bench" aria-label="Running a Test Bench">Running a Test Bench</a>
                    
                </li>
                
                <li>
                    <a href="#sequential-test-benches" aria-label="Sequential Test Benches">Sequential Test Benches</a>
                    
                </li>
                
            </ul>
        </div>
    </details>
</div>


    

    
    <div class="post-content">
        <p><strong>Test benches</strong> are used to simulate your design without the need of any physical hardware. The biggest benefit of this is that you can actually inspect every signal that is in your design. This definitely can be a time saver when your alternatives are staring at the code, or loading it onto the FPGA and probing the few signals brought out to the external pins. However, you don't get this all for free. Before you can simulate your design you must first write a <strong>test bench</strong>.</p>
<h3 id="what-is-a-test-bench">What is a Test Bench</h3>
<p>What exactly is a <strong>test bench</strong>? A test bench is actually just another Verilog file! However, the Verilog you write in a test bench is not quite the same as the Verilog you write in your designs. This is because all the Verilog you plan on using in your hardware design <strong>must be</strong> synthesizable, meaning it has a hardware equivalent. The Verilog you write in a test bench does not need to be synthesizable because you will only ever simulate it!</p>
<p>Let us assume we have a module called <strong>basic_and</strong> that looks like this.</p>
<pre data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><span style="font-weight:bold;color:#faac1f;">module</span><span> basic_and </span><span style="color:#ed4343;">#(</span><span style="color:#0a8dbf;">parameter</span><span> WIDTH </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">)(
</span><span>    </span><span style="color:#0a8dbf;">input </span><span style="color:#ed4343;">[</span><span>WIDTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> a</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input </span><span style="color:#ed4343;">[</span><span>WIDTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> b</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output </span><span style="color:#ed4343;">[</span><span>WIDTH</span><span style="color:#ed4343;">-</span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> out
</span><span>  </span><span style="color:#ed4343;">);
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">assign</span><span> out </span><span style="color:#ed4343;">=</span><span> a </span><span style="color:#ed4343;">&amp;</span><span> b</span><span style="color:#ed4343;">;
</span><span> 
</span><span style="font-weight:bold;color:#faac1f;">endmodule
</span></code></pre>
<p>The functionality of this module should be fairly apparent. It takes two inputs, <strong>a</strong> and <strong>b</strong>, of width <strong>WIDTH</strong> and <strong>ands</strong> them together for the output, <strong>out</strong>.</p>
<p>If we want to now test this module to make sure it is actually doing what we think it is, we can write a test bench! It is best practice to name the test bench associated with a module the same as the module with <strong>_tb</strong> appended. For example, the test bench for <strong>basic_and</strong> is named <strong>basic_and_tb</strong>. </p>
<p>Take a look at what a test bench for <strong>basic_and</strong> could look like.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>1</td><td><span style="font-weight:bold;color:#faac1f;">module</span><span> basic_and_tb</span><span style="color:#ed4343;">();
</span></td></tr><tr><td>2</td><td><span> 
</span></td></tr><tr><td>3</td><td><span>  </span><span style="color:#0a8dbf;">reg </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> a</span><span style="color:#ed4343;">,</span><span> b</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>4</td><td><span>  </span><span style="color:#0a8dbf;">wire </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">3</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> out</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>5</td><td><span> 
</span></td></tr><tr><td>6</td><td><span>  </span><span style="color:#fac863;">basic_and </span><span style="font-weight:bold;color:#0abfbf;">#</span><span style="color:#ed4343;">(</span><span>.WIDTH</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">))</span><span> DUT </span><span style="color:#ed4343;">(
</span></td></tr><tr><td>7</td><td><span>    .a</span><span style="color:#ed4343;">(</span><span>a</span><span style="color:#ed4343;">),
</span></td></tr><tr><td>8</td><td><span>    .b</span><span style="color:#ed4343;">(</span><span>b</span><span style="color:#ed4343;">),
</span></td></tr><tr><td>9</td><td><span>    .out</span><span style="color:#ed4343;">(</span><span>out</span><span style="color:#ed4343;">)
</span></td></tr><tr><td>10</td><td><span>  </span><span style="color:#ed4343;">);
</span></td></tr><tr><td>11</td><td><span> 
</span></td></tr><tr><td>12</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">initial begin
</span></td></tr><tr><td>13</td><td><span>    a </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b0000</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>14</td><td><span>    b </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b0000</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>15</td><td><span>    </span><span style="color:#c594c5;">#20
</span></td></tr><tr><td>16</td><td><span>    a </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b1111</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>17</td><td><span>    b </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b0101</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>18</td><td><span>    </span><span style="color:#c594c5;">#20
</span></td></tr><tr><td>19</td><td><span>    a </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b1100</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>20</td><td><span>    b </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b1111</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>21</td><td><span>    </span><span style="color:#c594c5;">#20
</span></td></tr><tr><td>22</td><td><span>    a </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b1100</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>23</td><td><span>    b </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b0011</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>24</td><td><span>    </span><span style="color:#c594c5;">#20
</span></td></tr><tr><td>25</td><td><span>    a </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b1100</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>26</td><td><span>    b </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">4&#39;b1010</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>27</td><td><span>    </span><span style="color:#c594c5;">#20
</span></td></tr><tr><td>28</td><td><span>    </span><span style="color:#1bddaf;">$finish</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>29</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span></td></tr><tr><td>30</td><td><span> 
</span></td></tr><tr><td>31</td><td><span style="font-weight:bold;color:#faac1f;">endmodule
</span></td></tr></tbody></table></code></pre>
<p>A test bench starts off with a module declaration, just like any other Verilog file you've seen before. However, it is important to notice the test bench module does not have any inputs or outputs. It is entirely self contained.</p>
<p>After we declare our variables, we instantiate the module we will be testing. In this case it's the <strong>basic_and</strong> module. Notice the name is <strong>DUT</strong>. DUT is a very common name for the module to be tested in a test bench and it stands for <strong>D</strong>evice <strong>U</strong>nder <strong>T</strong>est.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>12</td><td><span style="font-weight:bold;color:#0abfbf;">initial begin
</span></td></tr></tbody></table></code></pre>
<p>This line has something new, the <strong>initial</strong> block. The initial block is used similarly to an <strong>always</strong> block except that the code in the block will only run once, at the start of the simulation. Because there is no equivalent to an initial block in hardware, initial blocks are not synthesizable and can only be used in test benches.</p>
<p>Lines 13 and 14 simply assign values to <strong>a</strong>  and <strong>b</strong>.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>15</td><td><span style="color:#c594c5;">#20
</span></td></tr></tbody></table></code></pre>
<p>This is another new line. The <strong>#</strong> syntax is used to specify a <strong>delay</strong>. In this case this tells the simulator to wait 20 units of time. This is important because without these delays we would have no time to observe how <strong>a</strong> and <strong>b</strong> affect the circuit. Again, there is no hardware equivalent to a delay like this, so these statements are not synthesizable.</p>
<p>It is very important to understand that we are still simulating <strong>hardware</strong>. That means that the delay of 20 units only affects the block the delay is in. The rest of your design will keep chugging away as if there was no delay. This is important because it allows you to specify inputs and wait for the output to be generated. </p>
<p>Finally we get to the following line.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>28</td><td><span style="color:#1bddaf;">$finish</span><span style="color:#ed4343;">;
</span></td></tr></tbody></table></code></pre>
<p>This line tells the simulator we are done simulating.</p>
<h3 id="running-a-test-bench">Running a Test Bench</h3>
<p>As with all tutorials, we will start with the <a href="https://github.com/embmicro/mojo-base-project/archive/master.zip">Mojo Base Project</a>, so download a fresh copy now.</p>
<p>Open up the project in ISE and add the two source files, <strong>basic_and.v</strong> and <strong>basic_and_tb.v</strong>.</p>
<p>Your project should look something like this.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_files.png" alt="" /></p>
<p>If you created the files outside of ISE then <strong>basic_and_tb</strong> may not show up under the implementation tab. This is because ISE realizes that files that end in <strong>_tb</strong> are test benches and will mark them for use in simulation only. </p>
<p>If your test bench is showing up in the implementation tab, as shown above, <strong>right click</strong> on the test bench and choose <strong>Source Properties...</strong> </p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_sim.png" alt="test_bench_sim.png" /></p>
<p>Change the <strong>View Association</strong> to <strong>Simulation</strong>.</p>
<p>Back in ISE, click on the <strong>Simulation</strong> tab.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_sim_window.png" alt="test_bench_sim_window.png" /></p>
<p>Notice the <strong>Simulate Behavioral Model</strong> option now. This is how you launch the simulation. Make sure that <strong>basic_and_tb</strong> is selected and double click <strong>Simulate Behavioral Model</strong>.</p>
<p>That will launch <strong>ISim</strong>.</p>
<p>It will show your test bench code and show where it hit <strong>$finish;</strong>. Go ahead and click on the tab that says <strong>Default.wcfg</strong>.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_isim.resized.png" alt="test_bench_isim.resized.png" /></p>
<p>Click the magnifying glass that looks like it has an X in it. That will fit the simulation to the display. You should then see the following.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_results.png" alt="test_bench_results.png" /></p>
<p>Notice how <strong>a</strong> and <strong>b</strong> change. Their values match the ones in our test bench and you can see that they change every 20 time units (ns in this case).</p>
<p>The power of the test bench is now you can look at <strong>out</strong>. If you compare <strong>out</strong> with the corresponding <strong>a</strong> and <strong>b</strong> inputs, you will notice that the module is in fact <strong>anding</strong> <strong>a</strong> and <strong>b</strong> together (1111 <strong>and</strong> 0101 = 0101!).</p>
<h3 id="sequential-test-benches">Sequential Test Benches</h3>
<p>The previous example is a great way to get you feet wet with test benches, but the circuit we tested didn't have any sequential logic in it. How do you go about testing a circuit that requires a clock signal?</p>
<p>To show to do this, we will be testing the pwm module from the <a href="https://alchitry.com/tutorials/archive/verilog/mojo/pulse-width-modulation/">pulse-width modulation tutorial</a>. </p>
<pre data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="short language-verilog" data-lang="verilog"><span style="font-weight:bold;color:#faac1f;">module</span><span> pwm </span><span style="color:#ed4343;">#(</span><span style="color:#0a8dbf;">parameter</span><span> CTR_LEN </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">) (
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> clk</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input</span><span> rst</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">input </span><span style="color:#ed4343;">[</span><span>CTR_LEN </span><span style="color:#ed4343;">- </span><span style="color:#a269dc;">1 </span><span style="color:#ed4343;">: </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> compare</span><span style="color:#ed4343;">,
</span><span>    </span><span style="color:#0a8dbf;">output</span><span> pwm
</span><span>  </span><span style="color:#ed4343;">);
</span><span> 
</span><span>  </span><span style="color:#0a8dbf;">reg</span><span> pwm_d</span><span style="color:#ed4343;">,</span><span> pwm_q</span><span style="color:#ed4343;">;
</span><span>  </span><span style="color:#0a8dbf;">reg </span><span style="color:#ed4343;">[</span><span>CTR_LEN </span><span style="color:#ed4343;">- </span><span style="color:#a269dc;">1</span><span style="color:#ed4343;">: </span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> ctr_d</span><span style="color:#ed4343;">,</span><span> ctr_q</span><span style="color:#ed4343;">;
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">assign</span><span> pwm </span><span style="color:#ed4343;">=</span><span> pwm_q</span><span style="color:#ed4343;">;
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">@(*) </span><span style="font-weight:bold;color:#0abfbf;">begin
</span><span>    ctr_d </span><span style="color:#ed4343;">=</span><span> ctr_q </span><span style="color:#ed4343;">+ </span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">;
</span><span> 
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>compare </span><span style="color:#ed4343;">&gt;</span><span> ctr_q</span><span style="color:#ed4343;">)
</span><span>    pwm_d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">;
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">else
</span><span>    pwm_d </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">;
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span><span> 
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">always </span><span style="color:#ed4343;">@(</span><span style="font-weight:bold;color:#0abfbf;">posedge</span><span> clk</span><span style="color:#ed4343;">) </span><span style="font-weight:bold;color:#0abfbf;">begin
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">if </span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">) </span><span style="font-weight:bold;color:#0abfbf;">begin
</span><span>      ctr_q </span><span style="color:#ed4343;">&lt;= </span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">;
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">end else begin
</span><span>      ctr_q </span><span style="color:#ed4343;">&lt;=</span><span> ctr_d</span><span style="color:#ed4343;">;
</span><span>    </span><span style="font-weight:bold;color:#0abfbf;">end
</span><span> 
</span><span>    pwm_q </span><span style="color:#ed4343;">&lt;=</span><span> pwm_d</span><span style="color:#ed4343;">;
</span><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span><span> 
</span><span style="font-weight:bold;color:#faac1f;">endmodule
</span></code></pre>
<p>To test this we again will need to write a test bench. An example of what that test bench could look like is shown below.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>1</td><td><span style="font-weight:bold;color:#faac1f;">module</span><span> pwm_tb </span><span style="color:#ed4343;">();
</span></td></tr><tr><td>2</td><td><span> 
</span></td></tr><tr><td>3</td><td><span>  </span><span style="color:#0a8dbf;">reg</span><span> clk</span><span style="color:#ed4343;">,</span><span> rst</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>4</td><td><span>  </span><span style="color:#0a8dbf;">reg </span><span style="color:#ed4343;">[</span><span style="color:#a269dc;">7</span><span style="color:#ed4343;">:</span><span style="color:#a269dc;">0</span><span style="color:#ed4343;">]</span><span> compare</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>5</td><td><span>  </span><span style="color:#0a8dbf;">wire</span><span> pwm</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>6</td><td><span> 
</span></td></tr><tr><td>7</td><td><span>  </span><span style="color:#fac863;">pwm </span><span style="font-weight:bold;color:#0abfbf;">#</span><span style="color:#ed4343;">(</span><span>.CTR_LEN</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">8</span><span style="color:#ed4343;">))</span><span> DUT </span><span style="color:#ed4343;">(
</span></td></tr><tr><td>8</td><td><span>    .clk</span><span style="color:#ed4343;">(</span><span>clk</span><span style="color:#ed4343;">),
</span></td></tr><tr><td>9</td><td><span>    .rst</span><span style="color:#ed4343;">(</span><span>rst</span><span style="color:#ed4343;">),
</span></td></tr><tr><td>10</td><td><span>    .compare</span><span style="color:#ed4343;">(</span><span>compare</span><span style="color:#ed4343;">),
</span></td></tr><tr><td>11</td><td><span>    .pwm</span><span style="color:#ed4343;">(</span><span>pwm</span><span style="color:#ed4343;">)
</span></td></tr><tr><td>12</td><td><span>  </span><span style="color:#ed4343;">);
</span></td></tr><tr><td>13</td><td><span> 
</span></td></tr><tr><td>14</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">initial begin
</span></td></tr><tr><td>15</td><td><span>    clk </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>16</td><td><span>    rst </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>17</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">) </span><span style="color:#c594c5;">#10</span><span> clk </span><span style="color:#ed4343;">= ~</span><span>clk</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>18</td><td><span>    rst </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>19</td><td><span>    </span><span style="color:#fac863;">forever </span><span style="font-weight:bold;color:#0abfbf;">#</span><span style="color:#a269dc;">10</span><span> clk </span><span style="color:#ed4343;">= ~</span><span>clk</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// generate a clock
</span></td></tr><tr><td>20</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span></td></tr><tr><td>21</td><td><span> 
</span></td></tr><tr><td>22</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">initial begin
</span></td></tr><tr><td>23</td><td><span>    compare </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8&#39;d0</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// initial value
</span></td></tr><tr><td>24</td><td><span>    </span><span style="color:#ed4343;">@(</span><span style="font-weight:bold;color:#0abfbf;">negedge</span><span> rst</span><span style="color:#ed4343;">); </span><span style="color:#969696;">// wait for reset
</span></td></tr><tr><td>25</td><td><span>    compare </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8&#39;d128</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>26</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">256</span><span style="color:#ed4343;">) @(</span><span style="font-weight:bold;color:#0abfbf;">posedge</span><span> clk</span><span style="color:#ed4343;">);
</span></td></tr><tr><td>27</td><td><span>    compare </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8&#39;d30</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>28</td><td><span>    </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">256</span><span style="color:#ed4343;">) @(</span><span style="font-weight:bold;color:#0abfbf;">posedge</span><span> clk</span><span style="color:#ed4343;">);
</span></td></tr><tr><td>29</td><td><span>    </span><span style="color:#1bddaf;">$finish</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>30</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">end
</span></td></tr><tr><td>31</td><td><span> 
</span></td></tr><tr><td>32</td><td><span style="font-weight:bold;color:#faac1f;">endmodule
</span></td></tr></tbody></table></code></pre>
<p>Again notice there are no inputs or outputs of our test bench.</p>
<p>In this test bench we have to have two initial blocks.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>14</td><td><span style="font-weight:bold;color:#0abfbf;">initial begin
</span></td></tr><tr><td>15</td><td><span>  clk </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>16</td><td><span>  rst </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b1</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>17</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">) </span><span style="color:#c594c5;">#10</span><span> clk </span><span style="color:#ed4343;">= ~</span><span>clk</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>18</td><td><span>  rst </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">1&#39;b0</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>19</td><td><span>  </span><span style="color:#fac863;">forever </span><span style="font-weight:bold;color:#0abfbf;">#</span><span style="color:#a269dc;">10</span><span> clk </span><span style="color:#ed4343;">= ~</span><span>clk</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// generate a clock
</span></td></tr><tr><td>20</td><td><span style="font-weight:bold;color:#0abfbf;">end
</span></td></tr></tbody></table></code></pre>
<p>This first block generates the clock and reset signals. You will use basically this exact same initial block for any test bench that is testing a sequential circuit. </p>
<p>The <strong>clk</strong> and <strong>rst</strong> signals are initialized to 0 and 1 respectively. </p>
<p>The next line uses the <strong>repeat</strong> statement.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>17</td><td><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">4</span><span style="color:#ed4343;">) </span><span style="color:#c594c5;">#10</span><span> clk </span><span style="color:#ed4343;">= ~</span><span>clk</span><span style="color:#ed4343;">;
</span></td></tr></tbody></table></code></pre>
<p>This is used to toggle the clock four times with 10 units of time between each toggle.</p>
<p>After the clock is toggled a bit, <strong>rst</strong> is brought low to allow the circuit to resume normal operation. </p>
<p>It is very important to always reset your circuit before expecting any meaningful output. Flip-flops do not have a default value and will output <strong>x</strong> in simulations when they are not reset properly.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>19</td><td><span style="color:#fac863;">forever </span><span style="font-weight:bold;color:#0abfbf;">#</span><span style="color:#a269dc;">10</span><span> clk </span><span style="color:#ed4343;">= ~</span><span>clk</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// generate a clock
</span></td></tr></tbody></table></code></pre>
<p>The last line of this initial block will generate a clock signal forever! The <strong>forever</strong> keyword is used to create a loop that lasts, you guessed it, forever.</p>
<p>The second initial block is where we do the actual testing.</p>
<pre data-linenos data-lang="verilog" style="background-color:#282828;color:#ffffff;" class="language-verilog "><code class ="language-verilog" data-lang="verilog"><table><tbody><tr><td>22</td><td><span style="font-weight:bold;color:#0abfbf;">initial begin
</span></td></tr><tr><td>23</td><td><span>  compare </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8&#39;d0</span><span style="color:#ed4343;">; </span><span style="color:#969696;">// initial value
</span></td></tr><tr><td>24</td><td><span>  </span><span style="color:#ed4343;">@(</span><span style="font-weight:bold;color:#0abfbf;">negedge</span><span> rst</span><span style="color:#ed4343;">); </span><span style="color:#969696;">// wait for reset
</span></td></tr><tr><td>25</td><td><span>  compare </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8&#39;d128</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>26</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">256</span><span style="color:#ed4343;">) @(</span><span style="font-weight:bold;color:#0abfbf;">posedge</span><span> clk</span><span style="color:#ed4343;">);
</span></td></tr><tr><td>27</td><td><span>  compare </span><span style="color:#ed4343;">= </span><span style="color:#a269dc;">8&#39;d30</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>28</td><td><span>  </span><span style="font-weight:bold;color:#0abfbf;">repeat</span><span style="color:#ed4343;">(</span><span style="color:#a269dc;">256</span><span style="color:#ed4343;">) @(</span><span style="font-weight:bold;color:#0abfbf;">posedge</span><span> clk</span><span style="color:#ed4343;">);
</span></td></tr><tr><td>29</td><td><span>  </span><span style="color:#1bddaf;">$finish</span><span style="color:#ed4343;">;
</span></td></tr><tr><td>30</td><td><span style="font-weight:bold;color:#0abfbf;">end
</span></td></tr></tbody></table></code></pre>
<p>The first part of this block waits for <strong>rst</strong> to fall. This is accomplished with the <strong>@(negedge signal)</strong>; syntax. You can use <strong>negedge</strong> or <strong>posedge</strong> to make your initial block wait for the corresponding edge of that signal.</p>
<p>The signal <strong>compare</strong> is then set to 128 to make sure we get a 50% duty cycle from the <strong>pwm</strong> module. Since each cycle of the module takes 256 clock cycles (because we set <strong>CTR_LEN</strong> = 8), we need to wait for 256 positive edges of the clock.</p>
<p>After we wait long enough we can change <strong>compare</strong> to a new value to test the <strong>pwm</strong> module under a different case.</p>
<p>In this example we are only testing two cases, but in most test benches you should try more, especially the edge cases.</p>
<p>If you now add these two files to your project and run the simulation you should see the following.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_sync_new.png" alt="test_bench_sync_new.png" /></p>
<p>Now you may notice that the simulation stopped after 1us. This is the default value in ISim. To change it set the new value in the toolbar like this.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_toolbar.png" alt="test_bench_toolbar.png" /></p>
<p>Set it to 100us just to be safe. Since we have the <strong>$finish;</strong> statement in our test bench it doesn't hurt to set it longer than we need because it will end when it hits that line.</p>
<p>If you now click the arrow with the hour glass it will run the rest of the simulation. </p>
<p>Before looking at the signal we should show the <strong>ctr_q</strong> signal from the <strong>pwm</strong> module. To do this take a look af the signals shown on the left of the display.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_addsig.png" alt="test_bench_addsig.png" /></p>
<p>Expand the pwm_tb and select DUT. You can then right click <strong>ctr_q[7:0]</strong> and click <strong>Add to Wave Window</strong>.</p>
<p>To get the waveform updated you need to click the icon in the toolbar that is a blue box with a white arrow pointing to the left (left most icon shown two pictures above). This will rerun the simulation from the beginning.</p>
<p><img src="https://cdn.alchitry.com/verilog/mojo/test_bench_final.png" alt="test_bench_final.png" /></p>
<p>Here is what the final simulation should look like. You can see the pulses are exactly as we expected them to be. If you zoom in to any point you will be able to see the value of <strong>ctr_q</strong> and the rising and falling edges of <strong>clk</strong>.</p>
<p>Hopefully this gives you a good starting point for writing your own test benches. Test benches are incredibly important for verifying that your modules are written correctly and everything is working as it should.</p>

    </div>
    

    <footer class="post-footer">
        

        
        



<nav class="paginav">
    
        
        <a class="prev" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;pulse-width-modulation&#x2F;">
            <span class="title">« Prev</span>
            <br>
            <span>Pulse Width Modulation</span>
        </a>
        
        
        <a class="next" href="https:&#x2F;&#x2F;alchitry.com&#x2F;tutorials&#x2F;archive&#x2F;verilog&#x2F;mojo&#x2F;external-io&#x2F;">
            <span class="title">Next »</span>
            <br>
            <span>External IO</span>
        </a>
        
    
</nav>


        
        
    </footer>

</article>

    </main>
    
    <footer class="footer">
    <div>
        <div class="social-icons">
    
    <a href="https:&#x2F;&#x2F;github.com&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="GitHub">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;c&#x2F;alchitry" target="_blank" rel="noopener noreferrer me" title="YouTube">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z">
    </path>
    <polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon>
</svg>


    </a>
    
    <a href="https:&#x2F;&#x2F;alchitry.com&#x2F;atom.xml" target="_blank" rel="noopener noreferrer me" title="RSS">
        

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>


    </a>
    
</div>

        <span>&copy; 2026 <a href="https:&#x2F;&#x2F;alchitry.com">Alchitry</a></span>
    </div>
</footer>


<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"><path d="M440-320h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168Zm40 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
</a>


<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>


<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>


<script>
    /* Open */
    function openNav() {
        document.getElementById("overlayNav").style.display = "block";
    }

    /* Close */
    function closeNav() {
        document.getElementById("overlayNav").style.display = "none";
    }
</script>



<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            let codeText = '';

            // 1. Check if the codeblock contains a table (Line Numbers present)
            const tableRows = codeblock.querySelectorAll('table tr');

            if (tableRows.length > 0) {
                const lines = [];
                tableRows.forEach(row => {
                    // The actual code is in the last TD
                    const codeCell = row.lastElementChild;
                    if (codeCell) {
                        let cellText = codeCell.textContent;

                        if (cellText.endsWith('\n')) {
                            cellText = cellText.slice(0, -1);
                        }

                        lines.push(cellText);
                    }
                });
                codeText = lines.join('\n');
            } else {
                // 2. No table, use standard text extraction
                codeText = codeblock.textContent;
            }

            // 3. Copy the cleaned text to clipboard
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeText);
                copyingDone();
                return;
            }

            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = codeText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
                console.error('Copy failed', e);
            }
            document.body.removeChild(textArea);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>

<script type="text/javascript" src="https://alchitry.com/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://alchitry.com/search.js"></script>
<script type="module" src="https://alchitry.com/table-toggles.js"></script>
    
</body>
</html>
